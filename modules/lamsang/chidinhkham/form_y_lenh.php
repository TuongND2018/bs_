<html>
<style>
body{
	font-family:Arial, Helvetica, sans-serif;
}
.bottom_left{
	width:94.7%;
	float:left;
}
.bottom_right{
	float:left;
}
input[type="checkbox"]:focus {
	-webkit-box-shadow: 0px 0px 1px 1px #0463B4!important;
	box-shadow:  0px 0px 2px 2px #208AC8 !important;
}
.ylenh_top,.ylenh_bottom,.ylenh_bottom_new{
	border:1px solid #CCCCCC;
	border-radius:4px;
	margin-left:10px;
	margin-right:10px;
	
}
.ylenh_top{
	height:65px;
	padding-left:3px;
	padding-top:2px;
	padding-bottom:2px;
}
.ylenh_bottom_new{
	padding-left:5px;
	padding-top:3px;
	height:25px;
}
.ylenh_bottom{
	height:42px;
	margin-top:5px;
}

.ylenh_bottom2{
	height:40px;
	border:1px solid #ccc;
	border-radius:4px;
	margin-left:10px;
	margin-right:10px;
	margin-top:5px;
}
.textarea_1{
	margin-left:2px;
	width:99%;
	height:55px;
	border-radius:4px;
}
.textarea_ylenhkhac{
	margin-left:2px;
	height:32px;
	width:99%;
	border-radius:4px;
}
.textarea_2{
	margin-left:2px;
	width:99%;
	height:63px;
	border-radius:4px;
}
.ylenh_top_left{
	width:420px;
	float:left;
}
.ylenh_top_right{
	width:800px;
	float:left;
}
.ylenh_bottom2_left{
	width:93%;
	border-right: 1px solid #ccc;
	float:left;
}
.ylenh_bottom2_right{
	width:5.5%;
	float:left;
}
#todieutri_luu{
	width:60px;
	height:50px;
	margin-left:0px;
	margin-top:6px;
	font-size:14px;
}
#combo_chamsoc,#combo_lydotodieutri,#combo_dv_chamsoc{
	width:130px;
}
.ui-tabs .ui-tabs-panel{
	padding:0px !important;
}
#add_new:hover,#add_new2:hover{
	background:#008DDF;
}

/* can lam sang*/

/*Nháy row 
 	#jqg1 td.loai_kham,#jqg2 td.loai_kham,#jqg3 td.loai_kham,#jqg4 td.loai_kham,#jqg5 td.loai_kham,#jqg6 td.loai_kham,#jqg7 td.loai_kham,#jqg8 td.loai_kham,#jqg9 td.loai_kham,#jqg10 td.loai_kham,#jqg11 td.loai_kham,#jqg12 td.loai_kham,#jqg13 td.loai_kham,#jqg14 td.loai_kham,#jqg15 td.loai_kham,#jqg16 td.loai_kham,  #jqg17 td.loai_kham,#jqg18 td.loai_kham,#jqg19 td.loai_kham,#jqg20 td.loai_kham,#jqg21 td.loai_kham,#jqg22 td.loai_kham,#jqg23 td.loai_kham,#jqg24 td.loai_kham{
		 animation: blink 1s steps(5, start) infinite;			  
	 }
	 @keyframes blink{
		to {
			visibility: hidden;
		}
	 }
Kết thúc Nháy row */
.frame_u78787878975f{
	width:300px!important;
	text-align:center!important;
	height:auto;
	}
.frame_u78787878975f2{
	width:300px!important;
	text-align:center!important;
	height:auto;
	}
th.ui-th-column div{
        word-wrap: break-word; /* IE 5.5+ and CSS3 */
        white-space: pre-wrap; /* CSS3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        overflow: hidden;
        height: auto !important;
        vertical-align: middle;
    }
    #rowed3 td,#rowed4 td,#rowed5 td{

        font-size:11px!important;	   
    }

    .ui-menu { 
        width: 150px;
        display:none;
        position:absolute;  	 
        box-shadow:0px 0px 3px #333;
        z-index:100000;  
    }
    .grid1
    {
        width:180px;
        display:inline-block;
    }
    #menu_toggle{
        font-size:12px;
        padding:5px 0px;
        background:url("js/grid/themes/south-street/images/ui-bg_highlight-hard_15_459e00_1x100.png") repeat-x scroll   #459E00;
        border:#CCC 1px dashed;	
    }
    #gbox_rowed3, #gbox_rowed4, #gbox_rowed5, #gbox_rowed6, #gbox_rowed7{
        margin-left:4px;
        margin-top:5px;
        box-shadow:0px 0px 10px #a0a0a0;
        border:1px solid #919191; 
    }#n_menu{
		border-radius: 6px 6px 6px 6px;
		border: 1px solid #d4ccb0;
		height:40px;
		margin: 5px;
	}#n_bt{
		border-radius: 6px 6px 6px 6px;
		border: 1px solid #d4ccb0;
		height:30px;
		margin: 3px;
		display:none;			
		}
	#n_menu_left{
		margin:10px;
		}
	#chongoikham{
	margin-top: -28px;
	vertical-align: top;
	width: 100px;
	height: 15px;
	float: right;
	margin-right: 10px;	
}#hentrakq{
	float: left;
	margin-left: 4%;
	margin-top: -2px;
	
}#bt_left{
	float: left;
	min-width: 450px;
	margin-top: 6px;	
}#bt_right{
	float: left;
	margin-top: -2px;
	width: 800px;	
}
#n_top{
	border-radius: 6px 6px 6px 6px;
	border: 1px solid #d4ccb0;
	height:65px;
	margin: 5px 0px -5px 0px;
	background:#FBFBF5;
}
#n_top_right{
	float: right;
	margin-top: -30px;
	margin-right: 10px;
	}
input.custom_button_n[type="button"],input.dtph_custom_button_n[type="button"] {
    background: none repeat scroll 0 0 rgba(0, 0, 0, 0);
    border: medium none;
    font-size: 11px;
    height: 17px !important;
    outline: medium none;
    text-decoration: underline;
    text-shadow: 0 1px 0 rgba(255, 255, 255, 0.6);
    width: 50px !important;
	color:#00F;
	margin-left:-2px!important;
	width: 35px !important
}input.custom_button_n[type="button"]:hover,input.dtph_custom_button_n[type="button"]:hover{
	color:red;
	margin-left:-2px!important;
	width: 35px !important
	}
select.editable{
	width:70px!important;
	height: 20px!important;
	 padding:0px!important; 
}.colNhomThucHien select.editable{
	width:105px!important;
	height: 20px!important;
	padding:0px!important; 
}
#tongtien,#tongtien2,#dtph_tongtien,#dtph_tongtien2{
	margin-left:284px;
	margin-top:4px;
}#n_top_right{
	display:none;
	}#botton_cddatra,#botton_cdmoi{
		width: 2%;
}#thanhtienvienphi,#thanhtienbhyt,#phithuchien,#dtph_tongtien,#dtph_tongtien2,#dtph_thanhtien,#dtph_phithuchien{
	box-shadow:none!important;	
	padding: 0px!important;
	text-align:right;
	}
.no-close .ui-dialog-titlebar-close {
    display: none;
}.ui-state-hover{
	border:#F00;
}.profile_inner_rate{
	width: 110px!important; 
}.profile_inner_temp{
	width: 99px!important;
}.ui-button-text{
	padding:0em  !important;
}.ui-dialog .ui-dialog-buttonpane button {
	width:40px;
	height:30px;
}.data_chongoikham{
	width:1306px!important;
	height:346px !important;
}
.ui-dialog-buttonset button.ui-button{
 width: 60px!important;
}
/* end can lam sang*/
#gbox_dtph_rowed3,#gbox_dtph_rowed4,#gbox_dtph_rowed5 {
    border: 1px solid #919191;
    box-shadow: 0 0 10px #A0A0A0;
    margin-left: 4px;
    margin-top: 5px;
}
#donthuoc_rowed3 select.editable,
#vattutieuhao_rowed3 select.editable,
#donthuocchove_rowed3 select.editable{
	width:135px !important;
}
#tabs-3,#tabs-4,#tabs-5,#tabs-6{
	padding-top:10px !important;
}
fieldset{
	padding:0px !important;
	margin-left:10px;
	border-radius:4px;
	border:1px solid #CCCCCC;
}
#tenbn{
	min-width:200px;
}
#sogiuong,#sobuong{
	min-width:40px;
}
#doituongt{
	min-width:103px;
}
.cachdungchitiet .editable {
	width:98% !important;
}
#bschophepthuchien{
	width:70px !important;
}
#toamau,#toamau2{
	width:250px;
}
</style>
<body class="ylenhbody">
<div class="ylenh_top" style="display:block">
	<div class="ylenh_top_left">
	 <div class="profile_container">
			<span class="addon" href="#">
			<i class="fa fa-user icon"></i>
			</span>
			<span id="tenbn" class="texts" style=" text-align: left;"></span>
			</div>
        <!-- Tuổi -->
         <div class="profile_container">
             <span  href="#" class="addon">
              <i class="icon  fa" ></i><span>Tuổi</span>          
            </span>
            <span class="texts" id="tuoi">&nbsp;</span>
        </div>
        <!-- gioi tinh-->
         <div class="profile_container">
             <span  href="#" class="addon">
              <i class="fa fa-female icon"></i>
			  <i class="fa fa-male icon"></i>       
            </span>
            <span class="texts" id="gtinh">&nbsp;</span>
        </div><br>
        <!-- Đối tượng-->
        <div class="profile_container">
             <span href="#" class="addon">
                <i class="fa  icon" ></i><span>Đ.Tượng</span>
            </span>
            <span  class="texts" id="doituongt"></span>
          </div>
        <!-- số giường-->
        <div class="profile_container">
             <span  href="#" class="addon">
              <i class="icon  fa" ></i><span>S.Giường</span>          
            </span>
            <span class="texts" id="sogiuong"></span>
        </div>
        <!-- số buồng -->  
        <div class="profile_container">
             <span  href="#" class="addon">
              <i class="icon  fa" ></i><span>S.Buồng</span>          
            </span>
            <span class="texts" id="sobuong">&nbsp;</span>
        </div>
     </div>
     <div class="ylenh_top_right">
      <textarea id="dienbienbenh" class="textarea_1" placeholder="Diễn biến bệnh"></textarea>
     </div>
        
</div><!-- end top -->
<div id="tabs" style="margin-left:10px; margin-right:10px; height:310px; width:100%;">
	<ul style="margin-left:5px; border-bottom:1px solid #CCC">
        <li><a href="#tabs-1">Cận lâm sàng</a></li> 
        <li><a href="#tabs-2" onClick="dtph_create_layout()">Điều trị phối hợp</a></li> 
        <li><a href="#tabs-3" onClick="reloadtab3(3)">Đơn thuốc</a></li>
        <li><a href="#tabs-5" onClick="reloadtab3(5)">Vật tư tiêu hao</a></li> 
        <li><a href="#tabs-6" onClick="reloadtab3(6)" style="display:none">Đơn thuốc cho về</a></li>     
        <li><a href="#tabs-4" onClick="reloadtab3(4)">Đơn thuốc trả lại</a></li>      
	</ul>
    <div id="tabs-1"> 
        <input type="hidden" id="mabenhnhan" value="" />
        <input type="hidden" id="soluotchon" value="0" />
        <div id="dialog_confirm_cls_huybo" title="Thông báo"  style="display:none">
        	Bạn muốn xóa chỉ định này?
          <input type="hidden" id="idk" value="" />
        </div>
        <div id="dialog_loi" title="Thông báo"  style="display:none">
        	Vui lòng chọn một lượt khám để thực hiện chức năng này!!!
        </div>
        <div id="dialog_loi2" title="Thông báo"  style="display:none">
        	Vui lòng cấu hình tầng trước khi thực hiện chức năng này!!!
        </div>
         <div  class="data_chongoikham" title="Chọn gói khám">
            <table id="data_goikham"></table>   
            <br />
            <table id="data_loaikham"></table>   
          </div>
            <div id="panel_main" style="margin-top:10px;" >  
				<div class="ui-layout-west ui-widget-content left_col">   <table id="rowed3" ></table></div>
                <div class="center_col ui-widget-content ui-layout-center">  <table id="rowed4" ></table> </div>
                <div class="ui-layout-east ui-widget-content right_col">
                <table id="rowed5" ></table> 
                <div id="prowed5"><div id="tongtien">Tổng tiền: <span id="tien">
					<input id="thanhtienvienphi" class="disable" type="text" value="0" readonly disabled style="width:58px;background:#4CA109;border:1px solid #327E04; color: #FFFFFF;font-weight: bold;"   /> 
					<input id="thanhtienbhyt" class="disable" type="text" value="0" readonly disabled style="width:58px;background:#4CA109;border:1px solid #327E04; color: #FFFFFF;font-weight: bold;" />
					<input id="phithuchien" class="disable" type="text" value="0" readonly disabled style="width:58px;background:#4CA109;border:1px solid #327E04; color: #FFFFFF;font-weight: bold;" />
                </span></div></div> 
                
                <div id='n_bt'> </div>
                </div>
                
            </div>
    </div><!-- End tabs1 -->
    <div id="tabs-2"> 
    	<input type="hidden" id="dialog_report" name="dialog_report" value="">
		<input type="hidden" id="xemtruockhiin" name="xemtruockhiin" value="1">

        <div id="dialog_confirm_dtph_huybo" title="Thông báo"  style="display:none">
        	Bạn muốn xóa chỉ định này?
          <input type="hidden" id="dtph_idk" value="" />
        </div>
  
        <div id="dialog_loi" title="Thông báo" style="display:none">
        	Vui lòng chọn một lượt khám để thực hiện chức năng này!!!
        </div>
         <input type="hidden" id="idluotkham" value="<?php if(isset($_GET['idluotkham'])){ echo $_GET['idluotkham'];} ?>" /> 
        <input type="hidden" id="idphongbanchuyenmon"  value="1" />
        <input type="hidden" id="hotenbenhnhan"  value="" />
        
   	 <div id="panel_main_tab2" style="margin-top:10px;" >  
        <div class="ui-layout-west ui-widget-content dtph_left_col">   <table id="dtph_rowed3" ></table></div>
        <div class="ui-widget-content ui-layout-center dtph_center_col">  <table id="dtph_rowed4" ></table> </div>
        <div class="ui-layout-east ui-widget-content dtph_right_col">
        <table id="dtph_rowed5" ></table> 
        <div id="pdtph_rowed5" style="display:block"><div id="tongtien2">Tổng tiền: <span id="tien"><input id="dtph_thanhtien" class="disable" type="text" value="0" readonly disabled style="width:70px;background:#4CA109;border:1px solid #327E04; color: #FFFFFF;font-weight: bold;  margin-left: 0px; text-align:right"   /> <input id="dtph_phithuchien" class="disable" type="text" value="0" readonly disabled style="width:70px;background:#4CA109;border:1px solid #327E04; color: #FFFFFF;font-weight: bold; margin-left: 64px; text-align:right" /></span></div></div> 
        </div>
    </div>
    </div><!-- End tabs2 -->
    <div id="tabs-3">
    	 <div style="display:none">
        	<table id="thuocmau" ></table>
        </div>
    	<div id="dialog-thuoctrong" title="Thông báo!" style="display:none">
          <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Vui lòng chọn thuốc</p>
        </div>
        <div id="dialog-thuoctralaitrong" title="Thông báo!" style="display:none">
          <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Vui lòng chọn thuốc</p>
        </div>
        <div id="dialog-soluongxuat" title="Thông báo!" style="display:none">
          <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Số thuốc phải lớn hơn 0</p>
        </div>
        <div id="dialog-soluongtralai" title="Thông báo!" style="display:none">
          <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Số thuốc phải lớn hơn 0</p>
        </div>
        <div id="dialog-thuoctralaidaco" title="Thông báo!" style="display:none">
          <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Thuốc này đã được trả lại trước đó</p>
        </div>
        <div id="dialog-thuocdake" title="Thông báo!" style="display:none">
          <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Thuốc này đã kê</p>
        </div>
        <div id="dialog-thuochuacogiaban" title="Thông báo" style="display:none">
          <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Thuốc <span id="_tenthuoc" style="font-weight:bold"></span> chưa có giá bán. Bạn có muốn kê không?</p>
        </div>
        
    	 <table id="donthuoc_rowed3" ></table>
         <div id="prowed6" ></div>
    </div><!-- End tabs3 -->
    <div id="tabs-4"> 
     	<table id="tralaithuoc_rowed3" ></table>
         <div id="ptralaithuoc_rowed3" ></div>
    </div><!-- End tabs4 -->
     <div id="tabs-5"> 
    	 <div style="display:none">
        	<table id="thuocmau2" ></table>
        </div>
     	<table id="vattutieuhao_rowed3" ></table>
         <div id="pvattutieuhao_rowed3" ></div>
    </div><!-- End tabs5 -->
    <div id="tabs-6"> 
    	<div class="chove_trai" style="float:left">
            <table id="donthuocchove_rowed3" ></table>
            <div id="pdonthuocchove_rowed3" ></div>
        </div>
        <div class="chove_phai" style="float:left;margin-left:10px; border: 1px solid #dfd9c3;border-radius:4px">
        	<div class="chove_tren" style="width:96%; height:25px; border-bottom: 1px solid #dfd9c3; padding-left:10px; background:#FBFAF5">
           	<strong> Dặn dò </strong>
            </div>
            <div class="chove_duoi" style="width:100%;">
        	<textarea id="chove_dando" style="height:100%; width:97%"  placeholder="Lời dặn dò của bác sỹ"> </textarea>
             </div>
        </div>
     	
    </div><!-- End tabs4 -->
</div><!-- end tabs-->
 <div class="ylenh_bottom_new">
         <label for="combo_dv_chamsoc" > Dịch vụ chăm sóc: </label><input type="text" id="combo_dv_chamsoc" name="combo_dv_chamsoc" />
          <input type="checkbox" id="apdung" checked style="margin-left:35px;" /> <label for="apdung" >Cho phép thực hiện</label>
        <label style="margin-left:15px;" for="combo_lydotodieutri" > Lý do cho phép thực hiện:</label> <input type="text" id="combo_lydotodieutri" name="combo_lydotodieutri" />
          <label  style="margin-left:35px;"  for="bschophepthuchien" >BS cho phép thực hiện: </label><input type="text" id="bschophepthuchien">
        <label style="margin-left:35px;"  for="combo_chamsoc" > Chỉ định chăm sóc: </label> <input type="text" id="combo_chamsoc" name="combo_chamsoc" />
      
</div>
<div class="n_bottom">
    <div class="bottom_left">
      <fieldset style="margin-right:10px;">
    	<legend>Y lệnh khác</legend>
        	<textarea id="ylenhkhac" class="textarea_ylenhkhac"></textarea>
    </fieldset>
    </div>
    <div class="bottom_right">
   	 <input type="button" value="Lưu" id="todieutri_luu"/> 
    </div>
</div>
</body>
</html>
<script type="text/javascript">
    jQuery(document).ready(function() {
		window.dangluu=0;
		$.dateEntry.setDefaults({spinnerImage: ''});
		window.donthuocxoa='';
		window.donthuochove='';
		window.vattutieuhaoxoa='';
		jwerty.key('tab', false);
		jwerty.key('shift+tab', false);			  
		jwerty.key('shift+enter', false);
		window.load3=0;
		window.load4=0;
		window.load5=0;
		window.load6=0;
		window.soluongtralaitrong=0;

		<?php
		if($_GET['idtodieutrichitiet']!=''){
			echo 'window.idtodieutrichitiet='.$_GET['idtodieutrichitiet'].";";
		}else{
			echo 'window.idtodieutrichitiet=\'\';';
		}
		if($_GET['iddonthuoc']!=''){
			echo 'window.iddonthuoc='.$_GET['iddonthuoc'].";";
		}else{
			echo 'window.iddonthuoc=\'\';';
		}
		if($_GET['iddonthuoctralai']!=''){
			echo 'window.idtralaithuoc='.$_GET['iddonthuoctralai'].";";
		}else{
			echo 'window.idtralaithuoc=\'\';';
		}
		?>
		$('#tenbn').html('<?=$_GET['tenbn']?>');
		$('#tuoi').html('<?=$_GET['tuoi']?>');
		$('#gtinh').html('<?=$_GET['gioitinh']?>');
		$('#doituongt').html('<?=$_GET['duoituong']?>');
		$('#sogiuong').html('<?=$_GET['sogiuong']?>');
		$('#sobuong').html('<?=$_GET['sobuong']?>');
		$("#mabenhnhan").val(<?=$_GET['mabn']?>);
		window.soluongtralaitoida=0;
		window.donthuoctralaixoa='';
		window.canlamsangload=0;
		window.dieutriphoihopload=0;
		window.donthuocload=0;
		window.donthuoctralaiload=0;
		window.dieutrichitietload=0;
		window.luukhamload=0;
		// data_ylenh_dichvu_chamsoc 
		create_combobox_new('#combo_dv_chamsoc',create_dv_chamsoc,'bw','','data_ylenh_dichvu_chamsoc',0);
		create_combobox_new('#combo_lydotodieutri',create_lydotodieutri,'bw','[]','data_ylenh_lydotodieutri',0);
		create_combobox_new('#bschophepthuchien',create_bs_chidinh,'bw','','data_bacsi_todieutri',0);
		create_combobox_disable("#combo_lydotodieutri");
		create_thuocmau('#thuocmau');
		create_thuocmau2('#thuocmau2');	
		$("#apdung").change(function(e) {
			if($("#apdung").is(':checked')){
				create_combobox_enable("#combo_lydotodieutri");
			}else{
				create_combobox_disable("#combo_lydotodieutri");
			}
		});
		//alert(window.iddonthuoc);
		
		$(document).keyup(function(e) {
			if(jwerty.is("ctrl+shift+x",e)){
				if(window.iddonthuoc>0){
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=checkdonthuoc_taophieulinh&iddonthuoc='+window.iddonthuoc).done(function(data){
						alert(data);
					});
					return false;
				}
			}
			if(jwerty.is("ctrl+shift+z",e)){
				if(window.idtodieutrichitiet>0){
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=ylenh_getthongtintodieutrichitiet&id='+window.idtodieutrichitiet).done(function(data){
						alert(data);
					});
					return false;
				}
			}
		});
		
		
		$("#todieutri_luu").click(function(e) {
			if(window.dangluu==0){
				$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_dathanhtoan&id_luotkham=<?=$_GET['idluotkham']?>&getkhoa=0').done(function(data){
				data=data.split('|||');
				//alert(data[1]);
				if(data[0]=="true"){
					savedRow = $('#donthuoc_rowed3').jqGrid("getGridParam", "savedRow");		
							if (savedRow && savedRow.length > 0) {
							//	alert(savedRow[0].id);
								if($('#'+savedRow[0].id+'_ID_Thuoc_combobox').val()!=''){
									//alert(savedRow[0].id);
									jQuery("#donthuoc_rowed3").jqGrid('saveRow',savedRow[0].id);
								}else{
									$('#donthuoc_rowed3').jqGrid('delRowData',savedRow[0].id);
								}
							//	jQuery("#donthuoc_rowed3").jqGrid('saveRow',savedRow[0].id);					
							}
					savedRow1 = $('#tralaithuoc_rowed3').jqGrid("getGridParam", "savedRow");					 
							if (savedRow1 && savedRow1.length > 0) {
							//	alert($('#'+savedRow1[0].id+'_ID_Thuoc_Tra_combobox').val());
								if($('#'+savedRow1[0].id+'_ID_Thuoc_Tra_combobox').val()!=''){	
									var tra_sl=$('#'+savedRow1[0].id+'_soluongtralai').val().split(',');
									console.log(tra_sl[0]);
									if(tra_sl[0]>0){		  
										jQuery("#tralaithuoc_rowed3").jqGrid('saveRow',savedRow1[0].id);
									}else{
										$('#tralaithuoc_rowed3').jqGrid('delRowData',savedRow1[0].id);
									}
								}else{
									$('#tralaithuoc_rowed3').jqGrid('delRowData',savedRow1[0].id);
								}
							}
					savedRow2 = $('#vattutieuhao_rowed3').jqGrid("getGridParam", "savedRow");					 
							if (savedRow2 && savedRow2.length > 0) {
								if($('#'+savedRow2[0].id+'_ID_VatTuTieuHao_combobox').val()!=''){			  
									jQuery("#vattutieuhao_rowed3").jqGrid('saveRow',savedRow2[0].id);
								}else{
									$('#vattutieuhao_rowed3').jqGrid('delRowData',savedRow2[0].id);
								}
							}
					savedRow3 = $('#donthuocchove_rowed3').jqGrid("getGridParam", "savedRow");					 
							if (savedRow3 && savedRow3.length > 0) {
								if($('#'+savedRow3[0].id+'_ID_ThuocChoVe_combobox').val()!=''){			  
									jQuery("#donthuocchove_rowed3").jqGrid('saveRow',savedRow3[0].id);
								}else{
									$('#donthuocchove_rowed3').jqGrid('delRowData',savedRow3[0].id);
								}
							}
					
					if($("#apdung").is(':checked') && $("#combo_lydotodieutri").val()==""){
						tooltip_message("Vui lòng chọn lý do cho thực hiện");
						$("#combo_lydotodieutri").focus();
					}else{
						window.dangluu=1;
						$("#todieutri_luu").button('disable');
						var gridData3 = jQuery("#donthuoc_rowed3").getRowData();
						var postData3 = JSON.stringify(gridData3);
						postData3='{"id":'+postData3+'}';
						postData3=$.parseJSON(postData3);
						if($.trim(window.iddonthuoc)=='undefined'){
								window.iddonthuoc='';
							}
						$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_donthuoc&oper=add&idluotkham=<?=$_GET['idluotkham']?>&id_todieutri=<?=$_GET['id_todieutri']?>&id_donthuoc='+window.iddonthuoc+'&idbenhnhan=<?=$_GET["idbenhnhan"]?>&idkhoa=<?=$_GET["idkhoa"]?>&hienmaloi=a&xoa='+window.donthuocxoa,postData3).done(function(data){
							var rs=data.split(";");
							if($.trim(window.iddonthuoc)=='' || $.trim(window.iddonthuoc)=='undefined'){
								window.iddonthuoc=rs[1];
								//alert("1_"+window.iddonthuoc);
							}
							var gridData_vtth = jQuery("#vattutieuhao_rowed3").getRowData();
							var postData_vtth = JSON.stringify(gridData_vtth);
							postData_vtth='{"id":'+postData_vtth+'}';
							postData_vtth=$.parseJSON(postData_vtth);
							if($.trim(window.iddonthuoc)=='undefined'){
									window.iddonthuoc='';
								}
							$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_vattutieuhao&oper=add&idluotkham=<?=$_GET['idluotkham']?>&id_todieutri=<?=$_GET['id_todieutri']?>&id_donthuoc='+window.iddonthuoc+'&idbenhnhan=<?=$_GET["idbenhnhan"]?>&hienmaloi=a&xoa='+window.vattutieuhaoxoa,postData_vtth).done(function(data){
									window.donthuocxoa='';
									window.vattutieuhaoxoa='';
									var rs1=data.split(";");
									if($.trim(window.iddonthuoc)=='' || $.trim(window.iddonthuoc)=='undefined'){
										window.iddonthuoc=rs1[1];
										//alert("1_"+window.iddonthuoc);
									}
									var gridData_toachove = jQuery("#donthuocchove_rowed3").getRowData();
									var postData_toachove = JSON.stringify(gridData_toachove);
									postData_toachove='{"id":'+postData_toachove+'}';
									postData_toachove=$.parseJSON(postData_toachove);
									if($.trim(window.iddonthuoc)=='undefined'){
											window.iddonthuoc='';
										}
									$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_donthuoc_chove&oper=add&idluotkham=<?=$_GET['idluotkham']?>&id_todieutri=<?=$_GET['id_todieutri']?>&id_donthuoc='+window.iddonthuoc+'&idbenhnhan=<?=$_GET["idbenhnhan"]?>&idkhoa=<?=$_GET["idkhoa"]?>&hienmaloi=a&xoa='+window.donthuochove+'&loidando='+$("#chove_dando").val(),postData_toachove).done(function(data){
											window.donthuocxoa='';
											window.donthuochove='';
											var rs1=data.split(";");
											if($.trim(window.iddonthuoc)=='' || $.trim(window.iddonthuoc)=='undefined'){
												window.iddonthuoc=rs1[1];
												//alert("1_"+window.iddonthuoc);
											}
									
											//alert("2_"+window.iddonthuoc);
											var gridData4 = jQuery("#tralaithuoc_rowed3").getRowData();
											var postData4 = JSON.stringify(gridData4);
											postData4='{"id":'+postData4+'}';
											postData4=$.parseJSON(postData4);
											$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_tralaithuoc&oper=add&idluotkham=<?=$_GET['idluotkham']?>&id_todieutri=<?=$_GET['id_todieutri']?>&id_donthuoctralai='+window.idtralaithuoc+'&idbenhnhan=<?=$_GET["idbenhnhan"]?>&idbenhannoitru=<?=$_GET["idbenhannoitru"]?>&xoa='+window.donthuoctralaixoa,postData4).done(function(data){
												var rs2=data.split(";");
												if($.trim(window.idtralaithuoc)=='' || $.trim(window.idtralaithuoc)=='undefined'){
													window.idtralaithuoc=rs2[1];
												}
												if($("#apdung").is(':checked')){
													var apdung=1;
												}else{
													var apdung=0;
												}
													//alert(window.iddonthuoc);
												$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_todieutrichitiet&oper=edit&id_todieutri=<?=$_GET['id_todieutri']?>&iddonthuoc='+window.iddonthuoc+'&idloaichamsoc='+$('#combo_chamsoc_hidden').val()+'&ylenhkhac='+$("#ylenhkhac").val()+'&lydotodieutri='+$("#combo_lydotodieutri_hidden").val()+'&dienbienbenh='+$("#dienbienbenh").val()+'&chophepthuchien='+apdung+'&idtodieutrichitiet='+window.idtodieutrichitiet+'&iddonthuoctralai='+window.idtralaithuoc+'&hienmaloi=a',{ dienbienbenh: $("#dienbienbenh").val(),ylenhkhac:$("#ylenhkhac").val() }).done(function(data){
													var rs_tdt=data.split(';');
													if($.trim(window.idtodieutrichitiet)=='' || $.trim(window.idtodieutrichitiet)=='undefined'){
														window.idtodieutrichitiet=rs_tdt[1];	
													}
													// can lam sang & dieu tri phoi hop
													ids = $('#rowed5').jqGrid('getDataIDs');
													for(var i=0;i<=ids.length-1;i++){
														jQuery("#rowed5").jqGrid('saveRow',ids[i]);
													}
													var gridData = jQuery("#rowed5").getRowData();
													var postData = JSON.stringify(gridData);
													postData='{"id":'+postData+'}';
													postData=$.parseJSON(postData);
													$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_canlamsang&oper=add&id_todieutrichitiet='+window.idtodieutrichitiet,postData).done(function(data){
														window.canlamsangload=1;
														if(window.dieutriphoihopload==1 && window.canlamsangload==1){
															tooltip_message("Đã lưu");
															parent.postMessage('dongformylenh','*');
															$("#todieutri_luu").button('enable');
															window.dangluu=0;
															$("#tralaithuoc_rowed3").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_donthuoctralaibyid_donthuocchitiet&idtodieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
														}
														$("#rowed5").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_loaikham_by_todieutrichitiet&idtodieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
													});
													
													ids2 = $('#dtph_rowed5').jqGrid('getDataIDs');
													for(var i=0;i<=ids2.length-1;i++){
														jQuery("#dtph_rowed5").jqGrid('saveRow',ids2[i]);
													}
													var gridData2 = jQuery("#dtph_rowed5").getRowData();
													var postData2 = JSON.stringify(gridData2);
													postData2='{"id":'+postData2+'}';
													postData2=$.parseJSON(postData2);
													$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_dieutriphoihop&oper=add&id_todieutrichitiet='+window.idtodieutrichitiet,postData2).done(function(data){
														window.dieutriphoihopload=1;
														if(window.dieutriphoihopload==1 && window.canlamsangload==1){
															tooltip_message("Đã lưu");
															$("#todieutri_luu").button('enable');
															window.dangluu=0;
															parent.postMessage('dongformylenh','*');
															
														}
														$("#dtph_rowed5").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_dieutriphoihop_by_todieutrichitiet&idtodieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
													});
													$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_dichvu_chamsoc&oper=add&id_todieutrichitiet='+window.idtodieutrichitiet+'&id_dichvuchamsoc='+$("#combo_dv_chamsoc_hidden").val()).done(function(data){
														//alert('luu');
														//tooltip_message("Đã lưu");
														$("#todieutri_luu").button('enable');
														window.dangluu=0;
													});
													$("#tralaithuoc_rowed3").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_donthuoctralaibyid_donthuocchitiet&idtodieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
													$.post('resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_all_thuoctralai&idluotkham=<?=$_GET['idluotkham']?>&idkhoa=<?=$_GET['idkhoa']?>').done(function(data) {
																data=data.split('|||');
																window.grid_datathuoc_tralai= data[0];
																window.id_datathuoc_tralai= jQuery.parseJSON(data[1]);
													});
													
													$("#donthuoc_rowed3").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_donthuocbyid_luotkham&id_todieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
													
													$("#vattutieuhao_rowed3").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_vattuyte_byid_todieutrichitiet&id_todieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
													
													$("#donthuocchove_rowed3").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_donthuocchove_byid_todieutrichitiet&id_todieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
													if(apdung==1){
														//alert(window.idtodieutrichitiet);
														 $.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_todieutri_hoantat&oper=luu&id_todieutri=<?=$_GET['id_todieutri']?>&idtodieutrichitiet='+window.idtodieutrichitiet+'&nguoichidinh='+$('#bschophepthuchien_hidden').val()).done(function(data){
															 window.luukhamload=1;
															// tooltip_message("Đã lưu");
														});
													}
												});//luu todieutrichitiet
										});//luu don thuoc tra lai
									});//luu toa thuoc cho ve
							});//luu vat tu y te
						});//luu don thuoc
					}// end else
				}// end if thanh toán
				});// check thanh toán
			}// if dang luu
        });//end luu
	window.thuoc=  $.ajax({                       
		url: "resource.php?module=web_services&function=get_auto_edit_option_byid&action=index&term=&status=0&tables=DM_Thuoc&id=ID_Thuoc&name=TenGoc",
		async:false                       
	}).responseText;

	window.duongdung=  $.ajax({                       
		url: "resource.php?module=web_services&function=get_auto_edit_option&action=index&term=&status=2&tables=DM_DuongDung&id=ID_DuongDung&name=TenDuongDung",
		async:false                       
	}).responseText;

	
	$.post('resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_loaichamsoc').done(function(data) {
		create_combobox_new('#combo_chamsoc',create_chamsoc,'bw',data,'data_ylenh_loaichamsoc',0);
	});
	$.post('resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lydotodieutri').done(function(data) {
		create_combobox_new('#combo_lydotodieutri',create_lydotodieutri,'bw',data,'data_ylenh_lydotodieutri',0);
	});
	$('body').bind('keydown', function (e) {	
	if(window.n_tab==3){
		$('#donthuoc_rowed3').removeClass('ui-state-disabled')	 ;
		if (e.keyCode == '45') {
			savedRow = $('#donthuoc_rowed3').jqGrid("getGridParam", "savedRow");     
			if (savedRow && savedRow.length > 0) {			  
			}else{
				 $("#donthuoc_rowed3_iladd").click();
				//  var ids = jQuery("#donthuoc_rowed3").jqGrid('getDataIDs');	
			}
		}
		if (e.keyCode == '27') {
			$("#donthuoc_rowed3_ilcancel").click();
		}
	}else if(window.n_tab==4){
		$('#tralaithuoc_rowed3').removeClass('ui-state-disabled')	 ;
		if (e.keyCode == '45') {
			savedRow = $('#tralaithuoc_rowed3').jqGrid("getGridParam", "savedRow");     
		if (savedRow && savedRow.length > 0) {			  
			}else{
				 $("#tralaithuoc_rowed3_iladd").click();
				
				// var ids = jQuery("#tralaithuoc_rowed3").jqGrid('getDataIDs');	
			}
		}
		if (e.keyCode == '27') {
			$("#tralaithuoc_rowed3_ilcancel").click();
		}
	}
	});
 $( "#dialog-thuochuacogiaban" ).dialog({
      resizable: false,
      height:'auto',
	  
	  autoOpen :false,
      modal: true,
      buttons: {
        "Yes": function() {		
			$( this ).dialog( "close" );	
			 setTimeout(function(){
		 	 $("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_SoThuocThucXuat").focus();
			 $("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_SoThuocThucXuat").select();
		  },200);
        },
        "No": function() {
          $( this ).dialog( "close" );
		  setTimeout(function(){
		 	 $("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").focus();
			 $("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").val('');
		  },200);

        }
      },open: function () {
		  $(this).closest('.ui-dialog').find('.ui-dialog-buttonpane button:eq(0)').focus(); 
		  $(this).closest('.ui-dialog').find('.ui-dialog-buttonpane button:eq(0)').addClass('n_btn1');
		   $(this).closest('.ui-dialog').find('.ui-dialog-buttonpane button:eq(1)').addClass('n_btn2');
			  $('.ui-dialog').keyup(function(e) {
				  if (e.keyCode === 37){
					  $('.n_btn1').focus(); 
					  $('.n_btn2').focusout();
				  }
				  if (e.keyCode === 39){
					  $('.n_btn2').focus(); 
					  $('.n_btn1').focusout();
				  }
				})
		},close: function () {
			
		 $('.ui-dialog-titlebar-close').focus(); 
		 $('.ui-dialog-titlebar-close').click(); 
		}
    });
	
	$( "#dialog-thuoctrong" ).dialog({
      resizable: false,
	  autoOpen:false,
      height:160,
      modal: true,
      buttons: {
        "OK": function() {
          $( this ).dialog( "close" );
		  setTimeout(function(){
		 	 $("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").focus();
		  },200);
        },
      }
    });
	
	$( "#dialog-thuoctralaitrong" ).dialog({
      resizable: false,
	  autoOpen:false,
      height:160,
      modal: true,
      buttons: {
        "OK": function() {
          $( this ).dialog( "close" );
        },
      },close: function() {
		   setTimeout(function(){
		  	 $("#tralaithuoc_rowed3 #"+$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").focus();
		    },200);
	  }
    });
	$( "#dialog-soluongxuat" ).dialog({
      resizable: false,
	  autoOpen:false,
      height:160,
      modal: true,
      buttons: {
        "OK": function() {
          $( this ).dialog( "close" );
		  setTimeout(function(){
		 	 $("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_SoThuocThucXuat").focus();
		  },200);
        },
      }
    });
	$( "#dialog-soluongtralai" ).dialog({
      resizable: false,
	  autoOpen:false,
      height:160,
      modal: true,
      buttons: {
        "OK": function() {
          $( this ).dialog( "close" );
		  setTimeout(function(){
		 	 $("#tralaithuoc_rowed3 #"+$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_soluongtralai").focus();
		  },200);
        },
      },close: function() {
		   setTimeout(function(){
		 	 window.soluongtralaitrong=0;
		   },200);
	  }
    });
	
	$( "#dialog-thuoctralaidaco" ).dialog({
      resizable: false,
	  autoOpen:false,
      height:160,
      modal: true,
      buttons: {
        "OK": function() {
          $( this ).dialog( "close" );
		  setTimeout(function(){
		 	 $("#tralaithuoc_rowed3 #"+$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").focus();
		  },1);
        },
      }
    });
	
	$( "#dialog-thuocdake" ).dialog({
      resizable: false,
	  autoOpen:false,
      height:160,
      modal: true,
      buttons: {
        "OK": function() {
          $( this ).dialog( "close" );
		  setTimeout(function(){
		 	 $("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").focus();
		  },200);
        },
      }
    });
		
		create_donthuoc();
		create_tralaithuoc()
		$("#tabs").tabs({});
		$("#todieutri_luu").button();
		 getDataRHM(<?=$_GET['idluotkham']?>);
		// create_combobox_new('#combo_chamsoc',create_chamsoc,'bw','[]','data_ylenh_loaichamsoc',0);
		// alert();
	//lam sang
	setTimeout(function(){
		window.ds_tang=$.cookie("dstang");
		$('#dialog_loi2').dialog({
                autoOpen: false,
                width: 350,
				height:150,
                modal: true,
                resizable: false,
				closeOnEscape: true,
				buttons: {
					"Ok": function() {
						$( this ).dialog( "close" );
					}
				}
            });
			
		if(window.ds_tang==""){
			$( "#dialog_loi2" ).dialog('open');
		}else{
	//	window.new_ds_tang=window.ds_tang.split(",");
		window.new_ds_tang='1';
		}
		 },300);
		 
		<?php 
		$data= new SQLServer;
		$params = array($_GET['idluotkham']);
		$store_name="{call Gd2_ThongTinLuotKham_SelectAllByID_LuotKham(?)}";
		$get=$data->query( $store_name,$params);
		$excute= new SQLServerResult($get);
		$tam= $excute->get_as_array();
		
		$params2 = array($_GET['idluotkham']);
		$store_name2="{call GD2_GetTrangThaiLuotKhamByID_LuotKham(?)}";
		$get2=$data->query( $store_name2,$params2);
		$excute2= new SQLServerResult($get2);
		$tam2= $excute2->get_as_array();
		
		echo 'window.idluotkham='.$_GET['idluotkham'].';';
		echo 'window.loaidoituongkham="'.$tam[0]['LoaiDoiTuongKham'].'";';
		echo 'window.idbenhnhan='.$tam[0]['ID_BenhNhan'].';';
		echo 'window.n_idtrangthai="'.$tam2[0]['ID_TrangThai'].'";';
		?>
		if(window.n_idtrangthai=='KetThucKham'){ //
			$("#thongbao").html("Thông báo: Lượt khám này đã hoàn tất");
			 $("#btn_luu").prop("disabled",true);
		}
		$("#tabs").css("height",jQuery(".ylenhbody").height() -160 + "px");
		 temp = jQuery("#tabs-1").height();
		// alert(temp);
        $("#panel_main").css("height", temp -50 + "px");
        $("#panel_main").fadeIn(1000);
		
		 temp2 = jQuery("#tabs-2").height();
		// alert(temp2);
        $("#panel_main_tab2").css("height", temp2 -50 + "px");
        $("#panel_main_tab2").fadeIn(1000);	
	
		/*$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_ylenh_lamsang_PhuThuThucHienTaiNha').done(function(data) {
		 window.phuthu=jQuery.parseJSON(data);
		 
		});*/
		/*$.ajax({
		  url: 'resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_ylenh_lamsang_benhnhanby_idluotkham&id='+window.idluotkham+'&ac=ma',
		  context: document.body
		}).done(function(data) {
			alert(data);
			$("#mabenhnhan").val(data);
		});
		*/
				
		window.tab2=0;
		load_select_hotennv();
		window.hotennv2=":Chọn nhân viên;"+window.hotennv;
		load_select_tenloaikham();
		load_select_nguoichidinh();
		load_select_trangthai();
		load_select_tennhomcha();
		load_select_bophanthuchien();
        create_layout();
		
        create_grid();
        create_grid2();
        create_grid3();
		
		dtph_create_grid();
        dtph_create_grid2();
        dtph_create_grid3();
		
		create_vattutieuhao();
		create_donthuocchove();
		
		
		//setTimeout (dtph_create_layout,5000);
        resize_control();
		document.getElementById("xemtatca").checked=true;
		var luot =0;
		
		dodulieu(<?=$_GET['id_todieutri']?>);
		
		$('#btn_inphieucd, #btn_luu,#chongoikham').button();
		$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_hangmucloaikham_all"}).trigger('reloadGrid');
		
		$("#xemtatca").change(function(event) {
			if($("#xemtatca").is(':checked')==true){
				$("#gs_TenLoaiKham").focus();
				$("#gs_TenLoaiKham").val("");
				$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_hangmucloaikham_all"}).trigger('reloadGrid');

			}else{
				
				id = $('#rowed3').jqGrid ('getGridParam', 'selrow');
				//alert(id);	
				if(id==null){
					//alert(1)
					var ids = jQuery("#rowed3").jqGrid('getDataIDs');
					var rowData = jQuery('#rowed3').jqGrid ('getRowData', ids[1]);	
					var ID_NhomCLS = rowData['ID_NhomCLS'];// alert(ID_LuotKham);	
					$("#gs_TenLoaiKham").val("");
					$('#rowed3 #'+id).focus();				 
					$("#rowed3").jqGrid("setSelection",ids[1], true);
					$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_hangmucloaikham_idnhomcls&id="+ID_NhomCLS}).trigger('reloadGrid');
				}else{
					//alert(2)
					var rowData = $("#rowed3").getRowData(id); 
					var ID_NhomCLS = rowData['ID_NhomCLS'];// alert(ID_LuotKham);	
					$("#gs_TenLoaiKham").val("");
					$('#rowed3 #'+id).focus();				 
					$("#rowed3").jqGrid("setSelection",id, true);
					$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_hangmucloaikham_idnhomcls&id="+ID_NhomCLS}).trigger('reloadGrid');
				}
				
		}
		});

        $(window).resize(function() {
            temp = jQuery("#tabs-1").height();
            $("#panel_main").css("height", temp + "px");
			 temp2 = jQuery("#tabs-2").height();
       		 $("#panel_main_tab2").css("height", temp2 -50 + "px");	
            resize_control();
        })
		
		$('#dialog_confirm_cls_huybo').dialog({
                autoOpen: false,
				width: 200,
                modal: true,
                resizable: false,
                buttons: {
                    "Ok": function() {
                        $("#rowed5").jqGrid('setRowData',$("#idk").val(),{ThanhTienVienPhi:0});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{ThanhTienBHYT:0});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{PhiThucHien:0});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{TrangThai:"HuyBo"});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{LyDoHuyBo:$("#lydohuybo").val()});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{Huy:1});
						$("#rowed5").jqGrid('setRowData',$("#idk").val() , '', { background: '#A9A9AA',border:'1px solid #BBBBBB' });
						jQuery("#rowed5").jqGrid('saveRow',$("#idk").val());
						var tmp5 = $("#rowed5").jqGrid('getDataIDs'); 

						 	var tt_bhyt =0;
							var tt_vienphi =0;
							var phithuchien =0;
							for(var i=0;i < tmp5.length;i++){ 
									var rowData = $("#rowed5").getRowData(tmp5[i]);
									xoa = "<input class=' custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp5[i]+"');\" />"; 
									$("#rowed5").jqGrid('setRowData',tmp5[i],{Xoa:xoa});	
									tt_vienphi =parseFloat(tt_vienphi) + parseFloat(rowData["ThanhTienVienPhi"]);
									tt_bhyt =parseFloat(tt_bhyt) + parseFloat(rowData["ThanhTienBHYT"]);
									phithuchien =parseFloat(phithuchien) + parseFloat(rowData["PhiThucHien"]);
								
								}
						  
							$("#thanhtienvienphi").val(formatMoney(tt_vienphi));
							$("#thanhtienbhyt").val(formatMoney(tt_bhyt));
							$("#phithuchien").val(formatMoney(phithuchien));
						
                        $(this).dialog("close");
                    },
                    "Cancel": function() {
						
                        $(this).dialog("close");
                    }
                }
            });
			
			$('#dialog_confirm_dtph_huybo').dialog({
                autoOpen: false,
                width: 200,
                modal: true,
                resizable: false,
                buttons: {
                    "Ok": function() {
                        $("#dtph_rowed5").jqGrid('setRowData',$("#dtph_idk").val(),{dtph_thanhtien:0});
						$("#dtph_rowed5").jqGrid('setRowData',$("#dtph_idk").val(),{dtph_phithuchien:0});
						$("#dtph_rowed5").jqGrid('setRowData',$("#dtph_idk").val(),{TrangThai:"HuyBo"});
						$("#dtph_rowed5").jqGrid('setRowData',$("#dtph_idk").val(),{Huy:1});
						$("#dtph_rowed5").jqGrid('setRowData',$("#dtph_idk").val() , '', { background: '#A9A9AA' });
						jQuery("#dtph_rowed5").jqGrid('saveRow',$("#dtph_idk").val());
						var tmp5 = $("#dtph_rowed5").jqGrid('getDataIDs'); 

						  var tongtien =0;
						  var phithuchien =0;
							for(var i=0;i < tmp5.length;i++){ 
									var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
									xoa = "<input class='custom_button_n' style='height:22px;width:50px;margin-left: -14px; box-shadow:none!important;cursor:pointer;' type='button' value='Xóa' onclick=\"dtph_n_xoa('"+tmp5[i]+"');\" />"; 
									$("#dtph_rowed5").jqGrid('setRowData',tmp5[i],{Xoa:xoa});	
									tongtien =parseInt(tongtien) + parseInt(rowData["dtph_phithuchien"]);
									phithuchien =parseInt(phithuchien) + parseInt(rowData["dtph_phithuchien"]);
								
								}
						  
							$("#dtph_thanhtien").val(formatMoney(tongtien));
							$("#dtph_phithuchien").val(formatMoney(phithuchien));
							
							//tinhtien theo nhom loai kham
							var tongtien_vatlytrilieu=0;
							var tongtien_tthuat_pthuat=0;
							var tongtien_family_flanning=0;
							var tongtien_dieuduong=0;
							for(var i=0;i < tmp5.length;i++){ 
								var rowData = $("#rowed5").getRowData(tmp5[i]);
								
								if(rowData["IDNhomCLS"]==25){
									tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["PhiThucHien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
								}else if(rowData["IDNhomCLS"]==23){
									tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["PhiThucHien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
								}else if(rowData["IDNhomCLS"]==52){
									tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["PhiThucHien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
								}else if(rowData["IDNhomCLS"]==26){
									tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["PhiThucHien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
								}
								
								
							
						}//end for
						
						for(var i=0;i < tmp5.length;i++){ 
							var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
							if(rowData["IDNhomCLS"]==25){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
								}else if(rowData["IDNhomCLS"]==23){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
								}else if(rowData["IDNhomCLS"]==52){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
								}else if(rowData["IDNhomCLS"]==26){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
									}
								
						}//end for
						//end tong tien nhom
                        $(this).dialog("close");
                    },
                    "Cancel": function() {
                        $(this).dialog("close");
                    }
                }
            });
			
			$('#dialog_loi').dialog({
                autoOpen: false,
                width: 350,
				height:150,
                modal: true,
                resizable: false,
				closeOnEscape: true,
				buttons: {
					"Ok": function() {
						$( this ).dialog( "close" );
					}
				}
            });
			
			
			
			$('#comfrim').dialog({
                autoOpen: false,
                width: 350,
				height:150,
                modal: true,
                resizable: false,
				closeOnEscape: true,
				focus: function() {
					$('#comfrim').parent().find('.ui-dialog-buttonpane button:eq(0)').focus();
				},
				buttons: {
					"Ok": function() {
						$( this ).dialog( "close" );
					},
					"can": function() {
						$( this ).dialog( "close" );
					}
				}
            });
			
		if(window.idluotkham==""){
			$( "#dialog_loi" ).dialog('open');
			//alert("Vui lòng chọn lượt khám để thực hiện chức năng này");	
		}
		
		$("input#botton_cdmoi").attr("disabled", true);
		$( "#botton_chidinh" ).addClass( "ui-state-disabled" );
			$( ".data_chongoikham" ).dialog({
			  autoOpen: false,
			  height: 500,
			  width: 1035,
			  modal: true,
			  
			  buttons: {
				"Chọn": function() {
						var i,j,tmp,tmp1;		
						tmp = jQuery("#data_loaikham").jqGrid('getGridParam','selarrrow');
$.get( "resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=ylenh_lamsang_check_phongban&ac=check2&id_loaikham="+tmp+"&ds_tang="+window.new_ds_tang, function( data ) {				
					var rs=jQuery.parseJSON(data);
					var n_idlk;
					var  tmpn = jQuery("#data_loaikham").jqGrid('getGridParam','selarrrow');
						 for(j=0;j<rs.length;j++){
							 for(i=0;i<tmpn.length;i++){
						  		tmpn1=tmpn[i].split(",");
								flag=0;
								if(parseInt(rs[j]["id"])==parseInt(tmpn1)){
									n_idlk= rs[j]["ID_PhongBan"];
									chuyen3(parseInt(tmpn1),n_idlk);
									//break;
									flag=1;
								}
								if(flag=0){
									//alert(parseInt(rs[j]["id"])+"="+parseInt(tmpn1));
									chuyen3(parseInt(tmpn1),"0");
								//	break;
								}
						 }
				}//end for
				var tmp3 = $("#rowed5").jqGrid('getDataIDs'); 
				var tt_bhyt =0;
				var tt_vienphi =0;
				var phithuchien =0;
				for(var i=0;i < tmp3.length;i++){ 
						var rowData = $("#rowed5").getRowData(tmp3[i]);	
						xoa = "<input class=' custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp3[i]+"');\" />"; 
						$("#rowed5").jqGrid('setRowData',tmp3[i],{Xoa:xoa});
						 tt_vienphi =parseFloat(tt_vienphi) + parseFloat(rowData["ThanhTienVienPhi"]);
						 tt_bhyt =parseFloat(tt_bhyt) + parseFloat(rowData["ThanhTienBHYT"]);
						 phithuchien =parseFloat(phithuchien) + parseFloat(rowData["PhiThucHien"]);
					}
				$("#thanhtienvienphi").val(formatMoney(tt_vienphi));
				$("#thanhtienbhyt").val(formatMoney(tt_bhyt));
				$("#phithuchien").val(formatMoney(phithuchien));
							//alert("Ket thuc "+i);
});
					$( this ).dialog( "close" );
				  },
				Cancel: function() {
				  $( this ).dialog( "close" );
				}
			  },	
			  close: function() {
			  }
			});

	//end lam sang
	
	//dieu tri phoi hop
		$('#dtph_dialog').dialog({
                autoOpen: false,
                width: 400,
				width: 400,
                modal: true,
                resizable: false,
                buttons: {
                    "Ok": function() {
                        $("#dtph_rowed5").jqGrid('setRowData',$("#idk").val(),{dtph_thanhtien:0});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk").val(),{dtph_phithuchien:0});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk").val(),{TrangThai:"HuyBo"});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk").val(),{LyDoHuyBo:$("#lydohuybo").val()});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk").val(),{Huy:1});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk").val() , '', { background: '#A9A9AA' });
						jQuery("#dtph_rowed5").jqGrid('saveRow',$("#idk").val());
						var tmp5 = $("#dtph_rowed5").jqGrid('getDataIDs'); 

						  var tongtien =0;
						  var dtph_phithuchien =0;
							for(var i=0;i < tmp5.length;i++){ 
									var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
									xoa = "<input class='dtph_custom_button_n' style='height:22px;width:50px;margin-left: -14px; box-shadow:none!important;cursor:pointer;' type='button' value='Xóa' onclick=\"dtph_n_xoa('"+tmp5[i]+"');\" />"; 
									$("#dtph_rowed5").jqGrid('setRowData',tmp5[i],{Xoa:xoa});	
									tongtien =parseInt(tongtien) + parseInt(rowData["dtph_thanhtien"]);
									dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt(rowData["dtph_phithuchien"]);
								
								}
						  
							$("#dtph_thanhtien").val(formatMoney(tongtien));
							$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
							
							//tinhtien theo nhom loai kham
							var tongtien_vatlytrilieu=0;
							var tongtien_tthuat_pthuat=0;
							var tongtien_family_flanning=0;
							var tongtien_dieuduong=0;
							for(var i=0;i < tmp5.length;i++){ 
								var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
								
								if(rowData["IDNhomCLS"]==25){
									tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["dtph_phithuchien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
								}else if(rowData["IDNhomCLS"]==23){
									tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["dtph_phithuchien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
								}else if(rowData["IDNhomCLS"]==52){
									tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["dtph_phithuchien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
								}else if(rowData["IDNhomCLS"]==26){
									tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["dtph_phithuchien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
								}
							
						}//end for
						for(var i=0;i < tmp5.length;i++){ 
							var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
							if(rowData["IDNhomCLS"]==25){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
								}else if(rowData["IDNhomCLS"]==23){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
								}else if(rowData["IDNhomCLS"]==52){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
								}else if(rowData["IDNhomCLS"]==26){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
									}
						}//end for
						//end tong tien nhom
                        $(this).dialog("close");
                    },
                    "Cancel": function() {
						
                        $(this).dialog("close");
                    }
                }
            });
			
			$('#dtph_dialog2').dialog({
                autoOpen: false,
                width: 150,
				width: 300,
                modal: true,
                resizable: false,
                buttons: {
                    "Ok": function() {
                        $("#dtph_rowed5").jqGrid('setRowData',$("#idk2").val(),{dtph_thanhtien:0});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk2").val(),{dtph_phithuchien:0});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk2").val(),{TrangThai:"HuyBo"});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk2").val(),{LyDoHuyBo:$("#lydohuybo").val()});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk2").val(),{Huy:1});
						$("#dtph_rowed5").jqGrid('setRowData',$("#idk2").val() , '', { background: '#A9A9AA' });
						jQuery("#dtph_rowed5").jqGrid('saveRow',$("#idk2").val());
						var tmp5 = $("#dtph_rowed5").jqGrid('getDataIDs'); 

						  var tongtien =0;
						  var dtph_phithuchien =0;
							for(var i=0;i < tmp5.length;i++){ 
									var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
									xoa = "<input class='dtph_custom_button_n' style='height:22px;width:50px;margin-left: -14px; box-shadow:none!important;cursor:pointer;' type='button' value='Xóa' onclick=\"dtph_n_xoa('"+tmp5[i]+"');\" />"; 
									$("#dtph_rowed5").jqGrid('setRowData',tmp5[i],{Xoa:xoa});	
									tongtien =parseInt(tongtien) + parseInt(rowData["dtph_thanhtien"]);
									dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt(rowData["dtph_phithuchien"]);
								}
						  
							$("#dtph_thanhtien").val(formatMoney(tongtien));
							$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
							//tinhtien theo nhom loai kham
							var tongtien_vatlytrilieu=0;
							var tongtien_tthuat_pthuat=0;
							var tongtien_family_flanning=0;
							var tongtien_dieuduong=0;
							for(var i=0;i < tmp5.length;i++){ 
								var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
								if(rowData["IDNhomCLS"]==25){
									tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["dtph_phithuchien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
								}else if(rowData["IDNhomCLS"]==23){
									tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["dtph_phithuchien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
								}else if(rowData["IDNhomCLS"]==52){
									tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["dtph_phithuchien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
								}else if(rowData["IDNhomCLS"]==26){
									tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["dtph_phithuchien"]);
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
								}
						}//end for
						for(var i=0;i < tmp5.length;i++){ 
							var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
							if(rowData["IDNhomCLS"]==25){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
								}else if(rowData["IDNhomCLS"]==23){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
								}else if(rowData["IDNhomCLS"]==52){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
								}else if(rowData["IDNhomCLS"]==26){
									$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
									}
						}//end for
						//end tong tien nhom
                        $(this).dialog("close");
                    },
                    "Cancel": function() {
                        $(this).dialog("close");
                    }
                }
            });		
	//end dieu tri phoi hop
	$.post('resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_donthuoc_DMthuoc').done(function(data) {
		data=data.split('|||');
		window.grid_datathuoc= data[0];
		window.grid_datavattutieuhao= data[0];
		window.id_datathuoc= jQuery.parseJSON(data[1]);
	});
	$.post('resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_dm_vattutieuhao').done(function(data) {
		window.grid_datavattutieuhao= data;
	});
	
	$.post('resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_all_thuoctralai&idluotkham=<?=$_GET['idluotkham']?>&idkhoa=<?=$_GET['idkhoa']?>').done(function(data) {
		data=data.split('|||');
		window.grid_datathuoc_tralai= data[0];
		window.id_datathuoc_tralai= jQuery.parseJSON(data[1]);
	   // create_Dm_thuoc_grid('#DM_thuoc',data[0])
	});
}); //end ready
var lastsel;
function getDataRHM(id_luotkham)
	{

	}
	
function create_chamsoc(elem, datalocal) {
	datalocal = jQuery.parseJSON(datalocal);
	$(elem).jqGrid({
		datastr: datalocal,
		datatype: "jsonstring",
		colNames: ['Loại chăm sóc'],
		colModel: [
			{name: 'manv', index: 'manv', hidden: false,width:100},
		 ],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scroll: 1,
		modal: true,
		rowNum: 100,
		rowList: [],
		height: 100,
		width: 300,
		viewrecords: true,
		ignoreCase: true,
		shrinkToFit: true,
		cmTemplate: {sortable: false},
		sortorder: "desc",
		serializeRowData: function(postdata) {
		},
		onSelectRow: function(id) {

		  var rowData = $(this).getRowData(id);
		  //alert(rowData);
		  $("#tenbacsi").val(rowData["hovaten"]);

		},
		ondblClickRow: function(id, rowIndex, columnIndex) {
		},
		loadComplete: function(data) {
		},
	});
	$(elem).jqGrid('filterToolbar', {searchOperators: false, searchOnEnter: false, defaultSearch: "cn"});
	$(elem).jqGrid('bindKeys', {});
}

function create_dv_chamsoc(elem, datalocal) {
	datalocal = jQuery.parseJSON(datalocal);
	$(elem).jqGrid({
		datastr: datalocal,
		datatype: "jsonstring",
		colNames: ['Loại dịch vụ','Tên dịch vụ','ID_DM_LoaiChamSoc'],
		colModel: [
			{name: 'TenNhom', index: 'TenNhom', hidden: false,width:100},
			{name: 'TenDichVu', index: 'TenDichVu', hidden: true,width:100},
			{name: 'ID_DM_LoaiChamSoc', index: 'ID_DM_LoaiChamSoc', hidden: true,width:10},
		 ],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scroll: 1,
		modal: true,
		rowNum: 100,
		rowList: [],
		height: 100,
		width: 300,
		viewrecords: true,
		ignoreCase: true,
		shrinkToFit: true,
		cmTemplate: {sortable: false},
		sortorder: "desc",
		serializeRowData: function(postdata) {
		},
		onSelectRow: function(id) {

		  var rowData_dvcs = $(this).getRowData(id);
		  setval_new('#combo_chamsoc',rowData_dvcs['ID_DM_LoaiChamSoc']); 

		},
		ondblClickRow: function(id, rowIndex, columnIndex) {
		},
		loadComplete: function(data) {
		},
	});
	$(elem).jqGrid('filterToolbar', {searchOperators: false, searchOnEnter: false, defaultSearch: "cn"});
	$(elem).jqGrid('bindKeys', {});
}

function create_bs_chidinh(elem, datalocal) {
	datalocal = jQuery.parseJSON(datalocal);
	$(elem).jqGrid({
		datastr: datalocal,
		datatype: "jsonstring",
		colNames: ['NickName','Họ tên','Phòng ban'],
		colModel: [
			{name: 'NickName', index: 'NickName', hidden: false,width:40},
			{name: 'HoTen', index: 'HoTen', hidden: false,width:100},
			{name: 'PhongBan', index: 'PhongBan', hidden: false,width:100},
		 ],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scroll: 1,
		modal: true,
		rowNum: 100,
		rowList: [],
		height: 200,
		width: 500,
		viewrecords: true,
		ignoreCase: true,
		shrinkToFit: true,
		cmTemplate: {sortable: false},
		sortorder: "desc",
		serializeRowData: function(postdata) {
		},
		onSelectRow: function(id) {

		  var rowData_dvcs = $(this).getRowData(id);
		  setval_new('#combo_chamsoc',rowData_dvcs['ID_DM_LoaiChamSoc']); 

		},
		ondblClickRow: function(id, rowIndex, columnIndex) {
		},
		loadComplete: function(data) {
		},
	});
	$(elem).jqGrid('filterToolbar', {searchOperators: false, searchOnEnter: false, defaultSearch: "cn"});
	$(elem).jqGrid('bindKeys', {});
}

function create_lydotodieutri(elem, datalocal) {
	datalocal = jQuery.parseJSON(datalocal);
	$(elem).jqGrid({
		datastr: datalocal,
		datatype: "jsonstring",
		colNames: ['Lý do cho phép điều trị'],
		colModel: [
			{name: 'manv', index: 'manv', hidden: false,width:100},

			
		],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scroll: 1,
		modal: true,
		rowNum: 100,
		rowList: [],
		height: 100,
		width: 300,
		viewrecords: true,
		ignoreCase: true,
		shrinkToFit: true,
		cmTemplate: {sortable: false},
		sortorder: "desc",
		serializeRowData: function(postdata) {
		},
		onSelectRow: function(id) {

		  var rowData = $(this).getRowData(id);
		  //alert(rowData);
		  $("#tenbacsi").val(rowData["hovaten"]);

		},
		ondblClickRow: function(id, rowIndex, columnIndex) {
		},
		loadComplete: function(data) {
		},
	});
	$(elem).jqGrid('filterToolbar', {searchOperators: false, searchOnEnter: false, defaultSearch: "cn"});
	$(elem).jqGrid('bindKeys', {});
}
//lam sang
  function create_grid() {
        $("#rowed3").jqGrid({
            url: 'resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_ylenh_lamsang_nhomloaikham',
            datatype: "json",
            colNames: ['id nhóm cha','id nhóm', 'Khám lâm sàn', 'Tên nhóm cha'],
            colModel: [
                {name: 'IDNhomCha', index: 'IDNhomCha', width: "0%", editable: false, align: 'left', hidden: true,edittype:"select",formatter:'select',editoptions:{value: tennhomcha}},
				{name: 'ID_NhomCLS', index: 'ID_NhomCLS', width: "0%", editable: false, align: 'left', hidden: true},
                {name: 'TenNhom', index: 'TenNhom', search: false, width: "1%", editable: false, align: 'left', hidden: false, classes:'rowed3_event'},
				{name: 'TenNhomCha', index: 'TenNhomCha', width: "2%", editable: false, align: 'left', hidden: true},
				//{name: 'STT', index: 'STT', width: "0%", editable: false, align: 'left', hidden: true},
            ],
            loadonce: false,
            scroll: 1,
            modal: true,
            rowNum: 100,
            rowList: [30, 50, 70],
            pager: '#prowed3',
            height: 100,
            width: 100,
            viewrecords: true,
            ignoreCase: true,
            shrinkToFit: true,
			//grid_save_option: "",
			grouping:true, 
		  	groupingView : { 
			groupField : ['IDNhomCha'],
			groupDataSorted : true ,
			groupCollapse : false,
			groupColumnShow :false,
			//groupOrder: ['DESC'],
			groupText : ['<b>{0}</b>']
		 	 }, 
			afterShowForm : function (formid) {
				
			},
            onSelectRow: function(id) {
				var luot= $("#soluotchon").val();
				$("#soluotchon").val(1);
				if(luot==1){
					document.getElementById("xemtatca").checked=false;
				}
				
				var rowData = jQuery(this).getRowData(id); 
				var ID_NhomCLS = rowData['ID_NhomCLS'];// alert(ID_LuotKham);				
				$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_hangmucloaikham_idnhomcls&id="+ID_NhomCLS}).trigger('reloadGrid');
				 
            },
            ondblClickRow: function(rowId, rowIndex, columnIndex) {
				if(window.idtodieutrichitiet==''){
					chuyen2();
				}else{
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_ylenh&id_todieutrichitiet='+window.idtodieutrichitiet).done(function(data){
						if(data=="true"){
							chuyen2();	
						}else{
							tooltip_message("Y lệnh bác sỹ đã cho phép thực hiện hoặc đã hoàn tất");
						}
					});
				}
            },
            onselect: function(rowId, rowIndex, columnIndex) { 
              
            },
            loadComplete: function(data) {		
			//ids = $('#rowed3').jqGrid('getDataIDs');				 
			//$("#rowed3").jqGrid("setSelection",ids[0], true);
				
			 var i, groups = $(this).jqGrid("getGridParam", "groupingView").groups,
			 l = groups.length,
			 idSelectorPrefix = "#" + this.id + "ghead_0_";
			 for (i = 0; i < l; i++) {
				 if (groups[i].cnt === 1) {
					 $(idSelectorPrefix + i).hide();
				 }
			 }
					$("#gs_TenLoaiKham").focus();
					$("#rowed3").unbind("keydown")
					$("#rowed3").jqGrid('bindKeys', {});
					$("#rowed3").bind("keydown",function(event) {	
						var keycode = (event.keyCode ? event.keyCode : event.which);
						if(keycode == '13'){
							var tmp = $("#rowed4").jqGrid('getDataIDs'); 
							if(tmp.length==1){
								var id = $("#rowed3").jqGrid ('getGridParam', 'selrow');
								$("#rowed3 #"+id).dblclick();
							}else{
								$("#gs_TenLoaiKham").focus();
								}
						}
					 })
			},
            caption: "Nhóm loại khám"
        });
        $("#rowed3").jqGrid('navGrid', "#prowed3", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
	$("#rowed3").jqGrid('bindKeys', {});
    }
    function create_grid2(){
		mydata=[];
        $("#rowed4").jqGrid({
            data: mydata,
            datatype: "local",
            colNames: ['GiaThueNgoaiThucHien', 'ThoiGianTrungBinhThucHien', 'ID_DMLoaiKham_Phongban','ID_LoaiKham', 'Tên loại khám', 'Đ.Giá V.phí','Đ.Giá BHYT','Phụ thu'],
            colModel: [
				{name: 'GiaThueNgoaiThucHien', index: 'GiaThueNgoaiThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ThoiGianTrungBinhThucHien', index: 'ThoiGianTrungBinhThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ID_DMLoaiKham_Phongban', index: 'ID_DMLoaiKham_Phongban', search: false, width: "30%", editable: false, align: 'left', hidden: true},
                {name: 'ID_LoaiKham', index: 'ID_LoaiKham', search: false, width: "0%", editable: false, align: 'left', hidden: true},
                {name: 'TenLoaiKham', index: 'TenLoaiKham', search: true, width: "70%", editable: false, align: 'left', hidden: false},
				{name:'GiaBaoChoBN',index:'GiaBaoChoBN', width:"30%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name:'GiaTheoBaoHiem',index:'GiaTheoBaoHiem', width:"30%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name:'GiaPhuThu',index:'GiaPhuThu', width:"30%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},	            
				
				],
            loadonce: true,
            scroll: false,
            modal: true,
            shrinkToFit: true,
			grid_save_option: "",
            cmTemplate: {sortable: false},
            rowNum: 10000000,
            rowList: [],
            pager: '#prowed3',
            height: 100,
            width: 100,
            viewrecords: true,
            ignoreCase: true,
            sortorder: "desc",
			afterShowForm : function (formid) {

			},
			 onSelectRow: function(id) {
				
				
			 }
			,ondblClickRow: function(rowId, rowIndex, columnIndex) {
				if(window.idtodieutrichitiet==''){
					chuyen(rowId);
				}else{
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_ylenh&id_todieutrichitiet='+window.idtodieutrichitiet).done(function(data){
						if(data=="true"){
							chuyen(rowId);
						}else{
							tooltip_message("Y lệnh bác sỹ đã cho phép thực hiện hoặc đã hoàn tất");
						}
					});
				}
			},
            onRightClickRow: function(rowid, iRow, iCol, e) {

            },
            loadComplete: function(data) {
               grid_filter_enter("#rowed4");
			   $("#rowed4").unbind("keydown")
			   $("#rowed4").jqGrid('bindKeys', {});
			   $("#rowed4").bind("keydown",function(event) {	
				 			 
					 var keycode = (event.keyCode ? event.keyCode : event.which);
					 if(keycode == '13'){
						  var id = $("#rowed4").jqGrid ('getGridParam', 'selrow');
				
							$("#rowed4 #"+id).dblclick();
					//	}
					 }
					 })
            },
            caption: " Hạng mục loại khám <div id='xtc' style='float: right; top: 4px; right: 25px; position: absolute;'><input type='checkbox' id='xemtatca'  /> Xem tất cả</div>"

        });
		$("#rowed4").jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
        $("#rowed4").jqGrid('navGrid', "#prowed4", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
		$("#rowed4").jqGrid('bindKeys', {});
   }
function create_grid3(){
		mydata=[];
        $("#rowed5").jqGrid({
            data: mydata,
            datatype: "local",
            colNames: ['ID Loại Khám','Xóa','Loại khám', 'Đ.Giá Viện phí', 'Đ.Giá BHYT', 'Phụ thu', 'TT Viện phí', 'TT BHYT', 'Phí thực hiện', 'Trạng thái', 'Thực hiện', 'B.Phận thực hiện', 'Người chỉ định',  'GiaThueNgoaiThucHien',  'ThoiGianTrungBinhThucHien',  'IDKham',  'MaBenhNhan','LyDoHuyBo','huy',  'IDLuotKham','Luu','IDNhomCLS','NgayGioTao','Lần chỉ định','XetNghiem','ID_ToDieuTriChiTietKham','ID_Kham_Tam'],
            colModel: [
                {name: 'IDLoaiKham', index: 'IDLoaiKham', search: false, width: "10%", editable: false, align: 'left', hidden: true},
                {name: 'Xoa', index: 'Xoa', search: false, width: "6%", editable: false, align: 'left', hidden: false},
                {name: 'LoaiKham', index: 'LoaiKham', search: false, width: "20%", editable: false, align: 'left', hidden: false,classes:'loai_kham'},
                {name: 'DonGiaVienPhi', index: 'DonGiaVienPhi', search: false, width: "10%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'DonGiaBHYT', index: 'DonGiaBHYT', search: false, width: "10%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'PhuThu', index: 'PhuThu', search: false, width: "8%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'ThanhTienVienPhi', index: 'ThanhTienVienPhi', search: false, width: "11%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'ThanhTienBHYT', index: 'ThanhTienBHYT', search: false, width: "11%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
                {name: 'PhiThucHien', index: 'PhiThucHien', search: false, width: "11%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
                {name: 'TrangThai', index: 'TrangThai', search: false, width: "10%", editable: false, align: 'center', hidden: false,edittype:"select",formatter:'select',editoptions:{value: trangthai}},
                {name: 'ThucHien', index: 'ThucHien', search: false, width: "12%", editable: true, align: 'center', hidden: true,edittype:"select",formatter:'select',editoptions:{value:"0:Hospital;1:Home;2:Seft",dataEvents: [{ type: 'change keyup', fn: function(e) {
					var tmp5 = $("#rowed5").jqGrid('getDataIDs'); 
											var row = $(e.target).closest('tr.jqgrow');
                                            var rowId = row.attr('id');
										var id_loaikham =$('#rowed5').jqGrid('getCell',rowId,'IDLoaiKham');	
										var id_ncls =$('#rowed5').jqGrid('getCell',rowId,'IDNhomCLS');	
											var y=0;
											var yy=0;
											var n=0;
											var x=0;
											var a="";
												for(var i = 0; i < phuthu.length; i++) {							
												if(phuthu[i]['id'] == id_loaikham) {											
													 y=i;
													 break;
												}
											}
											for(var k = 0; k < tmp5.length; k++){
												var rowData = $("#rowed5").getRowData(tmp5[k]);
												if((rowData["IDNhomCLS"]==17)&&(x==0)&&($('#'+tmp5[k]+'_ThucHien').val()==1)){
													window.id_rowcls2=tmp5[k];
													//window.id_rowcls=tmp5[k];
													x++;
												}
											}
											var x=0;
											for(var l = 0; l < phuthu.length; l++) {	
												if((parseInt(phuthu[l]['id'])==parseInt(id_loaikham)) && (parseInt(phuthu[l]['ID_NhomCLS'])==17) && (x==0)){
													n=l;
													x++;
													break;
													}
											}
							var thuchien=$('#'+rowId+'_ThucHien').val()
							if((phuthu[i]['DieuTriTaiNha']!=1)&& (thuchien==1)){
								$('#'+rowId+'_ThucHien').val(0);
								$('#'+rowId+'_ThucHien').change();
								alert("Hạng mục khám này không cho phép thực hiện tại nhà");
								
							}else{
							if(thuchien==0){
								 if((window.loaidoituongkham=="Bảo hiểm y tế") && (phuthu[i]["GiaBaoHiem"]>0 )){
									window.thanhtien_vienphi=0;
									window.thanhtien_bhyt=parseInt(phuthu[i]["GiaBaoHiem"])+parseInt(phuthu[i]["GiaPhuThuBenhVien"]);
									window.phithuchien=parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
									}else{
										window.thanhtien_vienphi=phuthu[i]["GiaBaoChoBN"];
										window.thanhtien_bhyt=0;
										window.phithuchien=phuthu[i]["GiaBaoChoBN"];
									}
									
								$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);
							}else if(thuchien==1){
								if (typeof id_rowcls2 === 'undefined')
								{
									if((window.loaidoituongkham=="Bảo hiểm y tế") && (parseFloat(phuthu[i]["GiaBaoHiem"])>0 )){
							  	
									window.thanhtien_vienphi=0;
									window.thanhtien_bhyt=parseInt(phuthu[i]["GiaBaoHiem"])+parseInt(phuthu[i]["GiaPhuThuBenhVien"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']);
									window.phithuchien=parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
									//alert(thanhtien_bhyt);
								
									}else{
										window.thanhtien_vienphi=+parseInt(phuthu[i]["GiaBaoChoBN"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']);
										window.thanhtien_bhyt=0;
										window.phithuchien= parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
									}
									
							$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);
									
								}else if(id_rowcls2){
									for(var i = 0; i< tmp5.length; i++){
										var rowData = $("#rowed5").getRowData(tmp5[i]);
										if((rowData["IDNhomCLS"]==17)&& (tmp5[i]!=rowId) && (id_ncls==17) && ($('#'+tmp5[i]+'_ThucHien').val()!=2)){
											$('#'+tmp5[i]+'_ThucHien').val(0);
											$('#'+tmp5[i]+'_ThucHien').change();
													
										}
									}
									if(id_rowcls2==rowId){
											if((window.loaidoituongkham=="Bảo hiểm y tế") && (parseInt(phuthu[n]["GiaBaoHiem"])>0 )){
											window.thanhtien_vienphi=0;
											window.thanhtien_bhyt=parseInt(phuthu[n]["GiaBaoHiem"])+parseInt(phuthu[n]["GiaPhuThuBenhVien"])+parseInt(phuthu[n]['PhuThuThucHienTaiNha']);
											window.phithuchien=parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
											
											}else{
												window.thanhtien_vienphi=+parseInt(phuthu[n]["GiaBaoChoBN"])+parseInt(phuthu[n]['PhuThuThucHienTaiNha']);
												window.thanhtien_bhyt=0;
												window.phithuchien= parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
											}
										$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);
									}
									else{
										if((window.loaidoituongkham=="Bảo hiểm y tế") && (parseFloat(phuthu[i]["GiaBaoHiem"])>0 )){
											window.thanhtien_vienphi=0;
											window.thanhtien_bhyt=parseInt(phuthu[i]["GiaBaoHiem"])+parseInt(phuthu[i]["GiaPhuThuBenhVien"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']);
											window.phithuchien=parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
										
											}else{
												window.thanhtien_vienphi=+parseInt(phuthu[i]["GiaBaoChoBN"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']);
												window.thanhtien_bhyt=0;
												window.phithuchien= parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
											}
										$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);	
									}
								}
								else{
										if((window.loaidoituongkham=="Bảo hiểm y tế") && (parseFloat(phuthu[i]["GiaBaoHiem"])>0 )){
									
										window.thanhtien_vienphi=0;
										window.thanhtien_bhyt=parseInt(phuthu[i]["GiaBaoHiem"])+parseInt(phuthu[i]["GiaPhuThuBenhVien"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']);
										window.phithuchien=parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
										}else{
											window.thanhtien_vienphi=+parseInt(phuthu[i]["GiaBaoChoBN"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']);
											window.thanhtien_bhyt=0;
											window.phithuchien= parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
										}
									$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);
								}
							}else{
								$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', 0);
								}
							}
							  	var tt_bhyt =0;
								var tt_vienphi =0;
								var phithuchien =0;
								for(var i=0;i < tmp5.length;i++){ 
										var rowData = $("#rowed5").getRowData(tmp5[i]);
										tt_vienphi =parseFloat(tt_vienphi) + parseFloat(rowData["ThanhTienVienPhi"]);
										tt_bhyt =parseFloat(tt_bhyt) + parseFloat(rowData["ThanhTienBHYT"]);
										phithuchien =parseFloat(phithuchien) + parseFloat(rowData["PhiThucHien"]);
									}
								$("#thanhtienvienphi").val(formatMoney(tt_vienphi));
								$("#thanhtienbhyt").val(formatMoney(tt_bhyt));
								$("#phithuchien").val(formatMoney(phithuchien));
							
 } }]} },
  				{name: 'NhomThucHien', index: 'NhomThucHien', search: false, width: "20%", editable: true, align: 'center', hidden: false,edittype:"select",formatter:'select',editoptions:{value: bophanthuchien}, classes:'colNhomThucHien'},
				{name: 'NguoiChiDinh', index: 'NguoiChiDinh', search: false, width: "10%", editable: false, align: 'center', hidden: false,edittype:"select",formatter:'select',editoptions:{value: nguoichidinh} },
			{name: 'GiaThueNgoaiThucHien', index: 'GiaThueNgoaiThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ThoiGianTrungBinhThucHien', index: 'ThoiGianTrungBinhThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDKham', index: 'IDKham', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'MaBenhNhan', index: 'MaBenhNhan', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'LyDoHuyBo', index: 'LyDoHuyBo', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'Huy', index: 'Huy', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDLuotKham', index: 'IDLuotKham', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'Luu', index: 'Luu', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDNhomCLS', index: 'IDNhomCLS', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'NgayGioTao', index: 'NgayGioTao', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'LanChiDinh', index: 'LanChiDinh', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'XetNghiem', index: 'XetNghiem', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'ID_ToDieuTriChiTietKham', index: 'ID_ToDieuTriChiTietKham', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'ID_Kham_Tam', index: 'ID_Kham_Tam', search: false, width: "10%", editable: false, align: 'left', hidden: true}
            ],
            loadonce: false,
            scroll: false,
            modal: true,
			rownumbers: true,
            shrinkToFit: true,
			grid_save_option: "",
            cmTemplate: {sortable: false},
            rowNum: 10000000,
			pginput:false,
			pgbuttons:false,
            rowList: [],
            pager: '#prowed5',
            sortname: 'ThoiGianVaoKham',
            height: 100,
            width: 100,
            viewrecords: true,
            ignoreCase: true,
            sortorder: "desc",
			afterShowForm : function (formid) {
				xuongdong(formid);
				lendong(formid);
			},
            loadComplete: function(data) {
				
              var tmp1 = $("#rowed5").jqGrid('getDataIDs'); 
			   	var tt_bhyt =0;
				var tt_vienphi =0;
				var phithuchien =0;
				 var x=0;
				window.canlamsang='';
				for(var i=0;i < tmp1.length;i++){ 
				jQuery("#rowed5").jqGrid('editRow',tmp1[i]);
					var rowData = $("#rowed5").getRowData(tmp1[i]);	
					/*if(rowData["TrangThai"]!="HuyBo"){
						if(window.canlamsang==''){
							window.canlamsang=rowData['LoaiKham'];
						}else{
							window.canlamsang=window.canlamsang+', '+rowData['LoaiKham'];
						}
					}*/
					xoa = "<input class=' custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp1[i]+"');\" />"; 
					$("#rowed5").jqGrid('setRowData',tmp1[i],{Xoa:xoa});
					$("#rowed5").jqGrid('setRowData', tmp1[i], false, { background: '#D3D3D3',border:'1px solid #A9A9AA' });
						tt_vienphi =parseFloat(tt_vienphi) + parseFloat(rowData["ThanhTienVienPhi"]);
						tt_bhyt =parseFloat(tt_bhyt) + parseFloat(rowData["ThanhTienBHYT"]);
						phithuchien =parseFloat(phithuchien) + parseFloat(rowData["PhiThucHien"]);
					  
					if(rowData["TrangThai"]=="HuyBo"){
						jQuery("#rowed5").jqGrid('saveRow',tmp1[i]);
						$("#rowed5").jqGrid('setRowData', tmp1[i], false, { background: '#A9A9AA',border:'1px solid #BBBBBB' });
					}
				}
				$("#thanhtienvienphi").val(formatMoney(tt_vienphi));
				$("#thanhtienbhyt").val(formatMoney(tt_bhyt));
				$("#phithuchien").val(formatMoney(phithuchien));
				
				//$("#tonghopylenh").val("Cận lâm sàng: "+window.canlamsang+"\nĐiều trị phối hợp: "+window.dieutriphoihop+"\nĐơn thuốc: "+window.donthuoc+"\nĐơn thuốc trả lại: "+window.donthuoctralai+"\nY lệnh khác: "+$("#ylenhkhac").val());   
			         },
            caption: " Hạng mục loại khám được chọn"
        });
       $("#rowed5").jqGrid('navGrid', "#prowed5", {add: false, edit: false, del: false, search: false, refresh: false,prmView: false, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
		$("#rowed5").jqGrid('bindKeys', {});
    }
	
	function create_goikham() {
        $("#data_goikham").jqGrid({
            url: 'resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_ylenh_lamsang_goikham',
            datatype: "json",
            colNames: ['Id gói khám','Tên gói khám', 'Số tiền dự kiến', 'Mô tả', 'Ghi chú'],
            colModel: [
                {name: 'ID_GoiKham', index: 'ID_GoiKham', width: "0%", editable: false, align: 'left', hidden: true},
                {name: 'TenGoiKham', index: 'TenGoiKham', search: false, width: "30%", editable: false, align: 'left', hidden: false},
				{name: 'SoTienDuKien', index: 'SoTienDuKien', width: "15%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'MoTa', index: 'MoTa', search: false, width: "15%", editable: false, align: 'left', hidden: false},
				{name: 'GhiChu', index: 'GhiChu', width: "40%", editable: false, align: 'left', hidden: false},
            ],
           		loadonce: true,
				scroll: 1,	 
				modal:true,	 	
				pager: '#pdata_goikham',	
				rowNum: 100,
				gridview: true,
				pginput:false,
				pgbuttons:false,
				rowList:[],
				sortname: 'ID_GoiKham',
				height:100,
				width: 100,
				viewrecords: true,	
				ignoreCase:true,
				shrinkToFit:true,
				grouping: false,
				stringResult:true,
				sortorder: "asc",
			afterShowForm : function (formid) {

			},
            onSelectRow: function(id) {
				if (id !== lastsel) {
                    $("#data_goikham").jqGrid('restoreRow', lastsel);
                    $(data_goikham).jqGrid('editRow', id, true);
                    lastsel = id;
                } else {
                    $("#data_goikham").jqGrid('restoreRow', lastsel);
                    lastsel = "";
                    //alert(id)
                }
			var rowData = jQuery(this).getRowData(id); 
			var ID_GoiKham = rowData['ID_GoiKham'];// alert(ID_LuotKham);				
			$("#data_loaikham").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_loaikham_by_idgoikham&id="+ID_GoiKham}).trigger('reloadGrid');
             
            },
            ondblClickRow: function(rowId, rowIndex, columnIndex) {
            
            },
            onselect: function(rowId, rowIndex, columnIndex) {
              
            },
        
            loadComplete: function(data) {
			ids = $('#data_goikham').jqGrid('getDataIDs');				 
			$("#data_goikham").jqGrid("setSelection",ids[0], true);
			},
            caption: "Gói khám"
        });
        $("#data_goikham").jqGrid('navGrid', "#pdata_goikham", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
	$("#data_goikham").jqGrid('bindKeys', {});
    }
	
	function create_loaikham(){
		mydata=[];
        $("#data_loaikham").jqGrid({
            data: mydata,
            datatype: "local",
            colNames: ['Id gói khám','Tên loại khám',  'Đơn giá Viện phí','Đơn giá BHYT','Phụ thu', 'Mô tả',  'GiaThueNgoaiThucHien',  'ThoiGianTrungBinhThucHien',  'IDLuotKham',  'IDPhongChuyenMon',  'MaBenhNhan',  'ID_NhomCLS',  'ID_DMLoaiKham_Phongban'],
            colModel: [
				{name: 'ID_LoaiKham', index: 'ID_LoaiKham', width: "0%", editable: false, align: 'left', hidden: true},
                {name: 'TenLoaiKham', index: 'TenLoaiKham', search: false, width: "30%", editable: false, align: 'left', hidden: false},
				{name:'GiaBaoChoBN',index:'GiaBaoChoBN', width:"10%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name:'GiaTheoBaoHiem',index:'GiaTheoBaoHiem', width:"10%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name:'GiaPhuThu',index:'GiaPhuThu', width:"10%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},	
				{name: 'GhiChu', index: 'GhiChu', search: false, width: "40%", editable: false, align: 'left', hidden: false},
				{name: 'GiaThueNgoaiThucHien', index: 'GiaThueNgoaiThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ThoiGianTrungBinhThucHien', index: 'ThoiGianTrungBinhThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDLuotKham', index: 'IDLuotKham', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDPhongChuyenMon', index: 'IDPhongChuyenMon', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'MaBenhNhan', index: 'MaBenhNhan', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ID_NhomCLS', index: 'ID_NhomCLS', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ID_DMLoaiKham_Phongban', index: 'ID_DMLoaiKham_Phongban', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				
            ],
           loadonce: false,
            scroll: 1,
            modal: true,
            rowNum: 100,
			multiselect: true,
            rowList: [30, 50, 70],
            pager: '#pdata_goikham',
            height: 100,
            width: 100,
            viewrecords: true,
            ignoreCase: true,
            shrinkToFit: true,
			grid_save_option: "",
			cmTemplate: {
			sortable: false
},
			afterShowForm : function (formid) {

			},
            onSelectRow: function(id) {
				if (id !== lastsel) {
                    $("#data_goikham").jqGrid('restoreRow', lastsel);
                    $(data_goikham).jqGrid('editRow', id, true);
                    lastsel = id;
                } else {
                    $("#data_goikham").jqGrid('restoreRow', lastsel);
                    lastsel = "";
                }
             
            },
            ondblClickRow: function(rowId, rowIndex, columnIndex) {
            
            },
            onselect: function(rowId, rowIndex, columnIndex) {
              
            },
        
            loadComplete: function(data) {
			grid_filter_enter("#data_loaikham");
			},
            caption: "Loại khám"
        });
        $("#data_goikham").jqGrid('navGrid', "#pdata_goikham", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
	$("#data_loaikham").jqGrid('bindKeys', {});
    }
    function create_layout() {
        $('#panel_main').layout({
            resizerClass: 'ui-state-default'
                    , east: {
                resizable: true
                        , size: "63%"
                        , spacing_closed: 27
                        , togglerLength_closed: 85
                        , togglerAlign_closed: "center"
                        , togglerContent_closed: "<div id='menu_toggle'>X<BR>O<BR>N<BR>G</div>"
                        , togglerTip_closed: "Open & Pin Menu"
                        , sliderTip: "Slide Open Menu"
                        , slideTrigger_open: "mouseover"
                        , fxSettings_close: {easing: "easeOutQuint"}
                , onresize_end: function() {
                    resize_control();

                }
                , onopen_end: function() {


                }
                , onclose_end: function() {


                }

            }
            , center: {
                resizable: true
                        , size: "25%"
                        , fxName: "drop"		// none, slide, drop, scale
                        , fxSpeed_open: 450
                        , fxSpeed_close: 450
                        , fxSettings_open: {easing: "easeInQuint"}
                , fxSettings_close: {easing: "easeOutQuint"}

                , onresize_end: function() {
                    resize_control();
                }
                , onopen_end: function() {

                }
                , onclose_end: function() {

                }
            }
			 , west:  {
                resizable: true
                        , size: "12%"
                        , spacing_closed: 27
                        , togglerLength_closed: 85
                        , togglerAlign_closed: "center"
                        , togglerContent_closed: "<div id='menu_toggle'>X<BR>O<BR>N<BR>G</div>"
                        , togglerTip_closed: "Open & Pin Menu"
                        , sliderTip: "Slide Open Menu"
                        , slideTrigger_open: "mouseover"
                        , fxSettings_close: {easing: "easeOutQuint"}
                , onresize_end: function() {
                    resize_control();

                }
                , onopen_end: function() {


                }
                , onclose_end: function() {


                }

            }
        });
    }
	
function n_xoa(tam){
	if(tam == parseInt(tam)){
		var rowData_check = $("#rowed5").getRowData(tam);
		if(rowData_check["TrangThai"]!='HuyBo'){
			$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_kham_cls&id_todieutrichitietkham='+tam).done(function(data){
				if(data=="true"){	
					var rowData_luu = $("#rowed5").getRowData(tam);
						if(rowData_luu["Luu"]!=1){
							$('#rowed5').jqGrid('delRowData',tam);
							var tmp5 = $("#rowed5").jqGrid('getDataIDs'); 
							var tt_bhyt =0;
							var tt_vienphi =0;
							var phithuchien =0;
							for(var i=0;i < tmp5.length;i++){ 
								var rowData = $("#rowed5").getRowData(tmp5[i]);
								xoa = "<input class=' custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp5[i]+"');\" />"; 
								$("#rowed5").jqGrid('setRowData',tmp5[i],{Xoa:xoa});	
								tt_vienphi =parseFloat(tt_vienphi) + parseFloat(rowData["ThanhTienVienPhi"]);
								tt_bhyt =parseFloat(tt_bhyt) + parseFloat(rowData["ThanhTienBHYT"]);
								phithuchien =parseFloat(phithuchien) + parseFloat(rowData["PhiThucHien"]);
							}
							$("#thanhtienvienphi").val(formatMoney(tt_vienphi));
							$("#thanhtienbhyt").val(formatMoney(tt_bhyt));
							$("#phithuchien").val(formatMoney(phithuchien));
					}else{
						var rowData2 = $("#rowed5").getRowData(tam);
						if(rowData2["TrangThai"]!="HuyBo"){
							$("#idk").val(tam);
							$("#dialog_confirm_cls_huybo").dialog('open'); 
						}
					}
				}else{
					tooltip_message("Loại khám này đã thực hiện");
				}				
			});
		}
	}else{
		$('#rowed5').jqGrid('delRowData',tam);
	}
}
	
function load_select_hotennv(){
	window.hotennv = $.ajax({url: "resource.php?module=web_services&function=get_auto_edit_option_byid&action=index&term=ID_PhongBan<>21&status=2&tables=DM_NhanVien&id=ID_NhanVien&name=NickName", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục nhân viên');}}).responseText;	
}
function load_select_bophanthuchien(){ 
	window.bophanthuchien = $.ajax({url: "resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_ylenh_lamsang_phongban", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục phòng ban');}}).responseText;
}

	function load_select_trangthai(){
	window.trangthai = $.ajax({url: "resource.php?module=web_services&function=get_auto_edit_option&action=index&term=&status=2&tables=DM_TrangThaiCLSCuaBenhNhan&id=ID4Dev&name=TenTrangThaiCLSCuaBenhNhan", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục trạng thái');}}).responseText;	
}
function load_select_nguoichidinh(){
	window.nguoichidinh = $.ajax({url: 'resource.php?module=web_services&function=get_auto_edit_option&action=index&term=&status=2&tables=DM_NhanVien&id=ID_NhanVien&name=NickName', async: false, success: function(data, result) {if (!result) alert('Không load được danh mục nhân viên');}}).responseText;
	
	$("#rowed5").setColProp('#NguoiChiDinh', { editoptions: { value: nguoichidinh} });
	$('#NguoiChiDinh').empty();
	create_select("#NguoiChiDinh",nguoichidinh);
}
function load_select_tennhomcha(){
	window.tennhomcha = $.ajax({url: "resource.php?module=web_services&function=get_auto_edit_option&action=index&term=&status=2&tables=NhomCLS&id=ID_NhomCLS&name=TenNhom", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;	
}
function formatMoney(num) {
    var p = num.toFixed(2).split(".");
    return p[0].split("").reverse().reduce(function(acc, num, i, orig) {
        return  num + (i && !(i % 3) ? "," : "") + acc;
    }, "");
}
function chuyen(aa){
	//alert(window.n_idtrangthai);
	//if(window.n_idtrangthai!='KetThucKham'){
				var tmp1 = $("#rowed5").jqGrid('getDataIDs'); 
				 var tam,ln=0;
				 var dem=tmp1+1;
				 var rowData = jQuery("#rowed4").getRowData(aa);
				var selRowId = $("#rowed3").jqGrid ('getGridParam', 'selrow');
				 if((window.loaidoituongkham=="Bảo hiểm y tế") && (rowData["GiaTheoBaoHiem"]>0 )){
						var thanhtien_vienphi=0;
						var thanhtien_bhyt=parseInt(rowData["GiaTheoBaoHiem"])+parseInt(rowData["GiaPhuThu"]);
						var phi_thuchien=parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
					
					}else{
						var thanhtien_vienphi=rowData["GiaBaoChoBN"];
						var thanhtien_bhyt=0;
						var phi_thuchien=rowData["GiaBaoChoBN"];
						}
						var celValue = $("#rowed3").getRowData(selRowId); //
					$.get( "resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=ylenh_lamsang_check_phongban&ac=check&id_loaikham="+rowData["ID_LoaiKham"]+"&ds_tang="+window.new_ds_tang, function( data ) {
						parameters =
								{
									initdata : {IDLoaiKham:rowData["ID_LoaiKham"],Xoa:"Xóa",LoaiKham:rowData["TenLoaiKham"],DonGiaVienPhi:rowData["GiaBaoChoBN"],DonGiaBHYT:rowData["GiaTheoBaoHiem"],PhuThu:rowData["GiaPhuThu"],ThanhTienVienPhi:thanhtien_vienphi, ThanhTienBHYT:thanhtien_bhyt,PhiThucHien:phi_thuchien,TrangThai:"DangCho",ThucHien: "0",NguoiChiDinh:"<?=$_SESSION["user"]["id_user"] ?>",GiaThueNgoaiThucHien:rowData["GiaThueNgoaiThucHien"],ThoiGianTrungBinhThucHien:rowData["ThoiGianTrungBinhThucHien"],IDLuotKham:window.idluotkham,IDPhongChuyenMon:$("#idphongbanchuyenmon").val(),MaBenhNhan:$("#mabenhnhan").val(),IDNhomCLS:celValue["ID_NhomCLS"],NhomThucHien:data,},
									position :"last",
									useDefValues : false,
									useFormatter : false,
									addRowParams : {extraparam:{}}
								}
					var tmp2 = $("#rowed5").jqGrid('getDataIDs'); 
					var dem=0;
					var tontai=0;
				
					if(tmp2.length==0)
						dem=1;
					for(var i=0;i < tmp2.length;i++){
						var rowData2 = $("#rowed5").getRowData(tmp2[i]);	
						if(parseInt(rowData["ID_LoaiKham"])===parseInt(rowData2["IDLoaiKham"])){
							tontai=1;
						}
						else{
							if(tontai==0){
								dem=1;
							}
						}
					} //end for
							if(tontai==1){
							var strconfirm = confirm("Loại khám: "+rowData["TenLoaiKham"]+" đã tồn tại, bạn có muốn chỉ định thêm không?");
							if (strconfirm == true){
								dem=1;							
							}else{
								dem=0;
								$("#"+aa).focus();
							}
						}
					if(dem==1){
						if(rowData["ID_LoaiKham"]==3918)
							alert("Để có đủ thông tin làm FRAMINGHAM, vui lòng chỉ định thêm hạng \n mục ĐO ĐIỆN TIM và các xét nghiệm có liên quan!");
						jQuery("#rowed5").jqGrid('addRow',parameters);
						$("#gs_TenLoaiKham").focus();
						$("#gs_TenLoaiKham").select();
					}
					var tt_bhyt =0;
					var tt_vienphi =0;
					var phithuchien =0;
					var y=0;
					var x=0;
					var tmp3= $("#rowed5").jqGrid('getDataIDs'); 
					for(var i=0;i < tmp3.length;i++){ 
							var rowData3 = $("#rowed5").getRowData(tmp3[i]);	
							xoa = "<input class=' custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp3[i]+"');\" />"; 
							$("#rowed5").jqGrid('setRowData',tmp3[i],{Xoa:xoa});
							 tt_vienphi =parseFloat(tt_vienphi) + parseFloat(rowData3["ThanhTienVienPhi"]);
							 tt_bhyt =parseFloat(tt_bhyt) + parseFloat(rowData3["ThanhTienBHYT"]);
							 phithuchien =parseFloat(phithuchien) + parseFloat(rowData3["PhiThucHien"]);
						
							if((rowData3["IDNhomCLS"]==17)&&(y==0)&&($('#'+tmp3[i]+'_ThucHien').val()==1)){
								window.id_rowcls=tmp3[i];
								y++;
							}
							if((rowData3["IDNhomCLS"]==17)&&(x==0)){
								window.id_rowcls2=tmp3[i];
								x++;
							}
						}
					
					$("#thanhtienvienphi").val(formatMoney(tt_vienphi));
					$("#thanhtienbhyt").val(formatMoney(tt_bhyt));
					$("#phithuchien").val(formatMoney(phithuchien));
				});
	//}
}//end func
function chuyen2(){
 //if(window.n_idtrangthai!='KetThucKham'){
	var tmp = $("#rowed4").jqGrid('getDataIDs'); 
	for (var i = 0; i < tmp.length; i++){
		var id = tmp[i];
		var rowData = jQuery('#rowed4').jqGrid ('getRowData', id);
	}
if(tmp.length==1){
	var tmp1 = $("#rowed5").jqGrid('getDataIDs'); 
	 var tam,ln=0;
	 var dem=tmp1+1;
	  var selRowId = $("#rowed3").jqGrid ('getGridParam', 'selrow');
	   if((window.loaidoituongkham=="Bảo hiểm y tế") && (rowData["GiaTheoBaoHiem"]>0 )){
			var thanhtien_vienphi=0;
			var thanhtien_bhyt=parseInt(rowData["GiaTheoBaoHiem"])+parseInt(rowData["GiaPhuThu"]);
			var phi_thuchien=parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
		}else{
			var thanhtien_vienphi=rowData["GiaBaoChoBN"];
			var thanhtien_bhyt=0;
			var phi_thuchien=rowData["GiaBaoChoBN"];
		}
	 var celValue = $("#rowed3").getRowData(selRowId);
	 $.get( "resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=ylenh_lamsang_check_phongban&ac=check&id_loaikham="+rowData["ID_LoaiKham"]+"&ds_tang="+window.new_ds_tang, function( data ) {	
		parameters ={
			initdata : {IDLoaiKham:rowData["ID_LoaiKham"],Xoa:"Xóa",LoaiKham:rowData["TenLoaiKham"],DonGiaVienPhi:rowData["GiaBaoChoBN"],DonGiaBHYT:rowData["GiaTheoBaoHiem"],PhuThu:rowData["GiaPhuThu"],ThanhTienVienPhi:thanhtien_vienphi, ThanhTienBHYT:thanhtien_bhyt,PhiThucHien:phi_thuchien,TrangThai:"DangCho",ThucHien: "0",NguoiChiDinh:"<?=$_SESSION["user"]["id_user"] ?>",GiaThueNgoaiThucHien:rowData["GiaThueNgoaiThucHien"],ThoiGianTrungBinhThucHien:rowData["ThoiGianTrungBinhThucHien"],IDLuotKham:window.idluotkham,MaBenhNhan:$("#mabenhnhan").val(),IDNhomCLS:celValue["ID_NhomCLS"],NhomThucHien:data},
			position :"last",
			useDefValues : false,
			useFormatter : false,
			addRowParams : {extraparam:{}}
		}
		var tmp2 = $("#rowed5").jqGrid('getDataIDs'); 
		var dem=0;
		var tontai=0;
		
		if(tmp2.length==0)
			dem=1;
		for(var i=0;i < tmp2.length;i++){
			var rowData2 = $("#rowed5").getRowData(tmp2[i]);	
			if(rowData["ID_LoaiKham"]==rowData2["IDLoaiKham"]){
				tontai=1;
			var strconfirm = confirm("Loại khám: "+rowData["TenLoaiKham"]+" đã tồn tại, bạn có muốn chỉ định thêm không?", "Cảnh báo");
				if (strconfirm == true){
					dem=1;
				}else{
					dem=0;
				}
				break;
			}
			else{
				if(tontai==0){
					dem=1;
				}
			}
		} //end for
		if(dem==1){
			if(rowData["ID_LoaiKham"]==3918)
				alert("Để có đủ thông tin làm FRAMINGHAM, vui lòng chỉ định thêm hạng \n mục ĐO ĐIỆN TIM và các xét nghiệm có liên quan!");
			jQuery("#rowed5").jqGrid('addRow',parameters);
		}
		var tmp1 = $("#rowed5").jqGrid('getDataIDs'); 
		var tt_bhyt =0;
		var tt_vienphi =0;
		var phithuchien =0;
		for(var i=0;i < tmp1.length;i++){ 
				var rowData3 = $("#rowed5").getRowData(tmp1[i]);	
				xoa = "<input class=' custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp1[i]+"');\" />"; 
				$("#rowed5").jqGrid('setRowData',tmp1[i],{Xoa:xoa});				
				 tt_vienphi =parseFloat(tt_vienphi) + parseFloat(rowData3["ThanhTienVienPhi"]);
				 tt_bhyt =parseFloat(tt_bhyt) + parseFloat(rowData3["ThanhTienBHYT"]);
				 phithuchien =parseFloat(phithuchien) + parseFloat(rowData3["PhiThucHien"]);
			}
		$("#thanhtienvienphi").val(formatMoney(tt_vienphi));
		$("#thanhtienbhyt").val(formatMoney(tt_bhyt));
		$("#phithuchien").val(formatMoney(phithuchien));
	});
	}
 //}
}//end func

function chuyen3(na,nb){
 // if(window.n_idtrangthai!='KetThucKham'){
	var tmp2 = $("#rowed5").jqGrid('getDataIDs');
	   var rowData = jQuery('#data_loaikham').jqGrid ('getRowData', na);
	   if((window.loaidoituongkham=="Bảo hiểm y tế") && (rowData["GiaTheoBaoHiem"]>0 )){
			var thanhtien_vienphi=0;
			var thanhtien_bhyt=parseInt(rowData["GiaTheoBaoHiem"])+parseInt(rowData["GiaPhuThu"]);
			var phithuchien=parseInt(thanhtien_vienphi)+parseInt(thanhtien_bhyt);
		}else{
			var thanhtien_vienphi=rowData["GiaBaoChoBN"];
			var thanhtien_bhyt=0;
			var phithuchien=rowData["GiaBaoChoBN"];
		}
	   parameters =
		{
			initdata : {IDLoaiKham:rowData["ID_LoaiKham"],Xoa:"Xóa",LoaiKham:rowData["TenLoaiKham"],DonGiaVienPhi:rowData["GiaBaoChoBN"],DonGiaBHYT:rowData["GiaTheoBaoHiem"],PhuThu:rowData["GiaPhuThu"],ThanhTienVienPhi:thanhtien_vienphi, ThanhTienBHYT:thanhtien_bhyt,PhiThucHien:phithuchien,TrangThai:"DangCho",ThucHien: "0",NguoiChiDinh:"<?=$_SESSION["user"]["id_user"] ?>",GiaThueNgoaiThucHien:rowData["GiaThueNgoaiThucHien"],ThoiGianTrungBinhThucHien:rowData["ThoiGianTrungBinhThucHien"],IDLuotKham:window.idluotkham,IDPhongChuyenMon:$("#idphongbanchuyenmon").val(),MaBenhNhan:$("#mabenhnhan").val(),IDNhomCLS:rowData["ID_NhomCLS"],NhomThucHien:nb},
			position :"last",
			useDefValues : false,
			useFormatter : false,
			addRowParams : {extraparam:{}}
		}
		
		var tmp4 = $("#rowed5").jqGrid('getDataIDs'); 
		var dem=0;
		var tontai=0;
		if(tmp4.length==0){
			dem=1;
		}else{
		for(var j=0;j < tmp4.length;j++){
			var rowData2 = $("#rowed5").getRowData(tmp4[j]);	
			if(rowData["ID_LoaiKham"]==rowData2["IDLoaiKham"]){
				tontai=1;
			var strconfirm = confirm("Loại khám: "+rowData["TenLoaiKham"]+" đã tồn tại, bạn có muốn chỉ định thêm không?");
				if (strconfirm == true){
					dem=1;
				}else{
					dem=0;
				}
				break;
			}
			else{
				if(tontai==0){
					dem=1;
				}
			}
			
		} //end for
		}
		if(dem==1){
			jQuery("#rowed5").jqGrid('addRow',parameters);
			
		}
 // }
}//end func
//end lam sang

//dieu tri phoi hop

 function dtph_create_grid() {
        $("#dtph_rowed3").jqGrid({
            url: 'resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_ylenh_dieutriphoihop_nhomloaikham',
            datatype: "json",
            colNames: ['id nhóm cha','id nhóm', 'Khám lâm sàn', 'Tên nhóm cha'],
            colModel: [
                {name: 'IDNhomCha', index: 'IDNhomCha', width: "0%", editable: false, align: 'left', hidden: true,edittype:"select",formatter:'select',editoptions:{value: tennhomcha}},
				{name: 'ID_NhomCLS', index: 'ID_NhomCLS', width: "10%", editable: false, align: 'left', hidden: true},
                {name: 'TenNhom', index: 'TenNhom', search: false, width: "30%", editable: false, align: 'left', hidden: false},
				{name: 'TenNhomCha', index: 'TenNhomCha', width: "10%", editable: false, align: 'left', hidden: true},
				//{name: 'STT', index: 'STT', width: "0%", editable: false, align: 'left', hidden: true},
            ],
           loadonce: false,
            scroll: 1,
            modal: true,
            rowNum: 100,
            rowList: [30, 50, 70],
            pager: '#pdtph_rowed3',
            //sortname: 'NgayGioKetThuc',
            height: 100,
            width: 100,
            viewrecords: true,
            ignoreCase: true,
            shrinkToFit: true,
			//grid_save_option: "",
			grouping:true, 
		  	groupingView : { 
			groupField : ['IDNhomCha'],
			groupDataSorted : true ,
			groupCollapse : false,
			groupColumnShow :false,
			//groupOrder: ['DESC'],
			groupText : ['<b>{0}</b>']
		 	 }, 
			afterShowForm : function (formid) {
			},
            onSelectRow: function(id) {
				var rowData = jQuery(this).getRowData(id); 
				var ID_NhomCLS = rowData['ID_NhomCLS'];// alert(ID_LuotKham);				
				$("#dtph_rowed4").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_dieutriphoihop_hangmucloaikham_idnhomcls&id="+ID_NhomCLS}).trigger('reloadGrid');
            },
            ondblClickRow: function(rowId, rowIndex, columnIndex) {
				if(window.idtodieutrichitiet==''){
					var tmp = $("#dtph_rowed4").jqGrid('getDataIDs'); 
					for (var i = 0; i < tmp.length; i++){
						var id = tmp[i];
						var rowData = jQuery('#dtph_rowed4').jqGrid ('getRowData', id);
					}
					//alert(tmp.length);
					if(tmp.length==1){
					var tmp1 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
					 var tam,ln=0;
					 for(var l=0;l<tmp1.length;l++){
						 }
					 var dem=tmp1+1;
					  var selRowId = $("#dtph_rowed3").jqGrid ('getGridParam', 'selrow');
					 var celValue = $("#dtph_rowed3").getRowData(selRowId);
						parameters =
						{
							initdata : {IDLoaiKham:rowData["ID_LoaiKham"],Xoa:"Xóa",LoaiKham:rowData["TenLoaiKham"],dtph_thanhtien:rowData["GiaBaoChoBN"],dtph_phithuchien:rowData["GiaBaoChoBN"],TrangThai:"DangCho",ThucHien: "0",NguoiChiDinh:"<?=$_SESSION["user"]["id_user"] ?>",NhanVienDuocChiDinhTH:"",NguoiThucHien:"",GiaThueNgoaiThucHien:rowData["GiaThueNgoaiThucHien"],ThoiGianTrungBinhThucHien:rowData["ThoiGianTrungBinhThucHien"],IDLuotKham:$("#idluotkham").val(),IDPhongChuyenMon:$("#idphongbanchuyenmon").val(),MaBenhNhan:$("#mabenhnhan").val(),IDNhomCLS:celValue["ID_NhomCLS"]},
							position :"last",
							useDefValues : false,
							useFormatter : false,
							addRowParams : {extraparam:{}}
						}
						var tmp2 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
						var dem=0;
						var tontai=0;
						
						if(tmp2.length==0)
							dem=1;
						for(var i=0;i < tmp2.length;i++){
							var rowData2 = $("#dtph_rowed5").getRowData(tmp2[i]);	
							if(rowData["ID_LoaiKham"]==rowData2["IDLoaiKham"]){
								tontai=1;
							var strconfirm = confirm("Loại khám: "+rowData["TenLoaiKham"]+" đã tồn tại, bạn có muốn chỉ định thêm không?", "Cảnh báo");
								if (strconfirm == true)
								{
									dem=1;
								}else{
									dem=0;
								}
								break;
							}
							else{
								if(tontai==0){
									dem=1;
								}
							}
						} //end for
						if(dem==1){
							jQuery("#dtph_rowed5").jqGrid('addRow',parameters);
						}
						var tmp1 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
						var tongtien =0;
						var dtph_phithuchien =0;
						for(var i=0;i < tmp1.length;i++){ 
								var rowData = $("#dtph_rowed5").getRowData(tmp1[i]);	
								xoa = "<input class='dtph_custom_button_n' style='height:22px;width:50px;margin-left: -14px; box-shadow:none!important;cursor:pointer;' type='button' value='Xóa' onclick=\"dtph_n_xoa('"+tmp1[i]+"');\" />"; 
								$("#dtph_rowed5").jqGrid('setRowData',tmp1[i],{Xoa:xoa});
								
								tongtien =parseInt(tongtien) + parseInt(rowData["dtph_thanhtien"]);
								dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt(rowData["dtph_phithuchien"]);
								number_textbox("#"+tmp1[i]+"_SLMoiNgay");
							 number_textbox("#"+tmp1[i]+"_SoNgay");
							}
						//load_select_nguoichidinh();
						$("#dtph_thanhtien").val(formatMoney(tongtien));
						$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
							
					}// end if(tmp.length==1)
				
				}else{
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_ylenh&id_todieutrichitiet='+window.idtodieutrichitiet).done(function(data){
						if(data=="true"){
								var tmp = $("#dtph_rowed4").jqGrid('getDataIDs'); 
								for (var i = 0; i < tmp.length; i++){
									var id = tmp[i];
									var rowData = jQuery('#dtph_rowed4').jqGrid ('getRowData', id);
								}
								//alert(tmp.length);
								if(tmp.length==1){
								var tmp1 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
								 var tam,ln=0;
								 for(var l=0;l<tmp1.length;l++){
									 }
								 var dem=tmp1+1;
								  var selRowId = $("#dtph_rowed3").jqGrid ('getGridParam', 'selrow');
								 var celValue = $("#dtph_rowed3").getRowData(selRowId);
									parameters =
									{
										initdata : {IDLoaiKham:rowData["ID_LoaiKham"],Xoa:"Xóa",LoaiKham:rowData["TenLoaiKham"],dtph_thanhtien:rowData["GiaBaoChoBN"],dtph_phithuchien:rowData["GiaBaoChoBN"],TrangThai:"DangCho",ThucHien: "0",NguoiChiDinh:"<?=$_SESSION["user"]["id_user"] ?>",NhanVienDuocChiDinhTH:"",NguoiThucHien:"",GiaThueNgoaiThucHien:rowData["GiaThueNgoaiThucHien"],ThoiGianTrungBinhThucHien:rowData["ThoiGianTrungBinhThucHien"],IDLuotKham:$("#idluotkham").val(),IDPhongChuyenMon:$("#idphongbanchuyenmon").val(),MaBenhNhan:$("#mabenhnhan").val(),IDNhomCLS:celValue["ID_NhomCLS"]},
										position :"last",
										useDefValues : false,
										useFormatter : false,
										addRowParams : {extraparam:{}}
									}
									var tmp2 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
									var dem=0;
									var tontai=0;
									
									if(tmp2.length==0)
										dem=1;
									for(var i=0;i < tmp2.length;i++){
										var rowData2 = $("#dtph_rowed5").getRowData(tmp2[i]);	
										if(rowData["ID_LoaiKham"]==rowData2["IDLoaiKham"]){
											tontai=1;
										var strconfirm = confirm("Loại khám: "+rowData["TenLoaiKham"]+" đã tồn tại, bạn có muốn chỉ định thêm không?", "Cảnh báo");
											if (strconfirm == true)
											{
												dem=1;
											}else{
												dem=0;
											}
											break;
										}
										else{
											if(tontai==0){
												dem=1;
											}
										}
									} //end for
									if(dem==1){
										jQuery("#dtph_rowed5").jqGrid('addRow',parameters);
									}
									var tmp1 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
									var tongtien =0;
									var dtph_phithuchien =0;
									for(var i=0;i < tmp1.length;i++){ 
											var rowData = $("#dtph_rowed5").getRowData(tmp1[i]);	
											xoa = "<input class='dtph_custom_button_n' style='height:22px;width:50px;margin-left: -14px; box-shadow:none!important;cursor:pointer;' type='button' value='Xóa' onclick=\"dtph_n_xoa('"+tmp1[i]+"');\" />"; 
											$("#dtph_rowed5").jqGrid('setRowData',tmp1[i],{Xoa:xoa});
											
											tongtien =parseInt(tongtien) + parseInt(rowData["dtph_thanhtien"]);
											dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt(rowData["dtph_phithuchien"]);
											number_textbox("#"+tmp1[i]+"_SLMoiNgay");
										 number_textbox("#"+tmp1[i]+"_SoNgay");
										}
									//load_select_nguoichidinh();
									$("#dtph_thanhtien").val(formatMoney(tongtien));
									$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
										
								}// end if(tmp.length==1)
						}else{
							tooltip_message("Y lệnh bác sỹ đã cho phép thực hiện hoặc đã hoàn tất");
						}
					});
				}
            
            },
            onselect: function(rowId, rowIndex, columnIndex) {
              
            },
            loadComplete: function(data) {
				ids = $('#dtph_rowed3').jqGrid('getDataIDs');				 
				$("#dtph_rowed3").jqGrid("setSelection",ids[0], true);
					
				 var i, groups = $(this).jqGrid("getGridParam", "groupingView").groups,
				 l = groups.length,
				 idSelectorPrefix = "#" + this.id + "ghead_0_";
				 for (i = 0; i < l; i++) {
					 if (groups[i].cnt === 1) {
						 //alert(groups[i].cnt)
						 // hide the grouping row
						 $(idSelectorPrefix + i).hide();
					 }
				 }
				 $("#"+ids[0]).focus();

			   $("#dtph_rowed3").unbind("keydown")
			   $("#dtph_rowed3").jqGrid('bindKeys', {});
			   $("#dtph_rowed3").bind("keydown",function(event) {	
				 			 
					 var keycode = (event.keyCode ? event.keyCode : event.which);
					 if(keycode == '13'){
						var tmp = $("#dtph_rowed4").jqGrid('getDataIDs'); 
						if(tmp.length==1){
						var id = $("#dtph_rowed3").jqGrid ('getGridParam', 'selrow');
						$("#dtph_rowed3 #"+id).dblclick();
						}else{
							$("#gs_TenLoaiKham").focus();
							}
					 }
					 })
			},
            caption: "Nhóm loại khám"
        });
        $("#dtph_rowed3").jqGrid('navGrid', "#pdtph_rowed3", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
	$("#dtph_rowed3").jqGrid('bindKeys', {});
    }
	
function dtph_create_grid2(){
		mydata=[];
        $("#dtph_rowed4").jqGrid({
            data: mydata,
            datatype: "local",
            colNames: ['GiaThueNgoaiThucHien', 'ThoiGianTrungBinhThucHien', 'ID_LoaiKham', 'Tên loại khám', 'Đơn giá'],
            colModel: [
                {name: 'GiaThueNgoaiThucHien', index: 'GiaThueNgoaiThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ThoiGianTrungBinhThucHien', index: 'ThoiGianTrungBinhThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ID_LoaiKham', index: 'ID_LoaiKham', search: false, width: "0%", editable: false, align: 'left', hidden: true},
                {name: 'TenLoaiKham', index: 'TenLoaiKham', search: true, width: "70%", editable: false, align: 'left', hidden: false},
				{name:'GiaBaoChoBN',index:'GiaBaoChoBN', width:"30%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},	            
				
				],
            loadonce: true,
            scroll: false,
            modal: true,
            shrinkToFit: true,
			grid_save_option: "",
            cmTemplate: {sortable: false},
            rowNum: 10000000,
            rowList: [],
            pager: '#pdtph_rowed4',
            //sortname: 'ID_LoaiKham',
            height: 100,
            width: 100,
            viewrecords: true,
            ignoreCase: true,
            sortorder: "desc",
			afterShowForm : function (formid) {

			},ondblClickRow: function(rowId, rowIndex, columnIndex) {
				if(window.idtodieutrichitiet==''){
					
					var tmp1 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
					 var tam,ln=0;
					 var dem=tmp1+1;
					 var rowData = jQuery("#dtph_rowed4").getRowData(rowId);
					 var selRowId = $("#dtph_rowed3").jqGrid ('getGridParam', 'selrow');
					 var celValue = $("#dtph_rowed3").getRowData(selRowId);
						parameters =
								{
									initdata : {IDLoaiKham:rowData["ID_LoaiKham"],Xoa:"Xóa",LoaiKham:rowData["ID_LoaiKham"],dtph_thanhtien:rowData["GiaBaoChoBN"],dtph_phithuchien:rowData["GiaBaoChoBN"],TrangThai:"DangCho",ThucHien: "0",NguoiChiDinh:"<?=$_SESSION["user"]["id_user"] ?>",NhanVienDuocChiDinhTH:"",NguoiThucHien:"",GiaThueNgoaiThucHien:rowData["GiaThueNgoaiThucHien"],ThoiGianTrungBinhThucHien:rowData["ThoiGianTrungBinhThucHien"],IDLuotKham:$("#idluotkham").val(),IDPhongChuyenMon:$("#idphongbanchuyenmon").val(),MaBenhNhan:$("#mabenhnhan").val(),IDNhomCLS:celValue["ID_NhomCLS"]},
									position :"last",
									useDefValues : false,
									useFormatter : false,
									addRowParams : {extraparam:{}}
								}
					var tmp2 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
					var dem=0;
					var tontai=0;
					if(tmp2.length==0)
						dem=1;
					for(var i=0;i < tmp2.length;i++){
						var rowData2 = $("#dtph_rowed5").getRowData(tmp2[i]);	
						if(rowData["ID_LoaiKham"]==rowData2["IDLoaiKham"]){
							tontai=1;
						}else{
							if(tontai==0){
								dem=1;
							}
						}
					} //end for
					if(tontai==1){
							var strconfirm = confirm("Loại khám: "+rowData["TenLoaiKham"]+" đã tồn tại, bạn có muốn chỉ định thêm không?", "Cảnh báo");
							if (strconfirm == true){
								dem=1;
							}else{
								dem=0;
							}
					}
					if(dem==1){
						jQuery("#dtph_rowed5").jqGrid('addRow',parameters);
					}
					var tmp3= $("#dtph_rowed5").jqGrid('getDataIDs'); 
					var tongtien =0;
					var dtph_phithuchien =0;
					var y=0;
					var x=0;
					for(var i=0;i < tmp3.length;i++){ 
							//console.log(tmp3[i]);
							var rowData = $("#dtph_rowed5").getRowData(tmp3[i]);	
							xoa = "<input class='dtph_custom_button_n' style='height:22px;width:50px;margin-left: -14px; box-shadow:none!important;cursor:pointer;' type='button' value='Xóa' onclick=\"dtph_n_xoa('"+tmp3[i]+"');\" />"; 
							$("#dtph_rowed5").jqGrid('setRowData',tmp3[i],{Xoa:xoa});
							 tongtien =parseInt(tongtien) + parseInt(rowData["dtph_thanhtien"]);
							 dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt(rowData["dtph_phithuchien"]);
							 number_textbox("#"+tmp3[i]+"_SLMoiNgay");
							 number_textbox("#"+tmp3[i]+"_SoNgay");
							if((rowData["IDNhomCLS"]==17)&&(y==0)&&($('#'+tmp3[i]+'_ThucHien').val()==1)){
								window.id_rowcls=tmp3[i];
								y++;
							}
							if((rowData["IDNhomCLS"]==17)&&(x==0)){
								window.id_rowcls2=tmp3[i];
								x++;
							}
						}
					$("#dtph_thanhtien").val(formatMoney(tongtien));
					$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
						var tongtien_vatlytrilieu=0;
						var tongtien_tthuat_pthuat=0;
						var tongtien_family_flanning=0;
						var tongtien_dieuduong=0;
						for(var i=0;i < tmp3.length;i++){ 
							var rowData = $("#dtph_rowed5").getRowData(tmp3[i]);
							if(rowData["IDNhomCLS"]==25){
								tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["dtph_phithuchien"]);
								$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
							}else if(rowData["IDNhomCLS"]==23){
								tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["dtph_phithuchien"]);
								$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
							}else if(rowData["IDNhomCLS"]==52){
								tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["dtph_phithuchien"]);
								$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_family_flanning);
							}else if(rowData["IDNhomCLS"]==26){
								tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["dtph_phithuchien"]);
								$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_dieuduong);
							}
					}//end for
					
					for(var i=0;i < tmp3.length;i++){ 
						var rowData = $("#dtph_rowed5").getRowData(tmp3[i]);
						if(rowData["IDNhomCLS"]==25){
								$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
							}else if(rowData["IDNhomCLS"]==23){
								$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
							}else if(rowData["IDNhomCLS"]==52){
								$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_family_flanning);
							}else if(rowData["IDNhomCLS"]==26){
								$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_dieuduong);
								}
					}//end for
					//end tong tien nhom
				 // }//end if

			 	}else{
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_ylenh&id_todieutrichitiet='+window.idtodieutrichitiet).done(function(data){
					if(data=="true"){
							 var tmp1 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
							 var tam,ln=0;
							 var dem=tmp1+1;
							 var rowData = jQuery("#dtph_rowed4").getRowData(rowId);
							 var selRowId = $("#dtph_rowed3").jqGrid ('getGridParam', 'selrow');
							 var celValue = $("#dtph_rowed3").getRowData(selRowId);
								parameters =
										{
											initdata : {IDLoaiKham:rowData["ID_LoaiKham"],Xoa:"Xóa",LoaiKham:rowData["ID_LoaiKham"],dtph_thanhtien:rowData["GiaBaoChoBN"],dtph_phithuchien:rowData["GiaBaoChoBN"],TrangThai:"DangCho",ThucHien: "0",NguoiChiDinh:"<?=$_SESSION["user"]["id_user"] ?>",NhanVienDuocChiDinhTH:"",NguoiThucHien:"",GiaThueNgoaiThucHien:rowData["GiaThueNgoaiThucHien"],ThoiGianTrungBinhThucHien:rowData["ThoiGianTrungBinhThucHien"],IDLuotKham:$("#idluotkham").val(),IDPhongChuyenMon:$("#idphongbanchuyenmon").val(),MaBenhNhan:$("#mabenhnhan").val(),IDNhomCLS:celValue["ID_NhomCLS"]},
											position :"last",
											useDefValues : false,
											useFormatter : false,
											addRowParams : {extraparam:{}}
										}
							var tmp2 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
							var dem=0;
							var tontai=0;
							if(tmp2.length==0)
								dem=1;
							for(var i=0;i < tmp2.length;i++){
								var rowData2 = $("#dtph_rowed5").getRowData(tmp2[i]);	
								if(rowData["ID_LoaiKham"]==rowData2["IDLoaiKham"]){
									tontai=1;
								}
								else{
									if(tontai==0){
										dem=1;
									}
								}
							} //end for
							if(tontai==1){
									var strconfirm = confirm("Loại khám: "+rowData["TenLoaiKham"]+" đã tồn tại, bạn có muốn chỉ định thêm không?", "Cảnh báo");
									if (strconfirm == true){
										dem=1;
									}else{
										dem=0;
									}
							}
							if(dem==1){
								jQuery("#dtph_rowed5").jqGrid('addRow',parameters);
							}
							var tmp3= $("#dtph_rowed5").jqGrid('getDataIDs'); 
							var tongtien =0;
							var dtph_phithuchien =0;
							var y=0;
							var x=0;
							for(var i=0;i < tmp3.length;i++){ 
									//console.log(tmp3[i]);
									var rowData = $("#dtph_rowed5").getRowData(tmp3[i]);	
									xoa = "<input class='dtph_custom_button_n' style='height:22px;width:50px;margin-left: -14px; box-shadow:none!important;cursor:pointer;' type='button' value='Xóa' onclick=\"dtph_n_xoa('"+tmp3[i]+"');\" />"; 
									$("#dtph_rowed5").jqGrid('setRowData',tmp3[i],{Xoa:xoa});
									 tongtien =parseInt(tongtien) + parseInt(rowData["dtph_thanhtien"]);
									 dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt(rowData["dtph_phithuchien"]);
									 number_textbox("#"+tmp3[i]+"_SLMoiNgay");
									 number_textbox("#"+tmp3[i]+"_SoNgay");
									if((rowData["IDNhomCLS"]==17)&&(y==0)&&($('#'+tmp3[i]+'_ThucHien').val()==1)){
										window.id_rowcls=tmp3[i];
										y++;
									}
									if((rowData["IDNhomCLS"]==17)&&(x==0)){
										window.id_rowcls2=tmp3[i];
										x++;
									}
								}
							$("#dtph_thanhtien").val(formatMoney(tongtien));
							$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
								var tongtien_vatlytrilieu=0;
								var tongtien_tthuat_pthuat=0;
								var tongtien_family_flanning=0;
								var tongtien_dieuduong=0;
								for(var i=0;i < tmp3.length;i++){ 
									var rowData = $("#dtph_rowed5").getRowData(tmp3[i]);
									if(rowData["IDNhomCLS"]==25){
										tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["dtph_phithuchien"]);
										$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
									}else if(rowData["IDNhomCLS"]==23){
										tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["dtph_phithuchien"]);
										$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
									}else if(rowData["IDNhomCLS"]==52){
										tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["dtph_phithuchien"]);
										$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_family_flanning);
									}else if(rowData["IDNhomCLS"]==26){
										tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["dtph_phithuchien"]);
										$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_dieuduong);
									}
							}//end for
							
							for(var i=0;i < tmp3.length;i++){ 
								var rowData = $("#dtph_rowed5").getRowData(tmp3[i]);
								if(rowData["IDNhomCLS"]==25){
										$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
									}else if(rowData["IDNhomCLS"]==23){
										$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
									}else if(rowData["IDNhomCLS"]==52){
										$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_family_flanning);
									}else if(rowData["IDNhomCLS"]==26){
										$('#dtph_rowed5').jqGrid('setCell',tmp3[i],'TongTienTheoNhom',tongtien_dieuduong);
										}
							}//end for
							//end tong tien nhom
						 // }//end if
					}else{
						tooltip_message("Y lệnh bác sỹ đã cho phép thực hiện hoặc đã hoàn tất");
					}
				});
		}
			},
            onRightClickRow: function(rowid, iRow, iCol, e) {

            },
            loadComplete: function(data) {
               grid_filter_enter("#dtph_rowed4");
			    $("#dtph_rowed4").unbind("keydown")
			   $("#dtph_rowed4").jqGrid('bindKeys', {});
			   $("#dtph_rowed4").bind("keydown",function(event) {	
					 var keycode = (event.keyCode ? event.keyCode : event.which);
					 if(keycode == '13'){
						  var id = $("#dtph_rowed4").jqGrid ('getGridParam', 'selrow');
							$("#dtph_rowed4 #"+id).dblclick();
							$("#gs_TenLoaiKham").focus();
					 }
					 })
            },
            caption: " Hạng mục loại khám"

        });
		$("#dtph_rowed4").jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
        $("#dtph_rowed4").jqGrid('navGrid', "#pdtph_rowed4", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
		$("#dtph_rowed4").jqGrid('bindKeys', {});
   }
function dtph_create_grid3(){
		mydata=[];
        $("#dtph_rowed5").jqGrid({
            data: mydata,
			editurl: 'clientArray',
            datatype: "local",
            colNames: ['ID Loại Khám','Xóa','Loại khám','SL mỗi ngày', 'Thành tiền','Số ngày', 'Phí thực hiện', 'Trạng thái', 'Thực hiện', 'Người chỉ định', 'Nhân viên được chỉ định thực hiện',  'Người thực hiện',  'GiaThueNgoaiThucHien',  'ThoiGianTrungBinhThucHien',  'IDKham',  'IDPhongChuyenMon',  'MaBenhNhan','LyDoHuyBo','huy',  'IDLuotKham','Luu','IDNhomCLS','NgayGioTao','TongTienTheoNhom' ,'ID Nhom PHY va Nhom DieuTriPhoihop','lần chỉ định','ID_ToDieuTriChiTietKham','ID khám tạm','SLNgay','SLMoiNgay2'],
            colModel: [
                {name: 'IDLoaiKham', index: 'IDLoaiKham', search: false, width: "10%", editable: false, align: 'left', hidden: true},
                {name: 'Xoa', index: 'Xoa', search: false, width: "8%", editable: false, align: 'left', hidden: false},
                {name: 'LoaiKham', index: 'LoaiKham', search: false, width: "40%", editable: false, align: 'left', hidden: false,edittype:"select",formatter:'select',editoptions:{value: tenloaikham},classes:'loai_kham'},
				{name: 'SLMoiNgay', index: 'SLMoiNgay', search: false, width: "14%", editable: true,edittype:"text",formatter:'number',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '1'},editoptions: { dataEvents: [{ type: 'change', fn: function(e) {
					
								var row = $(e.target).closest('tr.jqgrow');
                                var rowId = row.attr('id');
								var rowData_check2 = $("#dtph_rowed5").getRowData(rowId);
								//alert(rowData_check['SLMoiNgay2']);
								$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_cls_dtph&id_todieutrichitietkham='+rowId).done(function(data){
								if(data=="true"){
										var sl_moi_ngay=$('#'+rowId+'_SLMoiNgay').val();
										var thanh_tien=$('#dtph_rowed5').jqGrid('getCell',rowId,'dtph_thanhtien');
										var so_ngay=$('#'+rowId+'_SoNgay').val();
										if(sl_moi_ngay==0){
											$('#'+rowId+'_SLMoiNgay').val("1");
											var sl_moi_ngay=$('#'+rowId+'_SLMoiNgay').val();
										}
										var phi_thuc_hien= ((parseInt(thanh_tien) * parseInt(sl_moi_ngay)) * parseInt(so_ngay));
										//$('#dtph_rowed5').jqGrid('setCell',rowId,'dtph_phithuchien');
										$('#dtph_rowed5').jqGrid('setCell',rowId,'dtph_phithuchien',phi_thuc_hien,'');
										
										var tmp = $("#dtph_rowed5").jqGrid('getDataIDs'); 
										var tongtien =0;
										var dtph_phithuchien =0;
										for(var i=0;i < tmp.length;i++){ 
											tongtien =parseInt(tongtien) + parseInt($('#dtph_rowed5').jqGrid('getCell',tmp[i],'dtph_thanhtien'));
											dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt($('#dtph_rowed5').jqGrid('getCell',tmp[i],'dtph_phithuchien'));
										}
										$("#dtph_thanhtien").val(formatMoney(tongtien));
										$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
											var tongtien_vatlytrilieu=0;
											var tongtien_tthuat_pthuat=0;
											var tongtien_family_flanning=0;
											var tongtien_dieuduong=0;
											for(var i=0;i < tmp.length;i++){ 
												var rowData = $("#dtph_rowed5").getRowData(tmp[i]);
												if(rowData["IDNhomCLS"]==25){
													tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["dtph_phithuchien"]);
													$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
												}else if(rowData["IDNhomCLS"]==23){
													tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["dtph_phithuchien"]);
													$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
												}else if(rowData["IDNhomCLS"]==52){
													tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["dtph_phithuchien"]);
													$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_family_flanning);
												}else if(rowData["IDNhomCLS"]==26){
													tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["dtph_phithuchien"]);
													$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_dieuduong);
												}
										}//end for
										for(var i=0;i < tmp.length;i++){ 
										var rowData = $("#dtph_rowed5").getRowData(tmp[i]);
										if(rowData["IDNhomCLS"]==25){
												$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
											}else if(rowData["IDNhomCLS"]==23){
												$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
											}else if(rowData["IDNhomCLS"]==52){
												$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_family_flanning);
											}else if(rowData["IDNhomCLS"]==26){
												$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_dieuduong);
												}
										}//end for
										//end tong tien nhom
									}else{
										$('#'+rowId+'_SLMoiNgay').val(rowData_check2['SLMoiNgay2']);
										tooltip_message("Loại khám này đã thực hiện");
									}
								});//end post

	} },
]}
, align: 'center', hidden: false,classes:'slmoingay'},
                {name: 'dtph_thanhtien', index: 'dtph_thanhtien', search: false, width: "15%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'SoNgay', index: 'SoNgay', search: false, width: "14%", editable: true,edittype:"text",formatter:'number',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '1'},editoptions: { dataEvents: [{ type: 'change', fn: function(e) {
								var row = $(e.target).closest('tr.jqgrow');
                                var rowId = row.attr('id');
								var rowData_check = $("#dtph_rowed5").getRowData(rowId);
								//alert(rowData_check['SLMoiNgay2']);
								$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_cls_dtph&id_todieutrichitietkham='+rowId).done(function(data){
								if(data=="true"){
									var sl_moi_ngay=$('#'+rowId+'_SLMoiNgay').val();
									var thanh_tien=$('#dtph_rowed5').jqGrid('getCell',rowId,'dtph_thanhtien');
									//var idnhomcls=$('#dtph_rowed5').jqGrid('getCell',rowId,'IDNhomCLS');
									var so_ngay=$('#'+rowId+'_SoNgay').val();
									if((so_ngay=="") || (so_ngay==0)){
										$('#'+rowId+'_SoNgay').val("1");
										}
								
									var phi_thuc_hien= ((parseInt(thanh_tien) * parseInt(sl_moi_ngay)) * parseInt(so_ngay));
									$('#dtph_rowed5').jqGrid('setCell',rowId,'dtph_phithuchien',phi_thuc_hien,'');
									
									var tmp = $("#dtph_rowed5").jqGrid('getDataIDs'); 
									var tongtien =0;
									var dtph_phithuchien =0;
									for(var i=0;i < tmp.length;i++){ 
											tongtien =parseInt(tongtien) + parseInt($('#dtph_rowed5').jqGrid('getCell',tmp[i],'dtph_thanhtien'));
											dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt($('#dtph_rowed5').jqGrid('getCell',tmp[i],'dtph_phithuchien'));
										}
									$("#dtph_thanhtien").val(formatMoney(tongtien));
									$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
										var tongtien_vatlytrilieu=0;
										var tongtien_tthuat_pthuat=0;
										var tongtien_family_flanning=0;
										var tongtien_dieuduong=0;
										for(var i=0;i < tmp.length;i++){ 
											var rowData = $("#dtph_rowed5").getRowData(tmp[i]);
											if(rowData["IDNhomCLS"]==25){
												tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["dtph_phithuchien"]);
												$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
											}else if(rowData["IDNhomCLS"]==23){
												tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["dtph_phithuchien"]);
												$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
											}else if(rowData["IDNhomCLS"]==52){
												tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["dtph_phithuchien"]);
												$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_family_flanning);
											}else if(rowData["IDNhomCLS"]==26){
												tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["dtph_phithuchien"]);
												$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_dieuduong);
											}
									}//end for
									for(var i=0;i < tmp.length;i++){ 
									var rowData = $("#dtph_rowed5").getRowData(tmp[i]);
									if(rowData["IDNhomCLS"]==25){
											$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
										}else if(rowData["IDNhomCLS"]==23){
											$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
										}else if(rowData["IDNhomCLS"]==52){
											$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_family_flanning);
										}else if(rowData["IDNhomCLS"]==26){
											$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_dieuduong);
											}
									}//end for
									//end tong tien nhom
								}// and if data=true
								else{
									$('#'+rowId+'_SoNgay').val(rowData_check['SLNgay2']);
									tooltip_message("Loại khám này đã thực hiện");
								}
								});//post check
	} },

]}, align: 'center', hidden: false,classes:'songay'},
                {name: 'dtph_phithuchien', index: 'dtph_phithuchien', search: false, width: "15%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
                {name: 'TrangThai', index: 'TrangThai', search: false, width: "20%", editable: false, align: 'center', hidden: false,edittype:"select",formatter:'select',editoptions:{value: trangthai}},
                {name: 'ThucHien', index: 'ThucHien', search: false, width: "18%", editable: true, align: 'center', hidden: true,edittype:"select",formatter:'select',editoptions:{value:"0:Hospital;1:Home;2:Seft",dataEvents: [{ type: 'change keyup', fn: function(e) {
					var tmp5 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
											var row = $(e.target).closest('tr.jqgrow');
                                            var rowId = row.attr('id');
										var id_loaikham =$('#dtph_rowed5').jqGrid('getCell',rowId,'IDLoaiKham');	
										var id_ncls =$('#dtph_rowed5').jqGrid('getCell',rowId,'IDNhomCLS');	
											var y=0;
											var yy=0;
											var n=0;
											var x=0;
											var a="";
												for(var i = 0; i < phuthu.length; i++) {							
												if(phuthu[i]['id'] == id_loaikham) {											
													 y=i;
													 break;
												}
											}
											for(var k = 0; k < tmp5.length; k++){
												var rowData = $("#dtph_rowed5").getRowData(tmp5[k]);
												if((rowData["IDNhomCLS"]==17)&&(x==0)&&($('#'+tmp5[k]+'_ThucHien').val()==1)){
													window.id_rowcls2=tmp5[k];
													x++;
												}
											}
											var x=0;
											for(var l = 0; l < phuthu.length; l++) {	
												if((parseInt(phuthu[l]['id'])==parseInt(id_loaikham)) && (parseInt(phuthu[l]['ID_NhomCLS'])==17) && (x==0)){
													n=l;
													x++;
													break;
													}
											}
							var thuchien=$('#'+rowId+'_ThucHien').val();
							if((phuthu[i]['DieuTriTaiNha']!=1)&& (thuchien==1)){
								$('#'+rowId+'_ThucHien').val(0);
								$('#'+rowId+'_ThucHien').change();
								var sl_moi_ngay=$('#'+rowId+'_SLMoiNgay').val();
								var thanh_tien=$('#dtph_rowed5').jqGrid('getCell',rowId,'dtph_thanhtien');
								var so_ngay=$('#'+rowId+'_SoNgay').val();
								var phi_thuc_hien= ((parseInt(thanh_tien) * parseInt(sl_moi_ngay)) * parseInt(so_ngay));
								$('#dtph_rowed5').jqGrid('setCell',rowId,'dtph_phithuchien',phi_thuc_hien,'');
								var tmp = $("#dtph_rowed5").jqGrid('getDataIDs'); 
								var tongtien =0;
							  	var dtph_phithuchien =0;
								for(var i=0;i < tmp.length;i++){ 
										tongtien =parseInt(tongtien) + parseInt($('#dtph_rowed5').jqGrid('getCell',tmp[i],'dtph_thanhtien'));
										dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt($('#dtph_rowed5').jqGrid('getCell',tmp[i],'dtph_phithuchien'));
										if($('#dtph_rowed5').jqGrid('getCell',tmp[i],'IDNhomCLS')==25){
											}
									}
								$("#dtph_thanhtien").val(formatMoney(tongtien));
								$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
								alert("Hạng mục khám này không cho phép thực hiện tại nhà");
							}else{
							if(thuchien==0){
								$('#dtph_rowed5').jqGrid("setCell", rowId, 'dtph_thanhtien', phuthu[i]['GiaBaoChoBN']);
									var sl_moi_ngay=$('#'+rowId+'_SLMoiNgay').val();
									var thanh_tien=parseInt(phuthu[i]['GiaBaoChoBN'])
									var so_ngay=$('#'+rowId+'_SoNgay').val();
									
									var phi_thuc_hien= ( (parseInt(thanh_tien) * parseInt(sl_moi_ngay)) * parseInt(so_ngay));
									$('#dtph_rowed5').jqGrid('setCell',rowId,'dtph_phithuchien',phi_thuc_hien);
									var tongtien_vatlytrilieu=0;
									var tongtien_tthuat_pthuat=0;
									var tongtien_family_flanning=0;
									var tongtien_dieuduong=0;
									for(var i=0;i < tmp5.length;i++){ 
										var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
										if(rowData["IDNhomCLS"]==25){
											tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["dtph_phithuchien"]);
											$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
										}else if(rowData["IDNhomCLS"]==23){
											tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["dtph_phithuchien"]);
											$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
										}else if(rowData["IDNhomCLS"]==52){
											tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["dtph_phithuchien"]);
											$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
										}else if(rowData["IDNhomCLS"]==26){
											tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["dtph_phithuchien"]);
											$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
										}
									
								}//end for
								for(var i=0;i < tmp5.length;i++){ 
								//alert(tongtien_vatlytrilieu+"-"+tongtien_tthuat_pthuat+"-"+tongtien_family_flanning+"-"+tongtien_dieuduong);
								var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
								if(rowData["IDNhomCLS"]==25){
										$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
									}else if(rowData["IDNhomCLS"]==23){
										$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
									}else if(rowData["IDNhomCLS"]==52){
										$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
									}else if(rowData["IDNhomCLS"]==26){
										$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
										}
								}//end for
								//end tong tien nhom
							}else if(thuchien==1){
								
								if (typeof id_rowcls2 === 'undefined')
								{
									$('#dtph_rowed5').jqGrid("setCell", rowId, 'dtph_thanhtien', parseInt(phuthu[i]['GiaBaoChoBN'])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']));
									var sl_moi_ngay=$('#'+rowId+'_SLMoiNgay').val();
									var thanh_tien=$('#dtph_rowed5').jqGrid('getCell',rowId,'dtph_thanhtien');
									var so_ngay=$('#'+rowId+'_SoNgay').val();
									var phi_thuc_hien= ((parseInt(thanh_tien) * parseInt(sl_moi_ngay)) * parseInt(so_ngay));
									$('#dtph_rowed5').jqGrid('setCell',rowId,'dtph_phithuchien',phi_thuc_hien);
								}else if(id_rowcls2){ 
									for(var i = 0; i< tmp5.length; i++){
										var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
										if((rowData["IDNhomCLS"]==17)&& (tmp5[i]!=rowId) && (id_ncls==17) && ($('#'+tmp5[i]+'_ThucHien').val()!=2)){
											$('#'+tmp5[i]+'_ThucHien').val(0);
											$('#'+tmp5[i]+'_ThucHien').change();
										}
									}
									if(id_rowcls2==rowId){
										$('#dtph_rowed5').jqGrid("setCell", id_rowcls2, 'dtph_thanhtien', parseInt(phuthu[n]['GiaBaoChoBN'])+parseInt(phuthu[n]['PhuThuThucHienTaiNha']));
										var sl_moi_ngay=$('#'+rowId+'_SLMoiNgay').val();
									var thanh_tien=$('#dtph_rowed5').jqGrid('getCell',rowId,'dtph_thanhtien');
									var so_ngay=$('#'+rowId+'_SoNgay').val();
									var phi_thuc_hien= ((parseInt(thanh_tien) * parseInt(sl_moi_ngay)) * parseInt(so_ngay));
									$('#dtph_rowed5').jqGrid('setCell',rowId,'dtph_phithuchien',phi_thuc_hien);
									}
									else{
										$('#dtph_rowed5').jqGrid("setCell", rowId, 'dtph_thanhtien', parseInt(phuthu[i]['GiaBaoChoBN']));
										var sl_moi_ngay=$('#'+rowId+'_SLMoiNgay').val();
										var thanh_tien=parseInt(phuthu[i]['GiaBaoChoBN'])
										var so_ngay=$('#'+rowId+'_SoNgay').val();
										var phi_thuc_hien= ( (parseInt(thanh_tien) * parseInt(sl_moi_ngay)) * parseInt(so_ngay));
										$('#dtph_rowed5').jqGrid('setCell',rowId,'dtph_phithuchien',phi_thuc_hien);
									}
								}
								else{
									$('#dtph_rowed5').jqGrid("setCell", rowId, 'dtph_thanhtien', parseInt(phuthu[i]['GiaBaoChoBN']));
									var sl_moi_ngay=$('#'+rowId+'_SLMoiNgay').val();
										var thanh_tien=parseInt(phuthu[i]['GiaBaoChoBN'])
										var so_ngay=$('#'+rowId+'_SoNgay').val();
										var phi_thuc_hien= ( (parseInt(thanh_tien) * parseInt(sl_moi_ngay)) * parseInt(so_ngay));
										$('#dtph_rowed5').jqGrid('setCell',rowId,'dtph_phithuchien',phi_thuc_hien);
								}
							}else{
								$('#dtph_rowed5').jqGrid("setCell", rowId, 'dtph_thanhtien',0 );
								$('#dtph_rowed5').jqGrid("setCell", rowId, 'dtph_phithuchien',0 );
									var tongtien_vatlytrilieu=0;
									var tongtien_tthuat_pthuat=0;
									var tongtien_family_flanning=0;
									var tongtien_dieuduong=0;
									for(var i=0;i < tmp5.length;i++){ 
										var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
										if(rowData["IDNhomCLS"]==25){
											tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["dtph_phithuchien"]);
											$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
										}else if(rowData["IDNhomCLS"]==23){
											tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["dtph_phithuchien"]);
											$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
										}else if(rowData["IDNhomCLS"]==52){
											tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["dtph_phithuchien"]);
											$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
										}else if(rowData["IDNhomCLS"]==26){
											tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["dtph_phithuchien"]);
											$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
										}
								}//end for
								for(var i=0;i < tmp5.length;i++){ 
								var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
								if(rowData["IDNhomCLS"]==25){
										$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
									}else if(rowData["IDNhomCLS"]==23){
										$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
									}else if(rowData["IDNhomCLS"]==52){
										$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_family_flanning);
									}else if(rowData["IDNhomCLS"]==26){
										$('#dtph_rowed5').jqGrid('setCell',tmp5[i],'TongTienTheoNhom',tongtien_dieuduong);
										}
								}//end for
								//end tong tien nhom
								}
								
							}
							  var tongtien =0;
							  var dtph_phithuchien =0;
								for(var i=0;i < tmp5.length;i++){ 
										var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
										tongtien =parseInt(tongtien) + parseInt(rowData["dtph_thanhtien"]);
										dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt(rowData["dtph_phithuchien"]);
									}
								$("#dtph_thanhtien").val(formatMoney(tongtien));
								$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
 } }]} },
				{name: 'NguoiChiDinh', index: 'NguoiChiDinh', search: false, width: "15%", editable: false, align: 'center', hidden: false,edittype:"select",formatter:'select',editoptions:{value: nguoichidinh} },
                {name: 'NhanVienDuocChiDinhTH', index: 'NhanVienDuocChiDinhTH', search: false, width: "25%", editable: true, align: 'center', hidden: true,edittype:"select",formatter:'select',editoptions:{value: hotennv2}},
                {name: 'NguoiThucHien', index: 'NguoiThucHien', search: false, width: "25%", editable: true, align: 'center', hidden: true,edittype:"select",formatter:'select',editoptions:{value: hotennv2} },
			{name: 'GiaThueNgoaiThucHien', index: 'GiaThueNgoaiThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ThoiGianTrungBinhThucHien', index: 'ThoiGianTrungBinhThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDKham', index: 'IDKham', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDPhongChuyenMon', index: 'IDPhongChuyenMon', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'MaBenhNhan', index: 'MaBenhNhan', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'LyDoHuyBo', index: 'LyDoHuyBo', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'Huy', index: 'Huy', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDLuotKham', index: 'IDLuotKham', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'Luu', index: 'Luu', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDNhomCLS', index: 'IDNhomCLS', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'NgayGioTao', index: 'NgayGioTao', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'TongTienTheoNhom', index: 'TongTienTheoNhom', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'Id_phy_dtph', index: 'Id_phy_dtph', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'LanChiDinh', index: 'LanChiDinh', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'ID_ToDieuTriChiTietKham', index: 'ID_ToDieuTriChiTietKham', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'ID_Kham_Tam', index: 'ID_Kham_Tam', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'SLNgay2', index: 'SLNgay2', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'SLMoiNgay2', index: 'SLMoiNgay2', search: false, width: "10%", editable: false, align: 'left', hidden: true}
            ],
          loadonce: false,
            scroll: false,
            modal: true,
			rownumbers: true,
            shrinkToFit: true,
			grid_save_option: "",
            cmTemplate: {sortable: false},
            rowNum: 10000000,
			pginput:false,
			pgbuttons:false,
            rowList: [],
            pager: '#pdtph_rowed5',
            sortname: 'ThoiGianVaoKham',
            height: 100,
            width: 100,
            viewrecords: true,
            ignoreCase: true,
            sortorder: "desc",
			afterShowForm : function (formid) {
				xuongdong(formid);
				lendong(formid);
			},beforeShowForm: function(formid){	
			//	number_textbox(".editable");
					number_textbox("#jqg4_SLMoiNgay");

			},
            loadComplete: function(data) {
              var tmp1 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
			   var tongtien =0;
		 		 var dtph_phithuchien =0;
				 var x=0;
				 window.dieutriphoihop='';
				for(var i=0;i < tmp1.length;i++){ 
				jQuery("#dtph_rowed5").jqGrid('editRow',tmp1[i]);
					var rowData = $("#dtph_rowed5").getRowData(tmp1[i]);
					/*if(rowData["TrangThai"]!="HuyBo"){
						if(window.dieutriphoihop==''){
							window.dieutriphoihop=$("#"+tmp1[i]+" .loai_kham").html();
						}else{
							window.dieutriphoihop=window.dieutriphoihop+', '+$("#"+tmp1[i]+" .loai_kham").html();
						}
					}*/
					xoa = "<input class='dtph_custom_button_n' style='height:22px;width:50px; margin-left: -14px; box-shadow:none!important;cursor:pointer;' type='button' value='Xóa' onclick=\"dtph_n_xoa('"+tmp1[i]+"');\" />"; 
					$("#dtph_rowed5").jqGrid('setRowData',tmp1[i],{Xoa:xoa});
					$("#dtph_rowed5").jqGrid('setRowData', tmp1[i], false, { background: '#D3D3D3' });
						tongtien =parseInt(tongtien) + parseInt(rowData["dtph_thanhtien"]);
						dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt(rowData["dtph_phithuchien"]);
					if(rowData["TrangThai"]=="HuyBo"){
						jQuery("#dtph_rowed5").jqGrid('saveRow',tmp1[i]);
						$("#dtph_rowed5").jqGrid('setRowData', tmp1[i], false, { background: '#A9A9AA',border:'1px solid #A9A9AA;' });
					}
				}
				$("#dtph_thanhtien").val(formatMoney(tongtien));
				$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
				setTimeout(function(){
				$('#dtph_chongoikham').focus();
				},4000);
				//$("#tonghopylenh").val("Cận lâm sàng: "+window.canlamsang+"\nĐiều trị phối hợp: "+window.dieutriphoihop+"\nĐơn thuốc: "+window.donthuoc+"\nĐơn thuốc trả lại: "+window.donthuoctralai+"\nY lệnh khác: "+$("#ylenhkhac").val()); 
            },
            caption: " Hạng mục loại khám được chọn"
        });
       $("#dtph_rowed5").jqGrid('navGrid', "#pdtph_rowed5", {add: false, edit: false, del: false, search: false, refresh: false,prmView: false, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
		$("#dtph_rowed5").jqGrid('bindKeys', {});
    }

function dtph_create_layout() {
	if(window.tab2==0){
		setTimeout(function(){
        $('#panel_main_tab2').layout({
            resizerClass: 'ui-state-default'
                    , east: {
                		resizable: true
                        , size: "55%"
                        , spacing_closed: 27
                        , togglerLength_closed: 85
                        , togglerAlign_closed: "center"
                        , togglerContent_closed: "<div id='menu_toggle'>X<BR>O<BR>N<BR>G</div>"
                        , togglerTip_closed: "Open & Pin Menu"
                        , sliderTip: "Slide Open Menu"
                        , slideTrigger_open: "mouseover"
                        , fxSettings_close: {easing: "easeOutQuint"}
                , onresize_end: function() {
                    resize_control();
                }
                , onopen_end: function() {

                }
                , onclose_end: function() {

                }
            }
            , center: {
                resizable: true
                        , size: "30%"

                        , fxName: "drop"		// none, slide, drop, scale
                        , fxSpeed_open: 450
                        , fxSpeed_close: 450
                        , fxSettings_open: {easing: "easeInQuint"}
                , fxSettings_close: {easing: "easeOutQuint"}

                , onresize_end: function() {
                    resize_control();
                }
                , onopen_end: function() {


                }
                , onclose_end: function() {

                }
            }
			 , west:  {
                resizable: true
                        , size: "15%"
                        , spacing_closed: 27
                        , togglerLength_closed: 85
                        , togglerAlign_closed: "center"
                        , togglerContent_closed: "<div id='menu_toggle'>X<BR>O<BR>N<BR>G</div>"
                        , togglerTip_closed: "Open & Pin Menu"
                        , sliderTip: "Slide Open Menu"
                        , slideTrigger_open: "mouseover"
                        , fxSettings_close: {easing: "easeOutQuint"}
                , onresize_end: function() {
                    resize_control();
                }
                , onopen_end: function() {

                }
                , onclose_end: function() {

                }
            }
        });
		window.tab2=1;	
		resize_control()
		},1);
	
	}
		//alert();
}
function load_select_tenloaikham(){
	window.tenloaikham = $.ajax({url: "resource.php?module=web_services&function=get_auto_edit_option&action=index&term=&status=2&tables=DM_LoaiKham&id=ID_LoaiKham&name=TenLoaiKham", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục loại khám');}}).responseText;	
}
function load_select_hotennv(){
	window.hotennv = $.ajax({url: "resource.php?module=web_services&function=get_auto_edit_option_byid&action=index&term=ID_PhongBan<>21&status=2&tables=DM_NhanVien&id=ID_NhanVien&name=NickName", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục nhân viên');}}).responseText;	
}
function load_select_tenloaikham(){
	window.tenloaikham = $.ajax({url: "resource.php?module=web_services&function=get_auto_edit_option&action=index&term=&status=2&tables=DM_LoaiKham&id=ID_LoaiKham&name=TenLoaiKham", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục loại khám');}}).responseText;	
	
}

function dtph_n_xoa(tam){
	if(tam == parseInt(tam)){
		var rowData_check_dtph = $("#dtph_rowed5").getRowData(tam);
		if(rowData_check_dtph["TrangThai"]!='HuyBo'){
			$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_cls_dtph&id_todieutrichitietkham='+tam).done(function(data){
				if(data=="true"){
					var rowData_luu = $("#dtph_rowed5").getRowData(tam);
					//alert(rowData_luu["Luu"]);
					if(rowData_luu["Luu"]!=1){
						//alert(rowData_luu["Luu"]);
						$('#dtph_rowed5').jqGrid('delRowData',tam);
					  var tmp5 = $("#dtph_rowed5").jqGrid('getDataIDs'); 
					  var tongtien =0;
					  var dtph_phithuchien =0;
						for(var i=0;i < tmp5.length;i++){ 
								var rowData = $("#dtph_rowed5").getRowData(tmp5[i]);
								xoa = "<input class='dtph_custom_button_n' style='height:22px;width:50px;margin-left: -14px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"dtph_n_xoa('"+tmp5[i]+"');\" />"; 
								$("#dtph_rowed5").jqGrid('setRowData',tmp5[i],{Xoa:xoa});	
								tongtien =parseInt(tongtien) + parseInt(rowData["dtph_thanhtien"]);
								dtph_phithuchien =parseInt(dtph_phithuchien) + parseInt(rowData["dtph_phithuchien"]);
							
							}
						$("#dtph_thanhtien").val(formatMoney(tongtien));
						$("#dtph_phithuchien").val(formatMoney(dtph_phithuchien));
					}else{
						
						var rowData2 = $("#dtph_rowed5").getRowData(tam);
						$("#dtph_idk").val(tam);
						if(rowData2["TrangThai"]!="HuyBo"){
							$("#dialog_confirm_dtph_huybo").dialog('open'); 
						}
					}
					//tinhtien theo nhom loai kham
					var tongtien_vatlytrilieu=0;
					var tongtien_tthuat_pthuat=0;
					var tongtien_family_flanning=0;
					var tongtien_dieuduong=0;
					var tmp = $("#dtph_rowed5").jqGrid('getDataIDs'); 
					for(var i=0;i < tmp.length;i++){ 
						var rowData = $("#dtph_rowed5").getRowData(tmp[i]);
						if(rowData["IDNhomCLS"]==25){
							tongtien_vatlytrilieu=parseInt(tongtien_vatlytrilieu) + parseInt(rowData["dtph_phithuchien"]);
							$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
						}else if(rowData["IDNhomCLS"]==23){
							tongtien_tthuat_pthuat=parseInt(tongtien_tthuat_pthuat) + parseInt(rowData["dtph_phithuchien"]);
							$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
						}else if(rowData["IDNhomCLS"]==52){
							tongtien_family_flanning=parseInt(tongtien_family_flanning) + parseInt(rowData["dtph_phithuchien"]);
							$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_family_flanning);
						}else if(rowData["IDNhomCLS"]==26){
							tongtien_dieuduong=parseInt(tongtien_dieuduong) + parseInt(rowData["dtph_phithuchien"]);
							$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_dieuduong);
						}
					}//end for
					for(var i=0;i < tmp.length;i++){ 
					//alert(tongtien_vatlytrilieu+"-"+tongtien_tthuat_pthuat+"-"+tongtien_family_flanning+"-"+tongtien_dieuduong);
					var rowData = $("#dtph_rowed5").getRowData(tmp[i]);
					if(rowData["IDNhomCLS"]==25){
							$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_vatlytrilieu);
						}else if(rowData["IDNhomCLS"]==23){
							$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_tthuat_pthuat);
						}else if(rowData["IDNhomCLS"]==52){
							$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_family_flanning);
						}else if(rowData["IDNhomCLS"]==26){
							$('#dtph_rowed5').jqGrid('setCell',tmp[i],'TongTienTheoNhom',tongtien_dieuduong);
							}
					}//end for
					//end tong tien nhom
				}else{
					tooltip_message("Loại khám này đã thực hiện");
				}	
			});
		}
	}else{
		$('#dtph_rowed5').jqGrid('delRowData',tam);
	}
}

//end dieu tri phoi hop
//don thuoc
function create_donthuoc(){	
	 var searhicon = '<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-right: .3em;"></span></span>';
	 mydata=[];	 
	 $("#donthuoc_rowed3").jqGrid({	
		data:mydata,	 
		datatype: "local",		 	
		colNames:['','','','','','','','Tên thuốc', "Đường dùng","Giá bán", "Số lượng", "Tổng", "Cách dùng", "Thực hiện","idthuoc","Cách dùng chi tiết"],
		colModel:[
			{name:'id_donthuoc',index:'id_donthuoc',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'luu',index:'luu',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'trangthaidonthuoc',index:'trangthaidonthuoc',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'iddonthuocct',index:'iddonthuocct',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'id_dvt',index:'id_dvt',width:"10%",align:'center',hidden:true, editable: false },
			{name:'lavattu',index:'lavattu',width:"10%",align:'center',hidden:true, editable: false }  ,
			{name:'xoa',index:'xoa',width:"3%",align:'center',hidden:false, editable: false}  ,
			{name:'ID_Thuoc',index:'ID_Thuoc',width:"20%", align:'left',hidden:false, editable: true,edittype:"select", classes:'tenthuoc',editoptions:{value:window.thuoc},formatter: "select",editrules:{custom: true, custom_func: function(value, colName) {
                          return check_idthuoc(value,colName);
                        },formatter: function (cellValue, options, rowObject) {                    
                            return searhicon
                        }}
		    }, 
			{name:'ID_DuongDungThuoc',index:'ID_DuongDungThuoc', width:"10%",align:'left', editable: true,edittype:"select",editoptions:{value:window.duongdung},formatter: "select"},	
			{name:'Gia',index:'Gia', width:"5%",align:'right',hidden:false,formatter:'number', formatoptions:{decimalPlaces: 0}, editable: false},
			{name:'SoThuocThucXuat',index:'SoThuocThucXuat',width:"5%",formatter:currency_convert,align:'right',hidden:false, editable: true
			,editrules:{custom: true,required:true, custom_func: function(value, colName) {
                           var id_row = $('#donthuoc_rowed3').jqGrid('getGridParam', 'selrow')
                           return check_soluong(value,colName,id_row);
                        }}},
			{name:'ThanhTien',index:'ThanhTien',width:"5%",align:'right',hidden:true,formatter:'number', formatoptions:{decimalPlaces: 1}, editable: true},
			{name:'CachDungLieuDung',index:'CachDungLieuDung',width:"5%",align:'right',hidden:false, editable: true,editoptions:{dataEvents: [{ type: 'keyup', fn: function(e) {
				//setTimeout(function(){
					if(jwerty.is("enter",e)||jwerty.is("tab",e)){
							//be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
							//$("#donthuoc_rowed3").jqGrid('setRowData',$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
						//	jQuery("#donthuoc_rowed3").jqGrid('saveRow',$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'),null,null,{"extraparam" : {"oper":'add'} }, aftersave,null,null,null,"POST");
						//	$("#donthuoc_rowed3_iladd").removeClass('ui-state-disabled');
							//if(window.tonkhokhongdu==0){
								//$('#donthuoc_rowed3_iladd').click();
						//	}
						
					}
				//},500);
				}}]}},
			{name:'PhuongThucThucHien',index:'PhuongThucThucHien',width:"10%",align:'center',hidden:true, editable: true,edittype:"select",formatter:'select',editoptions:{value:"0:Hospital;1:Home;2:Seft",dataEvents: [{ type: 'keyup', fn: function(e) {
						be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
						$("#donthuoc_rowed3").jqGrid('setRowData',$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
						jQuery("#donthuoc_rowed3").jqGrid('saveRow',$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'), true);
							$("#donthuoc_rowed3_iladd").removeClass('ui-state-disabled');
							$('#donthuoc_rowed3_iladd').click();
				}}]}
				
				},
			{name:'idthuoc',index:'idthuoc',width:"10%",align:'center',hidden:true, editable: false }  ,
			//{name:'CachDungChiTiet',index:'CachDungChiTiet',width:"20%",align:'center',hidden:false, editable: true },
			{name:'CachDungChiTiet',index:'CachDungChiTiet',width:"20%",align:'left',hidden:false, editable: true,editoptions:{dataEvents: [{ type: 'keyup', fn: function(e) {
				//setTimeout(function(){
					if(jwerty.is("enter",e)||jwerty.is("tab",e)){
							be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
							$("#donthuoc_rowed3").jqGrid('setRowData',$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
							jQuery("#donthuoc_rowed3").jqGrid('saveRow',$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'),null,null,{"extraparam" : {"oper":'add'} }, aftersave,null,null,null,"POST");
							$("#donthuoc_rowed3_iladd").removeClass('ui-state-disabled');
							if(window.tonkhokhongdu==0){
								//$('#donthuoc_rowed3_iladd').click();
							}
					}
				//},500);
				}}]},classes:'cachdungchitiet'},
			                      
		],
		inline_esc:false,
		grid_mode:'',
		grid_move:"",
		grid_save_option:"",	
		column:["CachDungLieuDung"],
		func_column:["luoi_CachDungLieuDung"],	
		loadonce: true,
		local:true,
		scroll: false,		 
		modal:true,
        shrinkToFit: true,
		rowNum: 10000000,
		rowList:[],
		pager: '#prowed6',
		sortname: 'ID_LoaiKham',
		height:100,
		width:100,
		viewrecords: false,	
		ignoreCase:true,	
		sortorder: "asc",
	    grouping: true,
		// moi them
		inline_editrule:true,
		inline_esc:true,
		cellEdit: true,
		cellsubmit: 'clientArray',
		cell_move_enter:true,
		afterSaveCell : function ( rowid, cellname, value, iRow, iCol){	
			$('#'+iRow+'_ID_Thuoc_combobox,.dialog_dm_thuoc .ui-jqgrid-hbox').unbind("keyup");
			$('#'+iRow+'_ID_Thuoc_combobox,.dialog_dm_thuoc .ui-jqgrid-hbox').unbind("click");
			$('body').unbind("click");			
			return [true,'']
		},
		afterInsertRow: function(rowid, aData){
    	},
		pgbuttons: false, // disable page control like next, back button
        pgtext: null, // disable pager text like 'Page 0 of 10'	 
		serializeRowData: function (postdata) { 	
			
		},
		 onCellSelect: function (rowid,iCol,cellcontent,e) {
			// alert(iCol)
			if((iCol==6)){
				var rowData = jQuery('#donthuoc_rowed3').jqGrid ('getRowData',rowid);
				if(rowData['id_donthuoc']!=''){
					//alert(rowData['id_donthuoc']);
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_donthuoc&id_donthuoc='+window.iddonthuoc).done(function(data){
						if(data=="true"){
							  $('#donthuoc_rowed3').jqGrid('delRowData',rowid);		
							  if(window.donthuocxoa==''){
								  window.donthuocxoa=rowid;
							  }else{
								  window.donthuocxoa=window.donthuocxoa+','+rowid;
							  }
							$("#donthuoc_rowed3_ilcancel").click();
						}else{
							tooltip_message("Đơn thuốc đã xuất hoặc đã thanh toán");
						}				
					});
				}else{
					$('#donthuoc_rowed3').jqGrid('delRowData',rowid);	
					$("#donthuoc_rowed3_ilcancel").click();
				}
            } 
			 
			//alert(window.donthuocxoa);                    
        },
		afterEditCell: function (rowid, celname, value, iRow, iCol) {	// them cái này nữa
					window.cell_rowed6=celname;
					rowed6_select=rowid;	
					if((iCol==7)){
						var with_idthuoc=parseFloat($('#jqgh_donthuoc_rowed3_ID_Thuoc').width())-32;			
						$('#donthuoc_rowed3 #'+iRow+'_ID_Thuoc1').hide(); 
						combobox_inline_new('ID_Thuoc',iRow,'donthuoc_rowed3',create_Dm_thuoc_grid,window.grid_datathuoc,iRow,iRow,donthuoc_callback)
						
						$('#'+iRow+'_ID_Thuoc_combobox').keyup(function(e){					
							if (jwerty.is('enter',e)){
								$('#donthuoc_rowed3').jqGrid("nextCell",iRow,iCol);
							}
						})
						setTimeout(function(){
							$('#'+iRow+'_ID_Thuoc_combobox').focus();
							$('#'+iRow+'_ID_Thuoc_combobox').select();
						},10)
					}
					$("#"+iRow+"_SoThuocThucXuat").focusout(function(e) {
					  //  alert();
					});
					$("#"+iRow+"_"+celname).focusout(function(e) {
						$("#donthuoc_rowed3").saveCell(iRow,iCol);
					});
		
		}, 
		onSelectRow: function(id){	
	 		$('#'+window.rowed6_select).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"});
			window.rowed6_select=id;
		},
		ondblClickRow: function (rowId, rowIndex, columnIndex) {
			$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_donthuoc&id_donthuoc='+window.iddonthuoc).done(function(data){
				if(data=="true"){
					$("#prowed6 .ui-icon-pencil").click();
				}else{
					tooltip_message("Đơn thuốc đã xuất hoặc đã thanh toán");
				}				
			});
			//}
 		},
		loadComplete: function(data) {
			var ids = jQuery("#donthuoc_rowed3").jqGrid('getDataIDs');
			if(ids.length>0){
				var rowData = jQuery('#donthuoc_rowed3').jqGrid ('getRowData',ids[0] );
				window.iddonthuoc=rowData['id_donthuoc'];
				//alert(window.iddonthuoc);
			}
			window.donthuoc='';
			for(var i=0;i < ids.length;i++){
				var rowData = jQuery('#donthuoc_rowed3').jqGrid ('getRowData',ids[i] );	
				/*if(window.donthuoc==''){
					window.donthuoc=$("#"+ids[i]+" .tenthuoc").html();
				}else{
					window.donthuoc=window.donthuoc+', '+$("#"+ids[i]+" .tenthuoc").html();
				}*/
				var cl = ids[i];
				//alert(cl)
				be = '<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
				$("#donthuoc_rowed3").jqGrid('setRowData',ids[i],{xoa:be});	 	
			}
			//$("#tonghopylenh").val("Cận lâm sàng: "+window.canlamsang+"\nĐiều trị phối hợp: "+window.dieutriphoihop+"\nĐơn thuốc: "+window.donthuoc+"\nĐơn thuốc trả lại: "+window.donthuoctralai+"\nY lệnh khác: "+$("#ylenhkhac").val()); 

		},
		caption: 'Đơn thuốc <span style="margin-left:50px;">Toa mẫu: <input type="text" id="toamau" placeholder="Chọn toa mẫu" ></span> <a id="add_new" class="fm-button ui-state-default ui-corner-all " style="margin-left:30px!important;vertical-align:top;width:16px;height:12px;"  ><span style="margin-top:-2px;margin-right:-22px!important" class="ui-icon ui-icon-circle-plus"></span></a>',
		editurl:'clientArray',
	});
/*	$("#donthuoc_rowed3").jqGrid('bindKeys', {"onEnter":function( rowid ) {						
					$("#prowed6 .ui-icon-pencil").click();				
			} } );*/
	$("#donthuoc_rowed3").jqGrid('navGrid',"#prowed6",{add: false, edit: false, del: false, search: false, refresh: false,closeAfterEdit: true,clearAfterAdd :true,navkeys : [ true, 38, 40 ]});
	$("#donthuoc_rowed3").jqGrid('inlineNav', '#prowed6', {add: true, addtext: 'Thêm mới', edittext: '', edit: true,save:false,
            addParams: {
				keys:true,
                position: "last",
                addRowParams: {
					keys:true,                  
                    aftersavefunc: function(rowId, response,lastsel) {
						//tong_thanhtien=tong_thanhtien+ parseFloat($('#rowed6').jqGrid('getCell',rowId, 'ThanhTien'));
						//destroy_combobox_inline('TenBietDuoc',rowId,'donthuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId);
						
						destroy_combobox_inline_new('ID_Thuoc',rowId,'donthuoc_rowed3');	
						$('#donthuoc_rowed3').focus();	
						var current_rowed6=$('#donthuoc_rowed3').jqGrid('getCell',rowId, 'ID_Thuoc')
						
						$('#'+rowId).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"})
						$("#" + rowId).attr("id",current_rowed6);
						$('#'+current_rowed6).removeClass("ui-state-highlight");						
						be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
						$("#donthuoc_rowed3").jqGrid('setRowData',current_rowed6,{xoa:be});
						
						//alert(rowId);
						setTimeout(function(){							
						   $("#prowed6 .ui-icon-plus").click();	
						   var ids = jQuery("#donthuoc_rowed3").jqGrid('getDataIDs');	
						   $('#'+ids[ids.length-1]+'_ID_Thuoc1').focus();		
						},200);
						
                    },
					oneditfunc: function(rowId) {	
						combobox_inline_new('ID_Thuoc',rowId,'donthuoc_rowed3',create_Dm_thuoc_grid,window.grid_datathuoc,0,1,donthuoc_callback)//new
						inline_enter(rowId);
					},	
                    afterrestorefunc: function(rowId) {	
//destroy_combobox_inline('TenBietDuoc',rowId,'donthuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId)	;
						destroy_combobox_inline_new('ID_Thuoc',rowId,'donthuoc_rowed3');					
						$("#donthuoc_rowed3").jqGrid('bindKeys');
						$('#donthuoc_rowed3').focus();						
                    }				 
                }
            	},	
            editParams: {
				keys:true,				 
				 	aftersavefunc: function(rowId, response,lastsel) {
					//	destroy_combobox_inline('TenBietDuoc',rowId,'donthuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId)
						destroy_combobox_inline_new('ID_Thuoc',rowId,'donthuoc_rowed3');		
						$('#donthuoc_rowed3').focus();
						 setTimeout(function(){
							 $("#prowed6 .ui-icon-plus").click();
						},200);	
                    },					 	
                	oneditfunc: function(rowId) {	
	combobox_inline_new('ID_Thuoc',rowId,'donthuoc_rowed3',create_Dm_thuoc_grid,window.grid_datathuoc,rowId,rowId,donthuoc_callback)//new	
					//create_combobox_inline('TenBietDuoc',rowId,'donthuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId,create_Dm_thuoc_grid,data_thuoc,$('#donthuoc_rowed3 #'+rowId+'_TenBietDuoc').val(),inline_enter,'TenBietDuoc_combobox');
						inline_enter(rowId);
					},	
                    afterrestorefunc: function(rowId) {	
					$("#donthuoc_rowed3").jqGrid('bindKeys');
					//destroy_combobox_inline('TenBietDuoc',rowId,'donthuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId);
					destroy_combobox_inline_new('ID_Thuoc',rowId,'donthuoc_rowed3');									   
					},	 
			}
       	 });      
		// $('#del_rowed6').hide();
		// $('#refresh_rowed6,#rowed6_iladd,#rowed6_iledit,#rowed6_ilsave,#rowed6_ilcancel').hide();  
	$("#add_new").click(function(e){
		$.post('resource.php?module=web_services&function=get_link&action=index&folder=danh_muc_donthuocmau:').done(function(data) {
		elem=1 + Math.floor(Math.random() * 1000000000);
		width=99;
		height=99;
		var folder= data.split(';');
		var links='resource.php?module='+folder[0]+'&view='+folder[1]+'&id_form='+folder[2];				  				  
		dialog_add_dm("Đơn thuốc mẫu",width,height,elem,links,callback_themdonthuocmau);   
		})
	});
} 

function create_Dm_thuoc_grid(elem,datalocal){	
		datalocal=jQuery.parseJSON(datalocal);	 
		 $(elem).jqGrid({
		datastr:datalocal,	
		datatype: "jsonstring" ,
		colNames:['Tên thuốc', 'Hoạt chất','Tên biệt dược', 'Tên nhóm thuốc','','','','bhyt'],
		colModel:[			
			{name:'TenBietDuoc',index:'TenBietDuoc', search: true}, 
			{name:'TenNhomThuoc',index:'TenNhomThuoc', search: true, searchoptions: { sopt: ['cn'] }},					 
			{name:'MaThuoc',index:'MaThuoc',hidden :true},	 	
			{name:'ID_DuongDung',index:'ID_DuongDung',hidden :true},	
			{name:'DonGia',index:'DonGia',hidden :true},	
			{name:'ID_dvt',index:'ID_dvt',hidden :true},	
			{name:'LaThuoc',index:'LaThuoc',hidden :true},	 	 
			{name:'bhyt',index:'bhyt',hidden :true},
		],
		hidegrid: false,
		gridview: true,
		loadonce: false,
		scrollrows : true,
		scroll: false,		 
		modal:true,	 
		rowNum: 200,
		rowList:[],
		pager: '#prowed_DM_thuoc_donthuoc',
		sortname: 'ID_Thuoc',
		height:($(window).height() / 100 * parseFloat(40)).toFixed(0),
		width: (($(window).width() / 100 * parseFloat(58)).toFixed(0)),
		viewrecords: true,	
		ignoreCase:true,
		shrinkToFit:true,
		cmTemplate: {sortable:false},		
		sortorder: "desc",
		serializeRowData: function (postdata) { 
		},
		onSelectRow: function(id){	
			$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow');
			
			var rowData = $(elem).getRowData(id);		  
			var duongdung_tam=rowData['ID_DuongDung'].split(',');
			window.idthuocchon=rowData['MaThuoc'];
			window.idthuockedon=id;
			//if($(elem).data('clicked')){
			//alert();	
			//}
			//if($(elem).data('clicked')){
			//	alert(rowData['DonGia']);
			//	$('#donthuoc_rowed3').jqGrid('setCell', 'jqg2', 'Gia', '2222'); ID_DuongDungThuoc
			var dd=rowData['ID_DuongDung'].split(',');
				if(rowData['DonGia']<1){
					window.n_chuacogiaban=1;				
					$( "#val_donvitinh" ).val(rowData['ID_dvt']);
					$( "#val_lathuoc" ).val(rowData['LaThuoc']);
					$( "#val_dongia" ).val(rowData['DonGia']);
					$('#donthuoc_rowed3 #'+ $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+'_ID_DuongDungThuoc').val(dd);
					$("#_tenthuoc").html(rowData['TenBietDuoc']);
					$('#donthuoc_rowed3').jqGrid("setCell", $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'), "id_dvt",rowData['ID_dvt'] );
					$('#donthuoc_rowed3').jqGrid("setCell", $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'), "lavattu",rowData['LaThuoc'] );
					$('#donthuoc_rowed3').jqGrid("setCell", $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'), "Gia",rowData['DonGia'] );
					$('#dm_duongdung').jqGrid("setSelection",duongdung_tam[0], true);
					$('#donthuoc_rowed3 #'+ $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+'_ID_DuongDungThuoc').val(duongdung_tam[0]);	
					$('#donthuoc_rowed3').jqGrid("setCell", $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'), "idthuoc",window.idthuocchon );
					//alert(duongdung_tam[0]);
					//var columnNames = $('#dm_duongdung').jqGrid('getGridParam','colModel');
					//ten = $('#dm_duongdung').jqGrid('getCell', duongdung_tam[0], columnNames[0].name);	 idthuoc					
					
					}else{
						$('#donthuoc_rowed3 #'+ $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+'_ID_DuongDungThuoc').val(dd);
						$('#donthuoc_rowed3').jqGrid("setCell", $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'), "id_dvt",rowData['ID_dvt'] );
						$('#donthuoc_rowed3').jqGrid("setCell", $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'), "lavattu",rowData['LaThuoc'] );
						$('#donthuoc_rowed3').jqGrid("setCell", $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'), "Gia",rowData['DonGia'] );
						$('#donthuoc_rowed3').jqGrid("setCell", $("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow'), "idthuoc",window.idthuockedon );
						$('#dm_duongdung').jqGrid("setSelection",duongdung_tam[0], true);
						//$('#donthuoc_rowed3 #'+id_rowed6_edit+'_ID_DuongDungThuoc').val(duongdung_tam[0]);	
						//var columnNames = $('#dm_duongdung').jqGrid('getGridParam','colModel');
											
						window.n_chuacogiaban=0;
					}
			//}
			
						
		},
		ondblClickRow: function (id, rowIndex, columnIndex) {
				
 		},
		loadComplete: function(data) {				
			ids_DM_thuoc=$('#DM_thuoc_donthuoc').jqGrid('getDataIDs');	
			for(i=0;i<=ids_DM_thuoc.length;i++){
				var rowData = $(elem).getRowData(i);	
				if(rowData['bhyt']==1){					
					$("#DM_thuoc_donthuoc #" + ids_DM_thuoc[i]).find("td").css("background-color", "#CCC!important");
				}
			}
		},	  		
	});	
	//$("#DM_thuoc_donthuoc").jqGrid('navGrid',"#prowed_DM_thuoc_donthuoc",{add: false, edit: false, del: false, search: true,closeAfterEdit: true,clearAfterAdd :true,closeOnEscape : true });				 
	 //$("#DM_thuoc_donthuoc").jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"bw"});
	 //$("#DM_thuoc_donthuoc").jqGrid('bindKeys', {} );	
	 $(elem).jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
	 $(elem).jqGrid('bindKeys', {} );	
} 	
function donthuoc_callback(tam){
	//alert(tam);//jqg7_ID_Thuoc_combobox
	window.n_kiemtraenter=0;
	$("#"+tam).keydown(function(e) {
	if (jwerty.is("enter",e)||jwerty.is("tab",e)) {
		window.n_kiemtraenter=1;
		setTimeout(function(){
			if($("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").val()==''){// jqg4_ID_Thuoc_combobox
				$( "#dialog-thuoctrong" ).dialog('open'); 
				//$("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").focus();  jqg6_ID_Thuoc
			}else{
				var tmp1 = $("#donthuoc_rowed3").jqGrid('getDataIDs'); 
				window.loithuocdake=0;
				for(var i=0;i<tmp1.length-1;i++){
					var d=i+1;
					var rowData = $("#donthuoc_rowed3").getRowData(tmp1[i]);	
						//console.log(window.idthuockedon+'=='+rowData['ID_Thuoc'])
						//console.log(typeof $("#"+d+'_'+tam).val());
						if(typeof $("#"+d+'_'+tam).val() === 'object' || typeof $("#"+d+'_'+tam).val() === 'undefined'){
							//console.log(window.idthuockedon+'=='+rowData['ID_Thuoc'])
						    if(window.idthuockedon==rowData['ID_Thuoc']){
								window.loithuocdake=1;
								$( "#donthuoc_rowed3_iledit" ).click();
								$( "#dialog-thuocdake" ).dialog('open'); 
							}
						}
				}
				if(window.loithuocdake==0){
					if(window.n_chuacogiaban==1){
						setTimeout(function(){
							$( "#dialog-thuochuacogiaban" ).dialog('open');
							},100);	
							delete window.n_chuacogiaban;
					}
				}
			}
			if(window.loithuocdake==0){
				
				$("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_SoThuocThucXuat").focus();
				$("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_SoThuocThucXuat").select();	
			}
		},100);
	}
	});
	if(window.n_kiemtraenter==0){
		$("#"+tam).focusout(function(e) {
			if($("#"+tam).val()!=''){
				var tmp1 = $("#donthuoc_rowed3").jqGrid('getDataIDs'); 
				window.loithuocdake=0;
				for(var i=0;i<tmp1.length-1;i++){
					var rowData = $("#donthuoc_rowed3").getRowData(tmp1[i]);	
					   if(window.idthuockedon==rowData['ID_Thuoc']){
							window.loithuocdake=1;
							$( "#dialog-thuocdake" ).dialog('open'); 
							$("#"+tam).val('');
						}
				}
			}
   		});	
	}
	window.n_kiemtraenter=0;
}
function inline_enter(rowid){	
	$('#donthuoc_rowed3 #'+rowid+'_ID_DuongDungThuoc,#donthuoc_rowed3 #'+rowid+'_SoThuocThucXuat,#donthuoc_rowed3 #'+rowid+'_ThanhTien,#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung,#donthuoc_rowed3 #'+rowid+'_PhuongThucThucHien,#donthuoc_rowed3 #'+rowid+'_CachDungChiTiet').unbind('keydown')
	$('#donthuoc_rowed3 #'+rowid+'_ID_DuongDungThuoc,#donthuoc_rowed3 #'+rowid+'_SoThuocThucXuat,#donthuoc_rowed3 #'+rowid+'_ThanhTien,#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung,#donthuoc_rowed3 #'+rowid+'_PhuongThucThucHien,#donthuoc_rowed3 #'+rowid+'_CachDungChiTiet').bind('keydown',function(e){
		if ((jwerty.is('enter',e))||(jwerty.is('tab',e))){
			if($('#donthuoc_rowed3 #'+rowid+'_ID_DuongDungThuoc').is(":focus")){
				setTimeout(function(){
					if(window.loithuocdake==0){
						$('#donthuoc_rowed3 #'+rowid+'_SoThuocThucXuat').focus();
						$('#donthuoc_rowed3 #'+rowid+'_SoThuocThucXuat').select();
					}
				},500);			
			}
			if($('#donthuoc_rowed3 #'+rowid+'_SoThuocThucXuat').is(":focus")){
					var slx=$('#donthuoc_rowed3 #'+rowid+'_SoThuocThucXuat').val().split(',');
					if(slx[0]>0){
						setTimeout(function(){
							$('#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung').focus();
							$('#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung').select();
						},500);	
					}else{
						setTimeout(function(){
							$( "#dialog-soluongxuat" ).dialog('open');
						},50);
					}
			}
			if($('#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung').is(":focus")){
				setTimeout(function(){
					//var rowData_DonThuoc = jQuery('#donthuoc_rowed3').jqGrid ('getRowData', rowid);	
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=todieutri_getcachdung&id_thuoc='+$('#donthuoc_rowed3 #'+rowid+'_ID_Thuoc').val()+'&soluong='+$('#donthuoc_rowed3 #'+rowid+'_SoThuocThucXuat').val()+'&phientoa='+$('#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung').val()).done(function(data){
						//alert(data);
						$('#donthuoc_rowed3 #'+rowid+'_CachDungChiTiet').val(data);
					});
					$('#donthuoc_rowed3 #'+rowid+'_CachDungChiTiet').focus();
					$('#donthuoc_rowed3 #'+rowid+'_CachDungChiTiet').select();
					if($('#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung').val()==''){
						$('#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung').val(0);
					}
				},200);			
			}
			if($('#donthuoc_rowed3 #'+rowid+'_CachDungChiTiet').is(":focus")){
				setTimeout(function(){	
					$('#donthuoc_rowed3_iladd').removeClass('ui-state-disabled');					
				   $("#prowed6 .ui-icon-plus").click();
				},200);		
			}
		}
		if(jwerty.is("shift+tab",e)){
			//alert();
			if($('#donthuoc_rowed3 #'+rowid+'_CachDungChiTiet').is(":focus")){
				setTimeout(function(){	
					$('#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung').focus()
				},50);		
			}
			/*if($('#donthuoc_rowed3 #'+rowid+'_PhuongThucThucHien').is(":focus")){
				setTimeout(function(){
					$('#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung').focus()
				},50);			
			}*/
			if($('#donthuoc_rowed3 #'+rowid+'_CachDungLieuDung').is(":focus")){
				setTimeout(function(){
					//alert();
					$('#donthuoc_rowed3 #'+rowid+'_SoThuocThucXuat').focus()
				},50);			
			}
			if($('#donthuoc_rowed3 #'+rowid+'_SoThuocThucXuat').is(":focus")){
				setTimeout(function(){
					$('#donthuoc_rowed3 #'+rowid+'_ID_DuongDungThuoc').focus()
				},50);			
			}
			if($('#donthuoc_rowed3 #'+rowid+'_ID_DuongDungThuoc').is(":focus")){
				setTimeout(function(){
					$('#donthuoc_rowed3 #'+rowid+'_ID_Thuoc_combobox').focus()
				},50);			
			}

		}//if shift tab
	})
}

//end don thuoc

// tra lai thuoc
function create_tralaithuoc(){	
	 var searhicon = '<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-right: .3em;"></span></span>';
	 mydata=[];	 
	 $("#tralaithuoc_rowed3").jqGrid({	
		data:mydata,	 
		datatype: "local",		 	
		colNames:['','','','','Tên thuốc','Giá vốn',"Số lượng trả", "Số lô hệ thống", "Số lô nhà sản xuất","ID Đơn thuốc", "Hạn sử dụng",'idthuoc','giaban'],
		colModel:[	
			{name:'luu',index:'luu',width:"8%",align:'right',hidden:true, editable: false}  ,	
			{name:'iddonthuoctralai',index:'iddonthuoctralai',width:"8%",align:'right',hidden:true, editable: false}  ,	
			{name:'iddonthuocct',index:'iddonthuocct',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'xoa',index:'xoa',width:"3%",align:'center',hidden:false, editable: false}  ,
			{name:'ID_Thuoc_Tra',index:'ID_Thuoc_Tra',width:"30%", align:'left',hidden:false, editable: true,edittype:"select",classes:'tenthuoctralai',editoptions:{value:window.thuoc},formatter: "select"}, 
			{name:'Gia',index:'Gia', width:"8%",align:'right',hidden:false,formatter:'number', formatoptions:{decimalPlaces: 0}, editable: false},
			{name:'soluongtralai',index:'soluongtralai',width:"8%",formatter:currency_convert,align:'right',editrules: {required: true},hidden:false, editable: true,editoptions:{dataEvents: [{ type: 'keyup', fn: function(e) {
				if(jwerty.is("enter",e)||jwerty.is("tab",e)){
				/*	setTimeout(function(){
						if(window.soluongtralaitrong==0 &&window.loithuocdatralai==0 && window.thuocnull==0){
							be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
							$("#tralaithuoc_rowed3").jqGrid('setRowData',$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
							jQuery("#tralaithuoc_rowed3").jqGrid('saveRow',$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), true);
								$("#tralaithuoc_rowed3_iladd").removeClass('ui-state-disabled');
								$('#tralaithuoc_rowed3_iladd').click();
						}
					},1000);*/
				}
				}}]}},
			{name:'solohethong',index:'solohethong',width:"8%",align:'left',hidden:false, editable: false},
			{name:'solonhasanxuat',index:'solonhasanxuat',width:"8%",align:'left',hidden:false, editable: false},
			{name:'iddonthuoc',index:'iddonthuoc',width:"8%",align:'left',hidden:false, editable: false},
			{name:'hansudung',index:'hansudung',width:"8%",align:'left',hidden:false, editable: false},		
			{name:'idthuoc',index:'idthuoc',width:"8%",align:'left',hidden:true, editable: false},		 
			{name:'giaban',index:'giaban',width:"8%",align:'left',hidden:true, editable: false},		                      
		],
		inline_esc:false,
		grid_mode:'',
		grid_move:"",
		grid_save_option:"",	
		column:["CachDungLieuDung"],
		func_column:["luoi_CachDungLieuDung"],	
		loadonce: true,
		local:true,
		scroll: false,		 
		modal:true,
        shrinkToFit: true,
		rowNum: 10000000,
		rowList:[],
		pager: '#ptralaithuoc_rowed3',
		sortname: 'ID_LoaiKham',
		height:100,
		width:100,
		viewrecords: false,	
		ignoreCase:true,	
		sortorder: "asc",
	    grouping: true,
		afterInsertRow: function(rowid, aData){
    	},
		pgbuttons: false, // disable page control like next, back button
        pgtext: null, // disable pager text like 'Page 0 of 10'	 
		serializeRowData: function (postdata) { 	
			
		},
		 onCellSelect: function (rowid,iCol,cellcontent,e) {
			// alert(iCol)
			if((iCol==3)){
              $('#tralaithuoc_rowed3').jqGrid('delRowData',rowid);
			  if(window.donthuoctralaixoa==''){
				  window.donthuoctralaixoa=rowid;
			  }else{
				  window.donthuoctralaixoa=window.donthuoctralaixoa+','+rowid;
				  }	
			  $("#tralaithuoc_rowed3_ilcancel").click();	
            }                      
        }, 
		onSelectRow: function(id){	
	 		$('#'+window.rowed6_select).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"});
			window.rowed6_select=id;
		},
		ondblClickRow: function (rowId, rowIndex, columnIndex) {
			//var rowData = $("#rowed3").getRowData( $("#rowed3").jqGrid('getGridParam', 'selrow'));				
        //	if((rowData['ID_trangthai']=='DangKham')){
				$("#ptralaithuoc_rowed3 .ui-icon-pencil").click();	
			//}
 		},
		loadComplete: function(data) {
			
			var ids = jQuery("#tralaithuoc_rowed3").jqGrid('getDataIDs');  
			window.donthuoctralai='';
			/*if(ids.length>0){
				var rowData = jQuery('#tralaithuoc_rowed3').jqGrid ('getRowData', ids[0]);
			window.idtralaithuoc=rowData['iddonthuoctralai'];	
			//alert(window.idtralaithuoc);
			}*/
			for(var i=0;i<ids.length;i++){
				var rowData2 = jQuery('#tralaithuoc_rowed3').jqGrid ('getRowData', ids[i]);	
				//if(window.donthuoctralai==''){
				//	window.donthuoctralai=$("#tralaithuoc_rowed3 #"+ids[i]+" .tenthuoctralai").html();
				//	}else{
				//		window.donthuoctralai=window.donthuoctralai+", "+$("#tralaithuoc_rowed3 #"+ids[i]+" .tenthuoctralai").html();
				//	}
				//alert("#"+ids[i]+" .tenthuoctralai")
				var cl = ids[i];
				//alert(cl)
				be = '<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
				$("#tralaithuoc_rowed3").jqGrid('setRowData',ids[i],{xoa:be});	 	
			}
			//alert(window.donthuoctralai);
			//$("#tonghopylenh").val("Cận lâm sàng: "+window.canlamsang+"\nĐiều trị phối hợp: "+window.dieutriphoihop+"\nĐơn thuốc: "+window.donthuoc+"\nĐơn thuốc trả lại: "+window.donthuoctralai+"\nY lệnh khác: "+$("#ylenhkhac").val()); 

		},
		caption: "Đơn thuốc trả lại",
		editurl:'clientArray',
	});
/*	$("#tralaithuoc_rowed3").jqGrid('bindKeys', {"onEnter":function( rowid ) {						
					$("#ptralaithuoc_rowed3 .ui-icon-pencil").click();				
			} } );*/
	$("#tralaithuoc_rowed3").jqGrid('navGrid',"#ptralaithuoc_rowed3",{add: false, edit: false, del: false, search: false, refresh: false,closeAfterEdit: true,clearAfterAdd :true,navkeys : [ true, 38, 40 ]});
	$("#tralaithuoc_rowed3").jqGrid('inlineNav', '#ptralaithuoc_rowed3', {add: true, addtext: 'Thêm mới', edittext: '', edit: true,save:false,
            addParams: {
				keys:true,
                position: "last",
                addRowParams: {
					keys:true,                  
                    aftersavefunc: function(rowId, response,lastsel) {
						//tong_thanhtien=tong_thanhtien+ parseFloat($('#rowed6').jqGrid('getCell',rowId, 'ThanhTien'));
						//destroy_combobox_inline('TenBietDuoc',rowId,'tralaithuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId);
						
						destroy_combobox_inline_new('ID_Thuoc_Tra',rowId,'tralaithuoc_rowed3');	
						$('#tralaithuoc_rowed3').focus();	
						var current_rowed6=$('#tralaithuoc_rowed3').jqGrid('getCell',rowId, 'ID_Thuoc_Tra')
						$('#'+rowId).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"})
						$("#" + rowId).attr("id",current_rowed6);
						$('#'+current_rowed6).removeClass("ui-state-highlight");						
						be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
						$("#tralaithuoc_rowed3").jqGrid('setRowData',current_rowed6,{xoa:be});
						
						//alert(rowId);
						setTimeout(function(){							
						   $("#ptralaithuoc_rowed3 .ui-icon-plus").click();	
						   var ids = jQuery("#tralaithuoc_rowed3").jqGrid('getDataIDs');	
						   $('#'+ids[ids.length-1]+'_ID_Thuoc_Tra1').focus();		
						},200);
						
                    },
					oneditfunc: function(rowId) {	
						combobox_inline_new('ID_Thuoc_Tra',rowId,'tralaithuoc_rowed3',create_Dm_thuoc_grid2,window.grid_datathuoc_tralai,0,1,tralaithuoc_callback)//new
						inline_enter2(rowId);
					},	
                    afterrestorefunc: function(rowId) {	
//destroy_combobox_inline('TenBietDuoc',rowId,'tralaithuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId)	;
						destroy_combobox_inline_new('ID_Thuoc_Tra',rowId,'tralaithuoc_rowed3');					
						$("#tralaithuoc_rowed3").jqGrid('bindKeys');
						$('#tralaithuoc_rowed3').focus();						
                    }				 
                }
            	},	
            editParams: {
				keys:true,				 
				 	aftersavefunc: function(rowId, response,lastsel) {
					//	destroy_combobox_inline('TenBietDuoc',rowId,'tralaithuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId)
						destroy_combobox_inline_new('ID_Thuoc_Tra',rowId,'tralaithuoc_rowed3');		
						$('#tralaithuoc_rowed3').focus();
						 setTimeout(function(){
							 $("#ptralaithuoc_rowed3 .ui-icon-plus").click();
						},200);	
						
                    },					 	
                	oneditfunc: function(rowId) {	
					combobox_inline_new('ID_Thuoc_Tra',rowId,'tralaithuoc_rowed3',create_Dm_thuoc_grid2,window.grid_datathuoc_tralai,rowId,rowId,tralaithuoc_callback)//new	
					//create_combobox_inline('TenBietDuoc',rowId,'tralaithuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId,create_Dm_thuoc_grid,data_thuoc,$('#tralaithuoc_rowed3 #'+rowId+'_TenBietDuoc').val(),inline_enter,'TenBietDuoc_combobox');
						inline_enter2(rowId);
						
					},	
                    afterrestorefunc: function(rowId) {	
					$("#tralaithuoc_rowed3").jqGrid('bindKeys');
					//destroy_combobox_inline('TenBietDuoc',rowId,'tralaithuoc_rowed3','#dialog_dm_thuoc_'+rowId,'#DM_thuoc_'+rowId);
					destroy_combobox_inline_new('ID_Thuoc_Tra',rowId,'tralaithuoc_rowed3');									   
					},	 
			}
       	 });      
		// $('#del_rowed6').hide();
		// $('#refresh_rowed6,#rowed6_iladd,#rowed6_iledit,#rowed6_ilsave,#rowed6_ilcancel').hide();  
		           
} 

function create_Dm_thuoc_grid2(elem,datalocal){	
		datalocal=jQuery.parseJSON(datalocal);	 
		$(elem).jqGrid({
		datastr:datalocal,	
		datatype: "jsonstring" ,
		colNames:['Tên biệt dược','ID Đơn thuốc', 'Đơn giá vốn','Số lượng', 'ĐVT','Số lô HT','Số lô NSX','Ngày kê đơn','Ngày hết hạn','Giá bán','ID Thuốc'],
		colModel:[
					
			{name:'TenBietDuoc',index:'TenBietDuoc',hidden :false,width:'20%', search: true, searchoptions: { sopt: ['cn'] }}, 
			{name:'ID_DonThuoc',index:'ID_DonThuoc',hidden :false,width:'10%'}, 
			{name:'DonGia',index:'DonGia',hidden :false,width:'10%',formatter:'number', formatoptions:{decimalPlaces: 0}},
			{name:'Soluong',index:'Soluong',hidden :false,width:'10%'},					 
			{name:'DonViTinh',index:'DonViTinh',hidden :false,width:'10%'},	 	
			{name:'SoLoHeThong',index:'SoLoHeThong',hidden :false,width:'10%'},	
			{name:'SoLoNSX',index:'SoLoNSX',hidden :false,width:'10%'},
			{name:'NgayKeDon',index:'NgayKeDon',hidden :false,width:'10%'},	
			{name:'NgayHetHan',index:'NgayHetHan',hidden :false,width:'10%'},	
			{name:'GiaBan',index:'GiaBan',hidden :false,width:'10%'},	
			{name:'ID_Thuoc',index:'ID_Thuoc',hidden :false,width:'10%'},	  	 
			
		],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scrollrows : true,
		scroll: false,		 
		modal:true,	 
		rowNum: 200,
		rowList:[],
		pager: '#prowed_DM_thuoc',
		sortname: 'ID_Thuoc',
		height:($(window).height() / 100 * parseFloat(40)).toFixed(0),
		width: (($(window).width() / 100 * parseFloat(58)).toFixed(0)),
		viewrecords: true,	
		ignoreCase:true,
		shrinkToFit:true,
		cmTemplate: {sortable:false},		
		sortorder: "desc",
		serializeRowData: function (postdata) { 
		},
		onSelectRow: function(id){
		//if($(elem).data('clicked')){
			$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow');   //idthuoc
			var rowData = $(elem).getRowData(id);
			window.soluongtralaitoida=rowData['Soluong'];
			//alert(window.soluongtralaitoida);
			window.id_thuoctralai=rowData['ID_Thuoc'];
			window.id_donthuoctralai=rowData['ID_DonThuoc'];
			$('#tralaithuoc_rowed3').jqGrid("setCell", $("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), "Gia",rowData['DonGia'] );
			$('#tralaithuoc_rowed3').jqGrid("setCell", $("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), "solohethong",rowData['SoLoHeThong'] );	
			$('#tralaithuoc_rowed3').jqGrid("setCell", $("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), "solonhasanxuat",rowData['SoLoNSX'] );
			$('#tralaithuoc_rowed3').jqGrid("setCell", $("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), "iddonthuoc",rowData['ID_DonThuoc'] );
			$('#tralaithuoc_rowed3').jqGrid("setCell", $("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), "hansudung",rowData['NgayHetHan'] );	 
			$('#tralaithuoc_rowed3').jqGrid("setCell", $("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), "idthuoc",window.id_thuoctralai );
			$('#tralaithuoc_rowed3').jqGrid("setCell", $("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), "giaban",rowData['GiaBan'] ); 
		//}

		},
		ondblClickRow: function (id, rowIndex, columnIndex) {
				
 		},
		loadComplete: function(data) {				
		},	  		
	});	
	// $("#DM_thuoc").jqGrid('navGrid',"#prowed_DM_thuoc",{add: false, edit: false, del: false, search: true,closeAfterEdit: true,clearAfterAdd :true,closeOnEscape : true });				 
	// $("#DM_thuoc").jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
	// $("#DM_thuoc").jqGrid('bindKeys', {} );	
	 $(elem).jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
	 $(elem).jqGrid('bindKeys', {} );	
} 	
function tralaithuoc_callback(tam){
	$("#"+tam).keydown(function(e) {
    	if (jwerty.is("enter",e)||jwerty.is("tab",e)) {
			window.thuocnull=0;
			//$("#tralaithuoc_rowed3 #"+$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_soluongtralai").focus();
			//alert($("#tralaithuoc_rowed3 #"+$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").val());
			setTimeout(function(){
				if($("#tralaithuoc_rowed3 #"+tam).val()==''){
					window.thuocnull=1;
					$( "#dialog-thuoctralaitrong" ).dialog('open');
				}else{
					window.loithuocdatralai=0;
					var tmp1 = $("#tralaithuoc_rowed3").jqGrid('getDataIDs'); 
					for(var i=0;i<tmp1.length-1;i++){
						var rowData = $("#tralaithuoc_rowed3").getRowData(tmp1[i]);	
							//alert(window.id_thuoctralai+'=='+rowData['idthuoc']+'&&'+window.id_donthuoctralai+'=='+rowData['iddonthuoc']);							
						   if(window.id_thuoctralai==rowData['idthuoc'] && window.id_donthuoctralai==rowData['iddonthuoc'] ){
								window.loithuocdatralai=1;
								$( "#dialog-thuoctralaidaco" ).dialog('open'); 
							}
					}
					if(window.loithuocdatralai==0 && window.thuocnull==0){
					//	alert(2);
						$("#tralaithuoc_rowed3 #"+$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_soluongtralai").focus();
						$("#tralaithuoc_rowed3 #"+$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_soluongtralai").select();	
					}
				}
			},100);
		}
		
	});
}

function inline_enter2(rowid){
$('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai,#tralaithuoc_rowed3 #'+rowid+'_solonhasanxuat,#tralaithuoc_rowed3 #'+rowid+'_hansudung').unbind('keydown')
	$('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai,#tralaithuoc_rowed3 #'+rowid+'_solonhasanxuat,#tralaithuoc_rowed3 #'+rowid+'_hansudung').bind('keydown',function(e){
			
	$('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai').keyup(function(e) {
		if($('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai').is(":focus")){
		//	alert(window.soluongtralaitoida);
		   var sltralai2=$('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai').val().split(',');
		 	var sltratoida2=window.soluongtralaitoida.split('.');
			//alert(sltralai2[0]+'>'+sltratoida[0]);
			if(parseInt(sltralai2[0])>parseInt(sltratoida2[0])){
				$('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai').val(parseInt(sltratoida2[0]));
			}
		}
    });
		if ((jwerty.is('enter',e))||(jwerty.is('tab',e))){
			if($('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai').is(":focus")){
				
				var sltralai=$('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai').val().split(',');
				var sltratoida=window.soluongtralaitoida.split('.');
					//alert(parseInt(sltralai[0]));
					if(parseInt(sltralai[0])>0){
						if(parseInt(sltralai[0])>parseInt(sltratoida[0])){
							window.soluongtralaisai=1;	
						}else{
							var tmp1 = $("#tralaithuoc_rowed3").jqGrid('getDataIDs'); 
							for(var i=0;i<tmp1.length-1;i++){
								var rowData = $("#tralaithuoc_rowed3").getRowData(tmp1[i]);	
									//alert(window.id_thuoctralai+'=='+rowData['idthuoc']+'&&'+window.id_donthuoctralai+'=='+rowData['iddonthuoc']);							
								   if(window.id_thuoctralai==rowData['idthuoc'] && window.id_donthuoctralai==rowData['iddonthuoc'] ){
										window.loithuocdatralai=1;
										
									}
							}
							if(window.loithuocdatralai==0){
								$('#tralaithuoc_rowed3').jqGrid("setCell", $("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), "ID_Thuoc_Tra",window.id_thuoctralai );
								be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
								$("#tralaithuoc_rowed3").jqGrid('setRowData',$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
								jQuery("#tralaithuoc_rowed3").jqGrid('saveRow',$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow'), true);
								$("#tralaithuoc_rowed3_iladd").removeClass('ui-state-disabled');
								$('#tralaithuoc_rowed3_iladd').click();
							}else{
								$( "#dialog-thuoctralaidaco" ).dialog('open'); 	
							}
						}
						/*setTimeout(function(){
							$('#tralaithuoc_rowed3 #'+rowid+'_solonhasanxuat').focus();
							$('#tralaithuoc_rowed3 #'+rowid+'_solonhasanxuat').select();
						},50);	*/
					}else{
						setTimeout(function(){
							window.soluongtralaitrong=1;
								$( "#dialog-soluongtralai" ).dialog('open');
						},50);
					}
			}
		}
		if(jwerty.is("shift+tab",e)){
			if($('#tralaithuoc_rowed3 #'+rowid+'_hansudung').is(":focus")){
				setTimeout(function(){
						$('#tralaithuoc_rowed3 #'+rowid+'_solonhasanxuat').focus()
				},50);			
			}
			if($('#tralaithuoc_rowed3 #'+rowid+'_solonhasanxuat').is(":focus")){
				setTimeout(function(){
						$('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai').focus()
				},50);			
			}
			if($('#tralaithuoc_rowed3 #'+rowid+'_soluongtralai').is(":focus")){
				setTimeout(function(){
						$('#tralaithuoc_rowed3 #'+rowid+'_ID_Thuoc_Tra_combobox').focus()
				},50);			
			}
		}
	})
	
}

function check_idthuoc(value,colname){
	//alert(value+','+colname);
	idrowed6=$('#donthuoc_rowed3').jqGrid('getGridParam','selrow')
	ids_rowed6=$('#donthuoc_rowed3').jqGrid('getDataIDs');		
	ids_rowed6=removeA(ids_rowed6, $('#donthuoc_rowed3').jqGrid('getGridParam','selrow'));
	// parseFloat(convert_comma_dot_cacl($('#rowed6 #'+rowid+'_SoThuocThucXuat').val()));	
	if($.inArray(value, ids_rowed6) > -1){			 
		return [false,'Thuốc đã có','ID_Thuoc1']
	}else if($.trim(value)==''){
		return [false,'Chưa chọn thuốc','ID_Thuoc1']
	}else{
		return[true,'']
	}
}	
function removeA(arr) {
    var what, a = arguments, L = a.length, ax;
    while (L > 1 && arr.length) {
        what = a[--L];
        while ((ax= arr.indexOf(what)) !== -1) {
            arr.splice(ax, 1);
        }
    }
    return arr;
}
function check_soluong(value,colName,id_row){
	//soluong_Tencol_IDrow
	//alert(value+'_'+colName+'_'+id_row);
	if(id_row!='undefined' && id_row!='' ){
	if(window.iddonthuoc=='' || window.iddonthuoc=='undefined'){
		var _report_data=$.ajax({url: 'resource.php?module=<?=$modules?>&view=<?=$view?>&action=controller_donthuoc_soluong&soluong='+value+'&id_thuoc='+$('#'+id_row+'_ID_Thuoc').val(), async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;
			_report_data=_report_data.split(';;');	
			if(_report_data[1]==0){		
				window.tonkhokhongdu=1;
					return [false,'Tồn kho hiện tại còn '+_report_data[0]+', không đủ để kê đơn','ID_Thuoc_combobox']
			}else{
				window.tonkhokhongdu=0;
				return[true,'']
			}
	}else{
		var _checkdonthuoc=$.ajax({url: 'resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_donthuoc&id_donthuoc='+window.iddonthuoc, async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;
		//alert(_checkdonthuoc);
			if(_checkdonthuoc=="true"){
			var _report_data=$.ajax({url: 'resource.php?module=<?=$modules?>&view=<?=$view?>&action=controller_donthuoc_soluong&soluong='+value+'&id_thuoc='+$('#'+id_row+'_ID_Thuoc').val(), async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;
			_report_data=_report_data.split(';;');	
			if(_report_data[1]==0){		
				window.tonkhokhongdu=1;
					return [false,'Tồn kho hiện tại còn '+_report_data[0]+', không đủ để kê đơn','ID_Thuoc_combobox']
			}else{
				window.tonkhokhongdu=0;
				return[true,'']
			}
		}else{
			$("#donthuoc_rowed3_ilcancel").click();
			return [false,'Đơn thuốc đã xuất hoặc đã thanh toán','ID_Thuoc_combobox']
		}
	}
	}else{
		window.tonkhokhongdu=0;
		return[true,'']
	}
}

function aftersave(rowId, response,lastsel) {
		destroy_combobox_inline_new('ID_Thuoc',rowId,'donthuoc_rowed3');	
		$('#donthuoc_rowed3').focus();	
		var current_rowed6=$('#donthuoc_rowed3').jqGrid('getCell',rowId, 'ID_Thuoc')
		
		$('#'+rowId).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"})
		$("#" + rowId).attr("id",current_rowed6);
		$('#'+current_rowed6).removeClass("ui-state-highlight");						
		be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
		$("#donthuoc_rowed3").jqGrid('setRowData',current_rowed6,{xoa:be});
		
		//alert(rowId);
		setTimeout(function(){							
		   $("#prowed6 .ui-icon-plus").click();	
		   var ids = jQuery("#donthuoc_rowed3").jqGrid('getDataIDs');	
		   $('#'+ids[ids.length-1]+'_ID_Thuoc1').focus();		
		},200);
 }
 // vật tư y tế
function create_vattutieuhao(){	
	//alert();
	 var searhicon = '<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-right: .3em;"></span></span>';
	 mydata=[];	 
	 $("#vattutieuhao_rowed3").jqGrid({	
		data:mydata,	 
		datatype: "local",		 	
		colNames:['','','','','','','','Tên thuốc', "Đường dùng","Giá bán", "Số lượng", "Tổng", "Cách dùng", "Thực hiện","idthuoc"],
		colModel:[
			{name:'id_donthuoc',index:'id_donthuoc',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'luu',index:'luu',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'trangthaidonthuoc',index:'trangthaidonthuoc',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'iddonthuocct',index:'iddonthuocct',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'id_dvt',index:'id_dvt',width:"10%",align:'center',hidden:true, editable: false },
			{name:'lavattu',index:'lavattu',width:"10%",align:'center',hidden:true, editable: false }  ,
			{name:'xoa',index:'xoa',width:"3%",align:'center',hidden:false, editable: false}  ,
			{name:'ID_VatTuTieuHao',index:'ID_VatTuTieuHao',width:"30%", align:'left',hidden:false, editable: true,edittype:"select", classes:'tenthuoc',editoptions:{value:window.thuoc},formatter: "select",editrules:{custom: true, custom_func: function(value, colName) {
                          return check_idthuoc(value,colName);
                        },formatter: function (cellValue, options, rowObject) {                    
                            return searhicon
                        }}
		    }, 
			{name:'ID_DuongDungThuoc',index:'ID_DuongDungThuoc', width:"10%",align:'left', editable: true,edittype:"select",editoptions:{value:window.duongdung},formatter: "select"},	
			{name:'Gia',index:'Gia', width:"8%",align:'right',hidden:false,formatter:'number', formatoptions:{decimalPlaces: 0}, editable: false},
			{name:'SoThuocThucXuat',index:'SoThuocThucXuat',width:"8%",formatter:currency_convert,align:'right',hidden:false, editable: true
			,editrules:{custom: true,required:true, custom_func: function(value, colName) {
                           var id_row = $('#vattutieuhao_rowed3').jqGrid('getGridParam', 'selrow')
                           return check_soluong_vtyt(value,colName,id_row);
                        }}},
			{name:'ThanhTien',index:'ThanhTien',width:"7%",align:'right',hidden:true,formatter:'number', formatoptions:{decimalPlaces: 1}, editable: true},
			{name:'CachDungLieuDung',index:'CachDungLieuDung',width:"8%",align:'right',hidden:true, editable: true,editoptions:{dataEvents: [{ type: 'keyup', fn: function(e) {
				if(jwerty.is("enter",e)||jwerty.is("tab",e)){
					if($("#"+$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow')+'_CachDungLieuDung').val()!=''){
						
							be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
							$("#vattutieuhao_rowed3").jqGrid('setRowData',$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
							//jQuery("#vattutieuhao_rowed3").jqGrid('saveRow',$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), true);
							jQuery("#vattutieuhao_rowed3").jqGrid('saveRow',$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'),null,null,{"extraparam" : {"oper":'add'} }, aftersave,null,null,null,"POST");
							$("#vattutieuhao_rowed3_iladd").removeClass('ui-state-disabled');
							if(window.tonkhokhongdu==0){
								$('#vattutieuhao_rowed3_iladd').click();
							}
					}
				}
				}}]}},
			{name:'PhuongThucThucHien',index:'PhuongThucThucHien',width:"10%",align:'center',hidden:true, editable: true,edittype:"select",formatter:'select',editoptions:{value:"0:Hospital;1:Home;2:Seft",dataEvents: [{ type: 'keyup', fn: function(e) {
						be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
						$("#vattutieuhao_rowed3").jqGrid('setRowData',$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
						jQuery("#vattutieuhao_rowed3").jqGrid('saveRow',$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), true);
							$("#vattutieuhao_rowed3_iladd").removeClass('ui-state-disabled');
							$('#vattutieuhao_rowed3_iladd').click();
				}}]}
				
				},
			{name:'idthuoc',index:'idthuoc',width:"10%",align:'center',hidden:true, editable: false }  ,
			                      
		],
		inline_esc:false,
		grid_mode:'',
		grid_move:"",
		grid_save_option:"",	
		column:["CachDungLieuDung"],
		func_column:["luoi_CachDungLieuDung"],	
		loadonce: true,
		local:true,
		scroll: false,		 
		modal:true,
        shrinkToFit: true,
		rowNum: 10000000,
		rowList:[],
		pager: '#pvattutieuhao_rowed3',
		sortname: 'ID_LoaiKham',
		height:100,
		width:100,
		viewrecords: false,	
		ignoreCase:true,	
		sortorder: "asc",
	    grouping: true,
		afterInsertRow: function(rowid, aData){
    	},
		pgbuttons: false, // disable page control like next, back button
        pgtext: null, // disable pager text like 'Page 0 of 10'	 
		
		// moi them
		inline_editrule:true,
		inline_esc:true,
		cellEdit: true,
		cellsubmit: 'clientArray',
		cell_move_enter:true,
		afterSaveCell : function ( rowid, cellname, value, iRow, iCol){	
			$('#'+iRow+'_ID_VatTuTieuHao_combobox,.dialog_dm_thuoc .ui-jqgrid-hbox').unbind("keyup");
			$('#'+iRow+'_ID_VatTuTieuHao_combobox,.dialog_dm_thuoc .ui-jqgrid-hbox').unbind("click");
			$('body').unbind("click");			
			return [true,'']
		},
		
		serializeRowData: function (postdata) { 	
			
		},
		 onCellSelect: function (rowid,iCol,cellcontent,e) {
			// alert(iCol)
			if((iCol==6)){
				var rowData = jQuery('#vattutieuhao_rowed3').jqGrid ('getRowData',rowid);
				if(rowData['id_donthuoc']!=''){
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_donthuoc&id_donthuoc='+window.iddonthuoc).done(function(data){
						if(data=="true"){
							  $('#vattutieuhao_rowed3').jqGrid('delRowData',rowid);		
							  if(window.vattutieuhaoxoa==''){
								  window.vattutieuhaoxoa=rowid;
								  }else{
									  window.vattutieuhaoxoa=window.vattutieuhaoxoa+','+rowid;
									  }
							$("#vattutieuhao_rowed3_ilcancel").click();
						}else{
							tooltip_message("Đơn thuốc đã xuất hoặc đã thanh toán");
						}				
					});
				}else{
					$("#vattutieuhao_rowed3_ilcancel").click();
					$('#vattutieuhao_rowed3').jqGrid('delRowData',rowid);	
				}
            }  
			//alert(window.donthuocxoa);                    
        }
		,
		afterEditCell: function (rowid, celname, value, iRow, iCol) {	// them cái này nữa
					window.cell_rowed6=celname;
					rowed6_select=rowid;	
					if((iCol==7)){
						var with_idthuoc=parseFloat($('#jqgh_donthuoc_rowed3_ID_VatTuTieuHao').width())-32;			
						$('#vattutieuhao_rowed3 #'+iRow+'_ID_Thuoc1').hide(); 
						combobox_inline_new('ID_VatTuTieuHao',iRow,'vattutieuhao_rowed3',create_dm_thuoc_vtyt,window.grid_datathuoc,iRow,iRow,vattutieuhao_callback)
						$('#'+iRow+'_ID_VatTuTieuHao_combobox').keyup(function(e){					
							if (jwerty.is('enter',e)){
								$('#vattutieuhao_rowed3').jqGrid("nextCell",iRow,iCol);
							}
						})
						setTimeout(function(){
							$('#'+iRow+'_ID_VatTuTieuHao_combobox').focus();
							$('#'+iRow+'_ID_VatTuTieuHao_combobox').select();
						},10)
					}
					$("#"+iRow+"_SoThuocThucXuat").focusout(function(e) {
					  //  alert();
					});
					$("#"+iRow+"_"+celname).focusout(function(e) {
						$("#vattutieuhao_rowed3").saveCell(iRow,iCol);
					});
		
		}, 
		onSelectRow: function(id){	
	 		$('#'+window.rowed6_select).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"});
			window.rowed6_select=id;
		},
		ondblClickRow: function (rowId, rowIndex, columnIndex) {
			$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_donthuoc&id_donthuoc='+window.iddonthuoc).done(function(data){
				if(data=="true"){
					$("#pvattutieuhao_rowed3 .ui-icon-pencil").click();
				}else{
					tooltip_message("Đơn thuốc đã xuất hoặc đã thanh toán");
				}				
			});
			//}
 		},
		loadComplete: function(data) {
			var ids = jQuery("#vattutieuhao_rowed3").jqGrid('getDataIDs');
			if(ids.length>0){
				var rowData = jQuery('#vattutieuhao_rowed3').jqGrid ('getRowData',ids[0] );
				window.iddonthuoc=rowData['id_donthuoc'];
			}
			window.donthuoc='';
			for(var i=0;i < ids.length;i++){
				var rowData = jQuery('#vattutieuhao_rowed3').jqGrid ('getRowData',ids[i] );	
				var cl = ids[i];
				be = '<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
				$("#vattutieuhao_rowed3").jqGrid('setRowData',ids[i],{xoa:be});	 	
			}
		},
		caption: 'Vật tư tiêu hao <span style="margin-left:50px;">Toa mẫu: <input type="text" id="toamau2" placeholder="Chọn toa mẫu" ></span> <a id="add_new2" class="fm-button ui-state-default ui-corner-all " style="margin-left:30px!important;vertical-align:top;width:16px;height:12px;"  ><span style="margin-top:-2px;margin-right:-22px!important" class="ui-icon ui-icon-circle-plus"></span></a>',
		editurl:'clientArray',
	});

	$("#vattutieuhao_rowed3").jqGrid('navGrid',"#pvattutieuhao_rowed3",{add: false, edit: false, del: false, search: false, refresh: false,closeAfterEdit: true,clearAfterAdd :true,navkeys : [ true, 38, 40 ]});
	$("#vattutieuhao_rowed3").jqGrid('inlineNav', '#pvattutieuhao_rowed3', {add: true, addtext: 'Thêm mới', edittext: '', edit: true,save:false,
            addParams: {
				keys:true,
                position: "last",
                addRowParams: {
					keys:true,                  
                    aftersavefunc: function(rowId, response,lastsel) {
						destroy_combobox_inline_new('ID_VatTuTieuHao',rowId,'vattutieuhao_rowed3');	
						$('#vattutieuhao_rowed3').focus();	
						var current_rowed6=$('#vattutieuhao_rowed3').jqGrid('getCell',rowId, 'ID_VatTuTieuHao')
						
						$('#'+rowId).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"})
						$("#" + rowId).attr("id",current_rowed6);
						$('#'+current_rowed6).removeClass("ui-state-highlight");						
						be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
						$("#vattutieuhao_rowed3").jqGrid('setRowData',current_rowed6,{xoa:be});
						
						//alert(rowId);
						setTimeout(function(){							
						   $("#pvattutieuhao_rowed3 .ui-icon-plus").click();	
						   var ids = jQuery("#vattutieuhao_rowed3").jqGrid('getDataIDs');	
						   $('#'+ids[ids.length-1]+'_ID_VatTuTieuHao1').focus();		
						},200);
						
                    },
					oneditfunc: function(rowId) {	
						combobox_inline_new('ID_VatTuTieuHao',rowId,'vattutieuhao_rowed3',create_dm_thuoc_vtyt,window.grid_datavattutieuhao,0,1,vattutieuhao_callback)//new
						inline_enter_vtyt(rowId);
					},	
                    afterrestorefunc: function(rowId) {	
						destroy_combobox_inline_new('ID_VatTuTieuHao',rowId,'vattutieuhao_rowed3');					
						$("#vattutieuhao_rowed3").jqGrid('bindKeys');
						$('#vattutieuhao_rowed3').focus();						
                    }				 
                }
            	},	
            editParams: {
				keys:true,				 
				 	aftersavefunc: function(rowId, response,lastsel) {
						destroy_combobox_inline_new('ID_VatTuTieuHao',rowId,'vattutieuhao_rowed3');		
						$('#vattutieuhao_rowed3').focus();
						 setTimeout(function(){
							 $("#pvattutieuhao_rowed3 .ui-icon-plus").click();
						},200);	
                    },					 	
                	oneditfunc: function(rowId) {	
						combobox_inline_new('ID_VatTuTieuHao',rowId,'vattutieuhao_rowed3',create_dm_thuoc_vtyt,window.grid_datavattutieuhao,rowId,rowId,vattutieuhao_callback)//new	
						inline_enter_vtyt(rowId);
					},	
                    afterrestorefunc: function(rowId) {	
					$("#vattutieuhao_rowed3").jqGrid('bindKeys');
					destroy_combobox_inline_new('ID_VatTuTieuHao',rowId,'vattutieuhao_rowed3');									   
					},	 
			}
       	 }); 
	$("#add_new2").click(function(e){
		$.post('resource.php?module=web_services&function=get_link&action=index&folder=danh_muc_donthuocmau:').done(function(data) {
		elem=1 + Math.floor(Math.random() * 1000000000);
		width=99;
		height=99;
		var folder= data.split(';');
		var links='resource.php?module='+folder[0]+'&view='+folder[1]+'&id_form='+folder[2];				  				  
		dialog_add_dm("Đơn thuốc mẫu",width,height,elem,links,callback_themdonthuocmau);   
		})
	});     
} 
function currency_convert (cellvalue, options, rowObject){
   return parseFloat(convert_comma_dot_cacl(cellvalue)).formatMoney(1, ',', '.');
}

function create_dm_thuoc_vtyt(elem,datalocal){	
		datalocal=jQuery.parseJSON(datalocal);	 
		 $(elem).jqGrid({
		datastr:datalocal,	
		datatype: "jsonstring" ,
		colNames:['Tên thuốc', 'Hoạt chất','Tên biệt dược', 'Tên nhóm thuốc','','','','bhyt'],
		colModel:[			
			{name:'TenBietDuoc',index:'TenBietDuoc'}, 
			{name:'TenNhomThuoc',index:'TenNhomThuoc'},					 
			{name:'MaThuoc',index:'MaThuoc',hidden :true},	 	
			{name:'ID_DuongDung',index:'ID_DuongDung',hidden :true},	
			{name:'DonGia',index:'DonGia',hidden :true},	
			{name:'ID_dvt',index:'ID_dvt',hidden :true},	
			{name:'LaThuoc',index:'LaThuoc',hidden :true},	 	 
			{name:'bhyt',index:'bhyt',hidden :true},
		],
		hidegrid: false,
		gridview: true,
		loadonce: false,
		scrollrows : true,
		scroll: false,		 
		modal:true,	 
		rowNum: 200,
		rowList:[],
		pager: '#prowed_DM_thuoc',
		sortname: 'ID_Thuoc',
		height:($(window).height() / 100 * parseFloat(40)).toFixed(0),
		width: (($(window).width() / 100 * parseFloat(58)).toFixed(0)),
		viewrecords: true,	
		ignoreCase:true,
		shrinkToFit:true,
		cmTemplate: {sortable:false},		
		sortorder: "desc",
		serializeRowData: function (postdata) { 
		},
		onSelectRow: function(id){	
			$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow');
			var rowData = $(elem).getRowData(id);		  
			var duongdung_tam=rowData['ID_DuongDung'].split(',');
			window.idthuocchon=rowData['MaThuoc'];
			window.idthuockedon=id;
				//if($(elem).data('clicked')){
				//alert();	
				//}
				//if($(elem).data('clicked')){
				//	alert(rowData['DonGia']);
				//	$('#vattutieuhao_rowed3').jqGrid('setCell', 'jqg2', 'Gia', '2222'); ID_DuongDungThuoc
				var dd=rowData['ID_DuongDung'].split(',');
					if(rowData['DonGia']<1){
						window.n_chuacogiaban=1;				
						$( "#val_donvitinh" ).val(rowData['ID_dvt']);
						$( "#val_lathuoc" ).val(rowData['LaThuoc']);
						$( "#val_dongia" ).val(rowData['DonGia']);
						$('#vattutieuhao_rowed3 #'+ $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow')+'_ID_DuongDungThuoc').val(dd);
						$("#_tenthuoc").html(rowData['TenBietDuoc']);
						$('#vattutieuhao_rowed3').jqGrid("setCell", $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), "id_dvt",rowData['ID_dvt'] );
						$('#vattutieuhao_rowed3').jqGrid("setCell", $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), "lavattu",rowData['LaThuoc'] );
						$('#vattutieuhao_rowed3').jqGrid("setCell", $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), "Gia",rowData['DonGia'] );
						$('#dm_duongdung').jqGrid("setSelection",duongdung_tam[0], true);
						$('#vattutieuhao_rowed3 #'+ $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow')+'_ID_DuongDungThuoc').val(duongdung_tam[0]);	
						$('#vattutieuhao_rowed3').jqGrid("setCell", $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), "idthuoc",window.idthuocchon );
						//alert(duongdung_tam[0]);
						//var columnNames = $('#dm_duongdung').jqGrid('getGridParam','colModel');
						//ten = $('#dm_duongdung').jqGrid('getCell', duongdung_tam[0], columnNames[0].name);	 idthuoc					
						
						}else{
							$('#vattutieuhao_rowed3 #'+ $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow')+'_ID_DuongDungThuoc').val(dd);
							$('#vattutieuhao_rowed3').jqGrid("setCell", $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), "id_dvt",rowData['ID_dvt'] );
							$('#vattutieuhao_rowed3').jqGrid("setCell", $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), "lavattu",rowData['LaThuoc'] );
							$('#vattutieuhao_rowed3').jqGrid("setCell", $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), "Gia",rowData['DonGia'] );
							$('#vattutieuhao_rowed3').jqGrid("setCell", $("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'), "idthuoc",window.idthuockedon );
							$('#dm_duongdung').jqGrid("setSelection",duongdung_tam[0], true);
							//$('#vattutieuhao_rowed3 #'+id_rowed6_edit+'_ID_DuongDungThuoc').val(duongdung_tam[0]);	
							//var columnNames = $('#dm_duongdung').jqGrid('getGridParam','colModel');
												
							window.n_chuacogiaban=0;
						}
				//}
		},
		ondblClickRow: function (id, rowIndex, columnIndex) {
				
 		},
		loadComplete: function(data) {				
			ids_DM_thuoc=$('#DM_thuoc').jqGrid('getDataIDs');	
			for(i=0;i<=ids_DM_thuoc.length;i++){
				var rowData = $(elem).getRowData(i);	
				if(rowData['bhyt']==1){					
					$("#DM_thuoc #" + ids_DM_thuoc[i]).find("td").css("background-color", "#CCC!important");
				}
			}
		},	  		
	});	
	// $("#DM_thuoc").jqGrid('navGrid',"#prowed_DM_thuoc",{add: false, edit: false, del: false, search: true,closeAfterEdit: true,clearAfterAdd :true,closeOnEscape : true });				 
	// $("#DM_thuoc").jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
	// $("#DM_thuoc").jqGrid('bindKeys', {} );		
	$(elem).jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
	$(elem).jqGrid('bindKeys', {} );
}

function vattutieuhao_callback(tam){
	$("#"+tam).keydown(function(e) {
	if (jwerty.is("enter",e)||jwerty.is("tab",e)) {
		
		$("#vattutieuhao_rowed3 #"+$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow')+"_SoThuocThucXuat").focus();
		$("#vattutieuhao_rowed3 #"+$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow')+"_SoThuocThucXuat").select();
		//alert($("#"+tam).val());
		setTimeout(function(){
			if($("#vattutieuhao_rowed3 #"+$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_VatTuTieuHao_combobox").val()==''){// jqg4_ID_Thuoc_combobox
				$( "#dialog-thuoctrong" ).dialog('open'); 
				//$("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").focus();  jqg6_ID_Thuoc
			}else{
				var tmp1 = $("#vattutieuhao_rowed3").jqGrid('getDataIDs'); 
				window.loithuocdake=0;
				/*for(var i=0;i<tmp1.length-1;i++){
					var rowData = $("#vattutieuhao_rowed3").getRowData(tmp1[i]);	
					   if(window.idthuockedon==rowData['idthuoc']){
							window.loithuocdake=1;
							$( "#dialog-thuocdake" ).dialog('open'); 
						}
				}
				*/
				for(var i=0;i<tmp1.length-1;i++){
					var d=i+1;
					var rowData = $("#vattutieuhao_rowed3").getRowData(tmp1[i]);	
						//console.log(window.idthuockedon+'=='+rowData['ID_VatTuTieuHao'])
						//console.log(typeof $("#"+d+'_'+tam).val());
						if(typeof $("#"+d+'_'+tam).val() === 'object' || typeof $("#"+d+'_'+tam).val() === 'undefined'){
							//console.log(window.idthuockedon+'=='+rowData['ID_Thuoc'])
						    if(window.idthuockedon==rowData['ID_VatTuTieuHao']){
								window.loithuocdake=1;
								$( "#vattutieuhao_rowed3_iledit" ).click();
								//$("#vattutieuhao_rowed3 #"+$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_VatTuTieuHao_combobox").val('');
								$( "#dialog-thuocdake" ).dialog('open'); 
							}
						}
				}
				/*
				
				if(window.loithuocdake==0){*/
					if(window.n_chuacogiaban==1){
						setTimeout(function(){
							$( "#dialog-thuochuacogiaban" ).dialog('open');
							},100);	
							delete window.n_chuacogiaban;
					}
				//}
			}
		},100);
	}
	});
}

function inline_enter_vtyt(rowid){	
	$('#vattutieuhao_rowed3 #'+rowid+'_ID_DuongDungThuoc,#vattutieuhao_rowed3 #'+rowid+'_SoThuocThucXuat,#vattutieuhao_rowed3 #'+rowid+'_ThanhTien,#vattutieuhao_rowed3 #'+rowid+'_CachDungLieuDung,#vattutieuhao_rowed3 #'+rowid+'_PhuongThucThucHien').unbind('keydown')
	$('#vattutieuhao_rowed3 #'+rowid+'_ID_DuongDungThuoc,#vattutieuhao_rowed3 #'+rowid+'_SoThuocThucXuat,#vattutieuhao_rowed3 #'+rowid+'_ThanhTien,#vattutieuhao_rowed3 #'+rowid+'_CachDungLieuDung,#vattutieuhao_rowed3 #'+rowid+'_PhuongThucThucHien').bind('keydown',function(e){
		if ((jwerty.is('enter',e))||(jwerty.is('tab',e))){
			if($('#vattutieuhao_rowed3 #'+rowid+'_ID_DuongDungThuoc').is(":focus")){
				setTimeout(function(){
						$('#vattutieuhao_rowed3 #'+rowid+'_SoThuocThucXuat').focus();
						$('#vattutieuhao_rowed3 #'+rowid+'_SoThuocThucXuat').select();
				},50);			
			}
			if($('#vattutieuhao_rowed3 #'+rowid+'_SoThuocThucXuat').is(":focus")){
					var slx=$('#vattutieuhao_rowed3 #'+rowid+'_SoThuocThucXuat').val().split(',');
					if(slx[0]>0){
						setTimeout(function(){
								be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
								$("#vattutieuhao_rowed3").jqGrid('setRowData',$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
								jQuery("#vattutieuhao_rowed3").jqGrid('saveRow',$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow'),null,null,{"extraparam" : {"oper":'add'} }, aftersave,null,null,null,"POST");
								$("#vattutieuhao_rowed3_iladd").removeClass('ui-state-disabled');
								if(window.tonkhokhongdu==0){
									$('#vattutieuhao_rowed3_iladd').click();
								}
						},50);	
					}else{
						setTimeout(function(){
								$( "#dialog-soluongxuat" ).dialog('open');
						},50);
					}
			}
			if($('#vattutieuhao_rowed3 #'+rowid+'_CachDungLieuDung').is(":focus")){
				setTimeout(function(){
						$('#vattutieuhao_rowed3 #'+rowid+'_PhuongThucThucHien').focus();
						$('#vattutieuhao_rowed3 #'+rowid+'_PhuongThucThucHien').select();
						if($('#vattutieuhao_rowed3 #'+rowid+'_CachDungLieuDung').val()==''){
							$('#vattutieuhao_rowed3 #'+rowid+'_CachDungLieuDung').val(0);
						}
				},200);			
			}
			if($('#vattutieuhao_rowed3 #'+rowid+'_PhuongThucThucHien').is(":focus")){
				setTimeout(function(){	
					$('#vattutieuhao_rowed3_iladd').removeClass('ui-state-disabled')	 ;					
				 //  $("#prowed6 .ui-icon-plus").click();
				},200);		
			}
		}
		if(jwerty.is("shift+tab",e)){
			//alert();
			if($('#vattutieuhao_rowed3 #'+rowid+'_PhuongThucThucHien').is(":focus")){
				setTimeout(function(){
						$('#vattutieuhao_rowed3 #'+rowid+'_CachDungLieuDung').focus()
				},50);			
			}
			if($('#vattutieuhao_rowed3 #'+rowid+'_CachDungLieuDung').is(":focus")){
				setTimeout(function(){
					//alert();
						$('#vattutieuhao_rowed3 #'+rowid+'_SoThuocThucXuat').focus()
				},50);			
			}
			if($('#vattutieuhao_rowed3 #'+rowid+'_SoThuocThucXuat').is(":focus")){
				setTimeout(function(){
						$('#vattutieuhao_rowed3 #'+rowid+'_ID_DuongDungThuoc').focus()
				},50);			
			}
			if($('#vattutieuhao_rowed3 #'+rowid+'_ID_DuongDungThuoc').is(":focus")){
				setTimeout(function(){
						$('#vattutieuhao_rowed3 #'+rowid+'_ID_Thuoc_combobox').focus()
				},50);			
			}
		}//if shift tab
	})
}
function check_soluong_vtyt(value,colName,id_row){
	//alert(window.iddonthuoc); //false
	console.log(value+'_'+colName+'_'+id_row);
	if(id_row!='' && id_row!='undefined' && id_row!=null && id_row!=false){
		if(window.iddonthuoc=='' || window.iddonthuoc=='undefined'){
			var _report_data=$.ajax({url: 'resource.php?module=<?=$modules?>&view=<?=$view?>&action=controller_donthuoc_soluong&soluong='+value+'&id_thuoc='+$('#'+id_row+'_ID_VatTuTieuHao').val(), async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;
				_report_data=_report_data.split(';;');	
				if(_report_data[1]==0){		
					window.tonkhokhongdu=1;
						return [false,'Tồn kho hiện tại còn '+_report_data[0]+', không đủ để kê đơn','ID_VatTuTieuHao_combobox']
				}else{
					window.tonkhokhongdu=0;
					return[true,'']
				}
		}else{
			var _checkdonthuoc=$.ajax({url: 'resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_donthuoc&id_donthuoc='+window.iddonthuoc, async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;
			//alert(_checkdonthuoc);
				if(_checkdonthuoc=="true"){
				var _report_data=$.ajax({url: 'resource.php?module=<?=$modules?>&view=<?=$view?>&action=controller_donthuoc_soluong&soluong='+value+'&id_thuoc='+$('#'+id_row+'_ID_VatTuTieuHao').val(), async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;
				_report_data=_report_data.split(';;');	
				if(_report_data[1]==0){		
					window.tonkhokhongdu=1;
						return [false,'Tồn kho hiện tại còn '+_report_data[0]+', không đủ để kê đơn','ID_VatTuTieuHao_combobox']
				}else{
					window.tonkhokhongdu=0;
					return[true,'']
				}
			}else{
				$("#vattutieuhao_rowed3_ilcancel").click();
				return [false,'Đơn thuốc đã xuất hoặc đã thanh toán','ID_VatTuTieuHao_combobox']
			}
		}
	}else{
		window.tonkhokhongdu=0;
		return[true,'']
	}
}
// toa thuốc cho về

function create_donthuocchove(){
	//alert();
	 var searhicon = '<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-right: .3em;"></span></span>';
	 mydata=[];	 
	 $("#donthuocchove_rowed3").jqGrid({	
		data:mydata,	 
		datatype: "local",		 	
		colNames:['','','','','','','','Tên thuốc', "Đường dùng","Giá bán", "Số lượng", "Tổng", "Cách dùng", "Thực hiện","idthuoc","Cách dùng chi tiết"],
		colModel:[
			{name:'id_donthuoc',index:'id_donthuoc',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'luu',index:'luu',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'trangthaidonthuoc',index:'trangthaidonthuoc',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'iddonthuocct',index:'iddonthuocct',width:"8%",align:'right',hidden:true, editable: false}  ,
			{name:'id_dvt',index:'id_dvt',width:"10%",align:'center',hidden:true, editable: false },
			{name:'lavattu',index:'lavattu',width:"10%",align:'center',hidden:true, editable: false }  ,
			{name:'xoa',index:'xoa',width:"3%",align:'center',hidden:false, editable: false}  ,
			{name:'ID_ThuocChoVe',index:'ID_ThuocChoVe',width:"20%", align:'left',hidden:false, editable: true,edittype:"select", classes:'tenthuoc',editoptions:{value:window.thuoc},formatter: "select",editrules:{custom: true, custom_func: function(value, colName) {
                          return check_idthuoc(value,colName);
                        },formatter: function (cellValue, options, rowObject) {                    
                            return searhicon
                        }}
		    }, 
			{name:'ID_DuongDungThuoc',index:'ID_DuongDungThuoc', width:"10%",align:'left', editable: true,edittype:"select",editoptions:{value:window.duongdung},formatter: "select"},	
			{name:'Gia',index:'Gia', width:"5%",align:'right',hidden:false,formatter:'number', formatoptions:{decimalPlaces: 0}, editable: false},
			{name:'SoThuocThucXuat',index:'SoThuocThucXuat',width:"5%",formatter:currency_convert,align:'right',hidden:false, editable: true
			,editrules:{custom: true,required:true, custom_func: function(value, colName) {
                           var id_row = $('#donthuocchove_rowed3').jqGrid('getGridParam', 'selrow')
                           return check_soluong_donthuochove(value,colName,id_row);
                        }}},
			{name:'ThanhTien',index:'ThanhTien',width:"7%",align:'right',hidden:true,formatter:'number', formatoptions:{decimalPlaces: 1}, editable: true},
			{name:'CachDungLieuDung',index:'CachDungLieuDung',width:"5%",align:'right',hidden:false, editable: true,editoptions:{dataEvents: [{ type: 'keyup', fn: function(e) {
				if(jwerty.is("enter",e)||jwerty.is("tab",e)){
					/*if($("#"+$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow')+'_CachDungLieuDung').val()!=''){
						
							be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
							$("#donthuocchove_rowed3").jqGrid('setRowData',$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
							//jQuery("#donthuocchove_rowed3").jqGrid('saveRow',$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), true);
							jQuery("#donthuocchove_rowed3").jqGrid('saveRow',$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'),null,null,{"extraparam" : {"oper":'add'} }, aftersave,null,null,null,"POST");
							$("#donthuocchove_rowed3_iladd").removeClass('ui-state-disabled');
							if(window.tonkhokhongdu==0){
								$('#donthuocchove_rowed3_iladd').click();
							}
					}*/
				}
				}}]}},
			{name:'PhuongThucThucHien',index:'PhuongThucThucHien',width:"10%",align:'center',hidden:true, editable: true,edittype:"select",formatter:'select',editoptions:{value:"0:Hospital;1:Home;2:Seft",dataEvents: [{ type: 'keyup', fn: function(e) {
						be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
						$("#donthuocchove_rowed3").jqGrid('setRowData',$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
						jQuery("#donthuocchove_rowed3").jqGrid('saveRow',$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), true);
							$("#donthuocchove_rowed3_iladd").removeClass('ui-state-disabled');
							$('#donthuocchove_rowed3_iladd').click();
				}}]}
				
				},
			{name:'idthuoc',index:'idthuoc',width:"10%",align:'center',hidden:true, editable: false }  ,
			{name:'CachDungChiTiet',index:'CachDungChiTiet',width:"20%",align:'left',hidden:false, editable: true,editoptions:{dataEvents: [{ type: 'keyup', fn: function(e) {
				if(jwerty.is("enter",e)||jwerty.is("tab",e)){
					if($("#"+$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow')+'_CachDungChiTiet').val()!=''){
						
							be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
							$("#donthuocchove_rowed3").jqGrid('setRowData',$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'),{xoa:be});
							//jQuery("#donthuocchove_rowed3").jqGrid('saveRow',$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), true);
							jQuery("#donthuocchove_rowed3").jqGrid('saveRow',$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'),null,null,{"extraparam" : {"oper":'add'} }, aftersave,null,null,null,"POST");
							$("#donthuocchove_rowed3_iladd").removeClass('ui-state-disabled');
							if(window.tonkhokhongdu==0){
								$('#donthuocchove_rowed3_iladd').click();
							}
					}
				}
				}}]},classes:'cachdungchitiet'},              
		],
		inline_esc:false,
		grid_mode:'',
		grid_move:"",
		grid_save_option:"",	
		column:["CachDungLieuDung"],
		func_column:["luoi_CachDungLieuDung"],	
		loadonce: true,
		local:true,
		scroll: false,		 
		modal:true,
        shrinkToFit: true,
		rowNum: 10000000,
		rowList:[],
		pager: '#pdonthuocchove_rowed3',
		sortname: 'ID_LoaiKham',
		height:100,
		width:100,
		viewrecords: false,	
		ignoreCase:true,	
		sortorder: "asc",
	    grouping: true,
		afterInsertRow: function(rowid, aData){
    	},
		pgbuttons: false, // disable page control like next, back button
        pgtext: null, // disable pager text like 'Page 0 of 10'	 
		serializeRowData: function (postdata) { 	
			
		},
		 onCellSelect: function (rowid,iCol,cellcontent,e) {
			// alert(iCol)
			if((iCol==6)){
				var rowData = jQuery('#donthuocchove_rowed3').jqGrid ('getRowData',rowid);
				if(rowData['id_donthuoc']!=''){
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_donthuoc&id_donthuoc='+window.iddonthuoc).done(function(data){
						if(data=="true"){
							  $('#donthuocchove_rowed3').jqGrid('delRowData',rowid);		
							  if(window.donthuochove==''){
								  window.donthuochove=rowid;
								  }else{
									  window.donthuochove=window.donthuochove+','+rowid;
									  }
							$("#donthuocchove_rowed3_ilcancel").click();
						}else{
							tooltip_message("Đơn thuốc đã xuất hoặc đã thanh toán");
						}				
					});
				}else{
					$("#donthuocchove_rowed3_ilcancel").click();
					$('#donthuocchove_rowed3').jqGrid('delRowData',rowid);	
				}
            }  
			//alert(window.donthuocxoa);                    
        }, 
		onSelectRow: function(id){	
	 		$('#'+window.rowed6_select).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"});
			window.rowed6_select=id;
		},
		ondblClickRow: function (rowId, rowIndex, columnIndex) {
			$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_donthuoc&id_donthuoc='+window.iddonthuoc).done(function(data){
				if(data=="true"){
				$("#pdonthuocchove_rowed3 .ui-icon-pencil").click();
				}else{
					tooltip_message("Đơn thuốc đã xuất hoặc đã thanh toán");
				}				
			});
			//}
 		},
		loadComplete: function(data) {
			var ids = jQuery("#donthuocchove_rowed3").jqGrid('getDataIDs');
			if(ids.length>0){
				var rowData = jQuery('#donthuocchove_rowed3').jqGrid ('getRowData',ids[0] );
				window.iddonthuoc=rowData['id_donthuoc'];
			}
			window.donthuoc='';
			for(var i=0;i < ids.length;i++){
				var rowData = jQuery('#donthuocchove_rowed3').jqGrid ('getRowData',ids[i] );	
				var cl = ids[i];
				be = '<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
				$("#donthuocchove_rowed3").jqGrid('setRowData',ids[i],{xoa:be});	 	
			}
		},
		caption: "Đơn thuốc cho về",
		editurl:'clientArray',
	});

	$("#donthuocchove_rowed3").jqGrid('navGrid',"#pdonthuocchove_rowed3",{add: false, edit: false, del: false, search: false, refresh: false,closeAfterEdit: true,clearAfterAdd :true,navkeys : [ true, 38, 40 ]});
	$("#donthuocchove_rowed3").jqGrid('inlineNav', '#pdonthuocchove_rowed3', {add: true, addtext: 'Thêm mới', edittext: '', edit: true,save:false,
            addParams: {
				keys:true,
                position: "last",
                addRowParams: {
					keys:true,                  
                    aftersavefunc: function(rowId, response,lastsel) {
						destroy_combobox_inline_new('ID_ThuocChoVe',rowId,'donthuocchove_rowed3');	
						$('#donthuocchove_rowed3').focus();	
						var current_rowed6=$('#donthuocchove_rowed3').jqGrid('getCell',rowId, 'ID_ThuocChoVe')
						
						$('#'+rowId).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"})
						$("#" + rowId).attr("id",current_rowed6);
						$('#'+current_rowed6).removeClass("ui-state-highlight");						
						be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
						$("#donthuocchove_rowed3").jqGrid('setRowData',current_rowed6,{xoa:be});
						
						//alert(rowId);
						setTimeout(function(){							
						   $("#pdonthuocchove_rowed3 .ui-icon-plus").click();	
						   var ids = jQuery("#donthuocchove_rowed3").jqGrid('getDataIDs');	
						   $('#'+ids[ids.length-1]+'_ID_VatTuTieuHao1').focus();		
						},200);
						
                    },
					oneditfunc: function(rowId) {	
						combobox_inline_new('ID_ThuocChoVe',rowId,'donthuocchove_rowed3',create_dm_thuoc_chove,window.grid_datavattutieuhao,0,1,donthuocchove_callback)//new
						inline_enter_donthuocchove(rowId);
					},	
                    afterrestorefunc: function(rowId) {	
						destroy_combobox_inline_new('ID_ThuocChoVe',rowId,'donthuocchove_rowed3');					
						$("#donthuocchove_rowed3").jqGrid('bindKeys');
						$('#donthuocchove_rowed3').focus();						
                    }				 
                }
            	},	
            editParams: {
				keys:true,				 
				 	aftersavefunc: function(rowId, response,lastsel) {
						destroy_combobox_inline_new('ID_ThuocChoVe',rowId,'donthuocchove_rowed3');		
						$('#donthuocchove_rowed3').focus();
						 setTimeout(function(){
							 $("#pdonthuocchove_rowed3 .ui-icon-plus").click();
						},200);	
                    },					 	
                	oneditfunc: function(rowId) {	
						combobox_inline_new('ID_VatTuTieuHao',rowId,'donthuocchove_rowed3',create_dm_thuoc_chove,window.grid_datavattutieuhao,rowId,rowId,donthuocchove_callback)//new	
						inline_enter_donthuocchove(rowId);
					},	
                    afterrestorefunc: function(rowId) {	
					$("#donthuocchove_rowed3").jqGrid('bindKeys');
					destroy_combobox_inline_new('ID_ThuocChoVe',rowId,'donthuocchove_rowed3');									   
					},	 
			}
       	 });      
}
function currency_convert (cellvalue, options, rowObject){
   return parseFloat(convert_comma_dot_cacl(cellvalue)).formatMoney(1, ',', '.');
}

function create_dm_thuoc_chove(elem,datalocal){
		datalocal=jQuery.parseJSON(datalocal);	 
		 $(elem).jqGrid({
		datastr:datalocal,	
		datatype: "jsonstring" ,
		colNames:['Tên thuốc', 'Hoạt chất','Tên biệt dược', 'Tên nhóm thuốc','','','','bhyt'],
		colModel:[			
			{name:'TenBietDuoc',index:'TenBietDuoc'}, 
			{name:'TenNhomThuoc',index:'TenNhomThuoc'},					 
			{name:'MaThuoc',index:'MaThuoc',hidden :true},	 	
			{name:'ID_DuongDung',index:'ID_DuongDung',hidden :true},	
			{name:'DonGia',index:'DonGia',hidden :true},	
			{name:'ID_dvt',index:'ID_dvt',hidden :true},	
			{name:'LaThuoc',index:'LaThuoc',hidden :true},	 	 
			{name:'bhyt',index:'bhyt',hidden :true},
		],
		hidegrid: false,
		gridview: true,
		loadonce: false,
		scrollrows : true,
		scroll: false,		 
		modal:true,	 
		rowNum: 200,
		rowList:[],
		pager: '#prowed_DM_thuoc',
		sortname: 'ID_Thuoc',
		height:($(window).height() / 100 * parseFloat(40)).toFixed(0),
		width: (($(window).width() / 100 * parseFloat(58)).toFixed(0)),
		viewrecords: true,	
		ignoreCase:true,
		shrinkToFit:true,
		cmTemplate: {sortable:false},		
		sortorder: "desc",
		serializeRowData: function (postdata) { 
		},
		onSelectRow: function(id){	
			$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow');
			
			var rowData = $(elem).getRowData(id);		  
			var duongdung_tam=rowData['ID_DuongDung'].split(',');
			window.idthuocchon=rowData['MaThuoc'];
			window.idthuockedon=id;
				//if($(elem).data('clicked')){
				//alert();	
				//}
				//if($(elem).data('clicked')){
				//	alert(rowData['DonGia']);
				//	$('#donthuocchove_rowed3').jqGrid('setCell', 'jqg2', 'Gia', '2222'); ID_DuongDungThuoc
				var dd=rowData['ID_DuongDung'].split(',');
					if(rowData['DonGia']<1){
						window.n_chuacogiaban=1;				
						$( "#val_donvitinh" ).val(rowData['ID_dvt']);
						$( "#val_lathuoc" ).val(rowData['LaThuoc']);
						$( "#val_dongia" ).val(rowData['DonGia']);
						$('#donthuocchove_rowed3 #'+ $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow')+'_ID_DuongDungThuoc').val(dd);
						$("#_tenthuoc").html(rowData['TenBietDuoc']);
						$('#donthuocchove_rowed3').jqGrid("setCell", $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), "id_dvt",rowData['ID_dvt'] );
						$('#donthuocchove_rowed3').jqGrid("setCell", $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), "lavattu",rowData['LaThuoc'] );
						$('#donthuocchove_rowed3').jqGrid("setCell", $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), "Gia",rowData['DonGia'] );
						$('#dm_duongdung').jqGrid("setSelection",duongdung_tam[0], true);
						$('#donthuocchove_rowed3 #'+ $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow')+'_ID_DuongDungThuoc').val(duongdung_tam[0]);	
						$('#donthuocchove_rowed3').jqGrid("setCell", $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), "idthuoc",window.idthuocchon );
						//alert(duongdung_tam[0]);
						//var columnNames = $('#dm_duongdung').jqGrid('getGridParam','colModel');
						//ten = $('#dm_duongdung').jqGrid('getCell', duongdung_tam[0], columnNames[0].name);	 idthuoc					
						
						}else{
							$('#donthuocchove_rowed3 #'+ $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow')+'_ID_DuongDungThuoc').val(dd);
							$('#donthuocchove_rowed3').jqGrid("setCell", $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), "id_dvt",rowData['ID_dvt'] );
							$('#donthuocchove_rowed3').jqGrid("setCell", $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), "lavattu",rowData['LaThuoc'] );
							$('#donthuocchove_rowed3').jqGrid("setCell", $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), "Gia",rowData['DonGia'] );
							$('#donthuocchove_rowed3').jqGrid("setCell", $("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow'), "idthuoc",window.idthuockedon );
							$('#dm_duongdung').jqGrid("setSelection",duongdung_tam[0], true);
							//$('#donthuocchove_rowed3 #'+id_rowed6_edit+'_ID_DuongDungThuoc').val(duongdung_tam[0]);	
							//var columnNames = $('#dm_duongdung').jqGrid('getGridParam','colModel');
												
							window.n_chuacogiaban=0;
						}
				//}
		},
		ondblClickRow: function (id, rowIndex, columnIndex) {
				
 		},
		loadComplete: function(data) {				
			ids_DM_thuoc=$('#DM_thuoc').jqGrid('getDataIDs');	
			for(i=0;i<=ids_DM_thuoc.length;i++){
				var rowData = $(elem).getRowData(i);	
				if(rowData['bhyt']==1){					
					$("#DM_thuoc #" + ids_DM_thuoc[i]).find("td").css("background-color", "#CCC!important");
				}
			}
		},	  		
	});	
	 $("#DM_thuoc").jqGrid('navGrid',"#prowed_DM_thuoc",{add: false, edit: false, del: false, search: false,closeAfterEdit: true,clearAfterAdd :true,closeOnEscape : true });				 
	 $("#DM_thuoc").jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"bw"});
	 $("#DM_thuoc").jqGrid('bindKeys', {} );		
}

function donthuocchove_callback(tam){
	$("#"+tam).keydown(function(e) {
	if (jwerty.is("enter",e)||jwerty.is("tab",e)) {
		$("#donthuocchove_rowed3 #"+$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow')+"_SoThuocThucXuat").focus();
		$("#donthuocchove_rowed3 #"+$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow')+"_SoThuocThucXuat").select();
		//alert($("#"+tam).val());
		setTimeout(function(){
			if($("#donthuocchove_rowed3 #"+$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").val()==''){// jqg4_ID_Thuoc_combobox
				$( "#dialog-thuoctrong" ).dialog('open'); 
				//$("#donthuoc_rowed3 #"+$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')+"_ID_Thuoc_combobox").focus();  jqg6_ID_Thuoc
			}else{
				var tmp1 = $("#donthuocchove_rowed3").jqGrid('getDataIDs'); 
				window.loithuocdake=0;
				/*for(var i=0;i<tmp1.length-1;i++){
					var rowData = $("#donthuocchove_rowed3").getRowData(tmp1[i]);	
					   if(window.idthuockedon==rowData['idthuoc']){
							window.loithuocdake=1;
							$( "#dialog-thuocdake" ).dialog('open'); 
						}
				}
				if(window.loithuocdake==0){*/
					if(window.n_chuacogiaban==1){
						setTimeout(function(){
							$( "#dialog-thuochuacogiaban" ).dialog('open');
							},100);	
							delete window.n_chuacogiaban;
					}
				//}
			}
		},100);
	}
	});
}

function inline_enter_donthuocchove(rowid){
	$('#donthuocchove_rowed3 #'+rowid+'_ID_DuongDungThuoc,#donthuocchove_rowed3 #'+rowid+'_SoThuocThucXuat,#donthuocchove_rowed3 #'+rowid+'_ThanhTien,#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung,#donthuocchove_rowed3 #'+rowid+'_PhuongThucThucHien').unbind('keydown')
	$('#donthuocchove_rowed3 #'+rowid+'_ID_DuongDungThuoc,#donthuocchove_rowed3 #'+rowid+'_SoThuocThucXuat,#donthuocchove_rowed3 #'+rowid+'_ThanhTien,#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung,#donthuocchove_rowed3 #'+rowid+'_PhuongThucThucHien').bind('keydown',function(e){
		if ((jwerty.is('enter',e))||(jwerty.is('tab',e))){
			if($('#donthuocchove_rowed3 #'+rowid+'_ID_DuongDungThuoc').is(":focus")){
				setTimeout(function(){
						$('#donthuocchove_rowed3 #'+rowid+'_SoThuocThucXuat').focus();
						$('#donthuocchove_rowed3 #'+rowid+'_SoThuocThucXuat').select();
				},50);			
			}
			if($('#donthuocchove_rowed3 #'+rowid+'_SoThuocThucXuat').is(":focus")){
					var slx=$('#donthuocchove_rowed3 #'+rowid+'_SoThuocThucXuat').val().split(',');
					if(slx[0]>0){
						setTimeout(function(){
							$('#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung').focus();
							$('#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung').select();
						},500);	
					}else{
						setTimeout(function(){
							$( "#dialog-soluongxuat" ).dialog('open');
						},50);
					}
			}
			if($('#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung').is(":focus")){
				setTimeout(function(){
					$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=todieutri_getcachdung&id_thuoc='+$('#donthuocchove_rowed3 #'+rowid+'_ID_ThuocChoVe').val()+'&soluong='+$('#donthuocchove_rowed3 #'+rowid+'_SoThuocThucXuat').val()+'&phientoa='+$('#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung').val()).done(function(data){
						//alert(data);
						$('#donthuocchove_rowed3 #'+rowid+'_CachDungChiTiet').val(data);
					});
					$('#donthuocchove_rowed3 #'+rowid+'_CachDungChiTiet').focus();
					$('#donthuocchove_rowed3 #'+rowid+'_CachDungChiTiet').select();
					if($('#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung').val()==''){
						$('#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung').val(0);
					}
				},200);			
			}
			if($('#donthuocchove_rowed3 #'+rowid+'_CachDungChiTiet').is(":focus")){
				setTimeout(function(){	
					$('#donthuocchove_rowed3_iladd').removeClass('ui-state-disabled')	 ;					
				   $("#prowed6 .ui-icon-plus").click();
				},200);		
			}
		}
		if(jwerty.is("shift+tab",e)){
			//alert();
			if($('#donthuocchove_rowed3 #'+rowid+'_PhuongThucThucHien').is(":focus")){
				setTimeout(function(){
						$('#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung').focus()
				},50);			
			}
			if($('#donthuocchove_rowed3 #'+rowid+'_CachDungLieuDung').is(":focus")){
				setTimeout(function(){
					//alert();
						$('#donthuocchove_rowed3 #'+rowid+'_SoThuocThucXuat').focus()
				},50);			
			}
			if($('#donthuocchove_rowed3 #'+rowid+'_SoThuocThucXuat').is(":focus")){
				setTimeout(function(){
						$('#donthuocchove_rowed3 #'+rowid+'_ID_DuongDungThuoc').focus()
				},50);			
			}
			if($('#donthuocchove_rowed3 #'+rowid+'_ID_DuongDungThuoc').is(":focus")){
				setTimeout(function(){
						$('#donthuocchove_rowed3 #'+rowid+'_ID_Thuoc_combobox').focus()
				},50);			
			}
		}//if shift tab
	})
}
function check_soluong_donthuochove(value,colName,id_row){
	//alert(window.iddonthuoc);
	if(window.iddonthuoc=='' || window.iddonthuoc=='undefined'){
		var _report_data=$.ajax({url: 'resource.php?module=<?=$modules?>&view=<?=$view?>&action=controller_donthuoc_soluong&soluong='+value+'&id_thuoc='+$('#'+id_row+'_ID_ThuocChoVe').val(), async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;
			_report_data=_report_data.split(';;');	
			if(_report_data[1]==0){		
				window.tonkhokhongdu=1;
					return [false,'Tồn kho hiện tại còn '+_report_data[0]+', không đủ để kê đơn','ID_ThuocChoVe_combobox']
			}else{
				window.tonkhokhongdu=0;
				return[true,'']
			}
	}else{
		var _checkdonthuoc=$.ajax({url: 'resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_donthuoc&id_donthuoc='+window.iddonthuoc, async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;
		//alert(_checkdonthuoc);
			if(_checkdonthuoc=="true"){
			var _report_data=$.ajax({url: 'resource.php?module=<?=$modules?>&view=<?=$view?>&action=controller_donthuoc_soluong&soluong='+value+'&id_thuoc='+$('#'+id_row+'_ID_ThuocChoVe').val(), async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;
			_report_data=_report_data.split(';;');	
			if(_report_data[1]==0){		
				window.tonkhokhongdu=1;
					return [false,'Tồn kho hiện tại còn '+_report_data[0]+', không đủ để kê đơn','ID_ThuocChoVe_combobox']
			}else{
				window.tonkhokhongdu=0;
				return[true,'']
			}
		}else{
			$("#donthuocchove_rowed3_ilcancel").click();
			return [false,'Đơn thuốc đã xuất hoặc đã thanh toán','ID_ThuocChoVe_combobox']
		}
	}
}

function dodulieu(id){
	$("#rowed5").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_loaikham_by_todieutrichitiet&idtodieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
	
	$("#dtph_rowed5").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_lamsang_dieutriphoihop_by_todieutrichitiet&idtodieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
	
	$("#donthuoc_rowed3").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_donthuocbyid_luotkham&id_todieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
	
	$("#vattutieuhao_rowed3").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_vattuyte_byid_todieutrichitiet&id_todieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
	
	$("#donthuocchove_rowed3").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_donthuocchove_byid_todieutrichitiet&id_todieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
	
	$("#tralaithuoc_rowed3").jqGrid('setGridParam',{datatype: 'json',url:"resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_ylenh_donthuoctralaibyid_donthuocchitiet&idtodieutrichitiet="+window.idtodieutrichitiet}).trigger('reloadGrid');
	
	$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_ylenh_todieutrichitiet&id_todieutrichitiet='+window.idtodieutrichitiet).done(function(data){
		var rsdata=data.split("|||");
		window.idtodieutrichitiet=rsdata[0];
		if(rsdata[3]!=0){
			setval_new('#combo_chamsoc',rsdata[3]); 
		}
		$("#ylenhkhac").val(rsdata[4]);
		if(rsdata[5]!=0){
			setval_new('#combo_lydotodieutri',rsdata[5]); 
		}
		if(rsdata[6]==1){
			$("#apdung").prop("checked",true);
			$("#apdung").attr("disabled",true);
			create_combobox_enable("#combo_lydotodieutri");
		}else{
			$("#apdung").prop("checked",false);
			create_combobox_disable("#combo_lydotodieutri");
		}
		$("#dienbienbenh").val(rsdata[7]);
		$("#chove_dando").val(rsdata[8]);
		//$("#tonghopylenh").val("Cận lâm sàng: "+window.canlamsang+"\nĐiều trị phối hợp: "+window.dieutriphoihop+"\nĐơn thuốc: "+window.donthuoc+"\nĐơn thuốc trả lại: "+window.donthuoctralai+"\nY lệnh khác: "+$("#ylenhkhac").val()); 
	});	
	$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_ylenh_dichvu_chamsoc_by_idtodieutrichitiet&id_todieutrichitiet='+window.idtodieutrichitiet).done(function(data){
		if($.trim(data)!=''){
			//alert($.trim(data));
			setval_new('#combo_dv_chamsoc',$.trim(data)); 
		}
	});
	$.post('resource.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_ylenh_bacsy_by_idtodieutrichitiet&id_todieutrichitiet='+window.idtodieutrichitiet).done(function(data){
		if($.trim(data)!=''){
			//alert($.trim(data));
			setval_new('#bschophepthuchien',$.trim(data)); 
		}else{
			setval_new('#bschophepthuchien',<?=$_SESSION["user"]["id_user"]?>); 
			console.log(<?=$_SESSION["user"]["id_user"]?>);
		}
	});
}
// end tra lai thuoc


function create_toamau(elem,datalocal){	
		datalocal=jQuery.parseJSON(datalocal);	 
		 $(elem).jqGrid({
		datastr:datalocal,	
		datatype: "jsonstring" ,
		colNames:['Tên đơn thuốc','Tên nhóm bệnh', 'Tên người tạo'],
		colModel:[			
			{name:'TenBietDuoc',index:'TenBietDuoc'}, 
			{name:'TenNhomBenh',index:'TenNhomBenh'},					 
			{name:'TenNguoiTao',index:'TenNguoiTao'},	 	
			 	 
		],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scroll: false,		 
		modal:true,	 
		rowNum: 200,
		rowList:[],
		height:($(window).height() / 100 * parseFloat(40)).toFixed(0),
		width: (($(window).width() / 100 * parseFloat(58)).toFixed(0)),
		viewrecords: true,	
		ignoreCase:true,
		shrinkToFit:true,
		cmTemplate: {sortable:false},		
		sortorder: "desc",
		serializeRowData: function (postdata) { 	
		},
		onSelectRow: function(id){	
			if($(elem).data('clicked')){
				$('#thuocmau').setGridParam({datatype: 'json',url:'resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_thuocmau&id_donthuoc='+id}).trigger("reloadGrid");	
			}
		},
		ondblClickRow: function (id, rowIndex, columnIndex) {
 		},
		loadComplete: function(data) {		
		},	  
		
	});	
	 $(elem).jqGrid('navGrid',"#prowed_DM_thuoc",{add: false, edit: false, del: false, search: false,closeAfterEdit: true,clearAfterAdd :true,closeOnEscape : true });				 
	 $(elem).jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
	 $(elem).jqGrid('bindKeys', {} );
		
} 
function create_toamau2(elem,datalocal){	
		datalocal=jQuery.parseJSON(datalocal);	 
		 $(elem).jqGrid({
		datastr:datalocal,	
		datatype: "jsonstring" ,
		colNames:['Tên đơn thuốc','Tên nhóm bệnh', 'Tên người tạo'],
		colModel:[			
			{name:'TenBietDuoc',index:'TenBietDuoc'}, 
			{name:'TenNhomBenh',index:'TenNhomBenh'},					 
			{name:'TenNguoiTao',index:'TenNguoiTao'},	 	
			 	 
		],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scroll: false,		 
		modal:true,	 
		rowNum: 200,
		rowList:[],
		height:($(window).height() / 100 * parseFloat(40)).toFixed(0),
		width: (($(window).width() / 100 * parseFloat(58)).toFixed(0)),
		viewrecords: true,	
		ignoreCase:true,
		shrinkToFit:true,
		cmTemplate: {sortable:false},		
		sortorder: "desc",
		serializeRowData: function (postdata) { 	
		},
		onSelectRow: function(id){	
			if($(elem).data('clicked')){
				$('#thuocmau2').setGridParam({datatype: 'json',url:'resource.php?module=<?=$modules?>&view=<?=$view?>&action=data_thuocmau&id_donthuoc='+id}).trigger("reloadGrid");	
			}
		},
		ondblClickRow: function (id, rowIndex, columnIndex) {
 		},
		loadComplete: function(data) {		
		},	  
		
	});	
	 $(elem).jqGrid('navGrid',"#prowed_DM_thuoc",{add: false, edit: false, del: false, search: false,closeAfterEdit: true,clearAfterAdd :true,closeOnEscape : true });				 
	 $(elem).jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
	 $(elem).jqGrid('bindKeys', {} );
		
} 
function create_thuocmau(elem){	
		datalocal=[];
		 $(elem).jqGrid({
		data:datalocal,
		datatype: "local",	
		colNames:['Tên đơn thuốc', 'Tên người tạo','','','','','','','','',''],
		colModel:[			
			{name:'TenBietDuoc',index:'TenBietDuoc'}, 
			{name:'TenNhomThuoc',index:'TenNhomThuoc'},
			{name:'cachdung',index:'cachdung'},	 
			{name:'PhuongThucThucHien',index:'PhuongThucThucHien'},	
			{name:'ID_DuongDungThuoc',index:'ID_DuongDungThuoc'},	
			{name:'SoThuocDeNghiTheoDon',index:'SoThuocDeNghiTheoDon'},	
			{name:'TenGoc',index:'TenGoc'},	
			{name:'Active',index:'Active'},	
			{name:'ID_DonViTinh',index:'ID_DonViTinh'},	
			{name:'CachDungChiTiet',index:'CachDungChiTiet'},
			{name:'Giaban',index:'Giaban'},		
		],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scroll: false,		 
		modal:true,	 
		rowNum: 200,
		rowList:[],

		height:($(window).height() / 100 * parseFloat(40)).toFixed(0),
		width: (($(window).width() / 100 * parseFloat(58)).toFixed(0)),
		viewrecords: true,	
		ignoreCase:true,
		shrinkToFit:true,
		cmTemplate: {sortable:false},
		
		sortorder: "desc",
		serializeRowData: function (postdata) { 		 	
			
		},
		onSelectRow: function(id){	
							
		},
		ondblClickRow: function (id, rowIndex, columnIndex) {
				
 		},
		loadComplete: function(data) {	
			var tmp1= $(elem).jqGrid('getDataIDs'); 
			be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
			var	ids = $('#donthuoc_rowed3').jqGrid('getDataIDs');
			for(var i=0;i < tmp1.length;i++){ 
				var n_kiemtra=0;
				var rowData = $(elem).getRowData(tmp1[i]);
				if(rowData["Active"]==0){
					alert('Thuốc ' +rowData["TenGoc"]+' không còn sử dụng,vui lòng chọn thuốc khác');
				}else{
					for(var j=0;j < ids.length;j++){ 
						var rowData2 = $("#donthuoc_rowed3").getRowData(ids[j]);
						if(rowData2['ID_Thuoc']==tmp1[i]){
							n_kiemtra=1;
						}
					}
					if(n_kiemtra==1){
						//alert('Thuốc ' +rowData["TenGoc"]+' đã kê');
					}else{
						parameters =
							{	rowID:'n_'+i,
								initdata : {xoa:be,ID_Thuoc:tmp1[i],ID_DuongDungThuoc:rowData["ID_DuongDungThuoc"],SoThuocThucXuat:rowData["SoThuocDeNghiTheoDon"],CachDungLieuDung:rowData["cachdung"],idthuoc:tmp1[i],CachDungChiTiet:rowData["CachDungChiTiet"],Gia:rowData["Giaban"]},
								position :"first",
								useDefValues : false,
								useFormatter : true,
								addRowParams : {extraparam:{}}
							}
							$("#donthuoc_rowed3").jqGrid('addRow',parameters);
							$("#donthuoc_rowed3 #n_"+i).removeClass('jqgrid-new-row');
					}
					n_kiemtra=0;
				}
			}
		},	  
		
	});	
		
}

function create_thuocmau2(elem){	
		datalocal=[];
		 $(elem).jqGrid({
		data:datalocal,
		datatype: "local",	
		colNames:['Tên đơn thuốc', 'Tên người tạo','','','','','','','','',''],
		colModel:[			
			{name:'TenBietDuoc',index:'TenBietDuoc'}, 
			{name:'TenNhomThuoc',index:'TenNhomThuoc'},
			{name:'cachdung',index:'cachdung'},	 
			{name:'PhuongThucThucHien',index:'PhuongThucThucHien'},	
			{name:'ID_DuongDungThuoc',index:'ID_DuongDungThuoc'},	
			{name:'SoThuocDeNghiTheoDon',index:'SoThuocDeNghiTheoDon'},	
			{name:'TenGoc',index:'TenGoc'},	
			{name:'Active',index:'Active'},	
			{name:'ID_DonViTinh',index:'ID_DonViTinh'},	
			{name:'CachDungChiTiet',index:'CachDungChiTiet'},
			{name:'Giaban',index:'Giaban'},		
		],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scroll: false,		 
		modal:true,	 
		rowNum: 200,
		rowList:[],

		height:($(window).height() / 100 * parseFloat(40)).toFixed(0),
		width: (($(window).width() / 100 * parseFloat(58)).toFixed(0)),
		viewrecords: true,	
		ignoreCase:true,
		shrinkToFit:true,
		cmTemplate: {sortable:false},
		
		sortorder: "desc",
		serializeRowData: function (postdata) { 		 	
			
		},
		onSelectRow: function(id){	
							
		},
		ondblClickRow: function (id, rowIndex, columnIndex) {
				
 		},
		loadComplete: function(data) {	
			var tmp1= $(elem).jqGrid('getDataIDs'); 
			be='<span class="ui-state-error ui-state-hover  " style="border:0"><span class="ui-icon  ui-icon-closethick" style="float: left; margin-left:15px;"></span></span>';
			var	ids = $('#vattutieuhao_rowed3').jqGrid('getDataIDs');
			for(var i=0;i < tmp1.length;i++){ 
				var n_kiemtra=0;
				var rowData = $(elem).getRowData(tmp1[i]);
				if(rowData["Active"]==0){
					alert('Thuốc ' +rowData["TenGoc"]+' không còn sử dụng,vui lòng chọn thuốc khác');
				}else{
					for(var j=0;j < ids.length;j++){ 
						var rowData2 = $("#vattutieuhao_rowed3").getRowData(ids[j]);
						if(rowData2['ID_VatTuTieuHao']==tmp1[i]){
							n_kiemtra=1;
						}
					}
					if(n_kiemtra==1){
						//alert('Thuốc ' +rowData["TenGoc"]+' đã kê');
					}else{
						parameters =
							{	rowID:'n_'+i,
								initdata : {xoa:be,ID_VatTuTieuHao:tmp1[i],ID_DuongDungThuoc:rowData["ID_DuongDungThuoc"],SoThuocThucXuat:rowData["SoThuocDeNghiTheoDon"],idthuoc:tmp1[i],Gia:rowData["Giaban"]},
								position :"first",
								useDefValues : false,
								useFormatter : true,
								addRowParams : {extraparam:{}}
							}
							$("#vattutieuhao_rowed3").jqGrid('addRow',parameters);
							$("#vattutieuhao_rowed3 #n_"+i).removeClass('jqgrid-new-row');
					}
					n_kiemtra=0;
				}
			}
		},	  
		
	});	
		
} 
function callback_themdonthuocmau(){
	
}
function currency_convert (cellvalue, options, rowObject){
   return parseFloat(convert_comma_dot_cacl(cellvalue)).formatMoney(1, ',', '.');
} 
function reloadtab3(val){
	setTimeout(resize_control,1);
	window.n_tab=val;
	setTimeout(function(){
		if(window.n_tab==3 && window.load3==0){
			create_combobox_new('#toamau',create_toamau,'bw','','data_toathuocmau',0);
			$('#donthuoc_rowed3_iladd').click();
			window.load3=1;
		}
		if(window.n_tab==4 && window.load4==0){
			$('#tralaithuoc_rowed3_iladd').click();
			window.load4=1;
		}
		if(window.n_tab==5 && window.load5==0){
			create_combobox_new('#toamau2',create_toamau2,'bw','','data_toathuocmau',0);
			$('#vattutieuhao_rowed3_iladd').click();
			window.load5=1;
		}
		if(window.n_tab==6 && window.load6==0){
			$('#donthuocchove_rowed3_iladd').click();
			window.load6=1;
		}
		if(window.n_tab==3){
			//ids = $('#donthuoc_rowed3').jqGrid('getDataIDs');				 
			//$("#donthuoc_rowed3").jqGrid("setSelection",ids[0], true);
			var idtab3=$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow');
			$("#donthuoc_rowed3 #"+idtab3+"_ID_Thuoc_combobox").focus();
		}
		if(window.n_tab==4){
			//ids2 = $('#tralaithuoc_rowed3').jqGrid('getDataIDs');				 
			//$("#tralaithuoc_rowed3").jqGrid("setSelection",ids2[0], true);
			var idtab4=$("#tralaithuoc_rowed3").jqGrid('getGridParam', 'selrow');
			$("#tralaithuoc_rowed3 #"+idtab4+"_ID_Thuoc_combobox").focus();	
		}
		if(window.n_tab==5){
			//ids = $('#donthuoc_rowed3').jqGrid('getDataIDs');				 
			//$("#donthuoc_rowed3").jqGrid("setSelection",ids[0], true);
			var idtab5=$("#vattutieuhao_rowed3").jqGrid('getGridParam', 'selrow');
			$("#vattutieuhao_rowed3 #"+idtab5+"_ID_VatTuTieuHao_combobox").focus();
		}
		if(window.n_tab==6){
			//ids = $('#donthuoc_rowed3').jqGrid('getDataIDs');				 
			//$("#donthuoc_rowed3").jqGrid("setSelection",ids[0], true);
			var idtab5=$("#donthuocchove_rowed3").jqGrid('getGridParam', 'selrow');
			$("#donthuocchove_rowed3 #"+idtab5+"_ID_ThuocChoVe_combobox").focus();
		}
	},2);
}
	
function resize_control(){
	$("#rowed3 ").setGridWidth($(".left_col").width() - 11);
	$("#rowed3").setGridHeight($(".right_col").height() - 60);
	$("#rowed4").setGridWidth($(".center_col").width() - 11);
	$("#rowed4").setGridHeight($(".center_col").height() - 93);
	$("#rowed5").setGridWidth($(".right_col").width() - 15);
	$("#rowed5").setGridHeight($(".right_col").height()-95);
	
	$("#dtph_rowed3 ").setGridWidth($(".dtph_left_col").width() - 11);
	$("#dtph_rowed3").setGridHeight($(".dtph_right_col").height() - 60);
	$("#dtph_rowed4").setGridWidth($(".dtph_center_col").width() - 11);
	$("#dtph_rowed4").setGridHeight($(".dtph_center_col").height() - 84);
	$("#dtph_rowed5").setGridWidth($(".dtph_right_col").width() - 15);
	$("#dtph_rowed5").setGridHeight($(".dtph_right_col").height() - 95);
	
	$("#donthuoc_rowed3").setGridWidth($("#tabs-3").width() - 11);
	$("#donthuoc_rowed3").setGridHeight($("#tabs-3").height() - 125);
	
	$("#tralaithuoc_rowed3").setGridWidth($("#tabs-4").width() - 11);
	$("#tralaithuoc_rowed3").setGridHeight($("#tabs-4").height() - 125);
	
	$("#vattutieuhao_rowed3").setGridWidth($("#tabs-5").width() - 11);
	$("#vattutieuhao_rowed3").setGridHeight($("#tabs-5").height() - 125);
	$(".chove_trai").width($("#tabs-6").width() - 311);//chove_duoi
	$(".chove_phai").width($("#tabs-6").width() -$(".chove_trai").width()-30);
	$(".chove_duoi").height($("#tabs-6").height() - 85);
	$("#donthuocchove_rowed3").setGridWidth($("#tabs-6").width() - 311);
	$("#donthuocchove_rowed3").setGridHeight($("#tabs-6").height() - 125);
}

</script>